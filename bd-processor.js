(()=>{var e={2743:(e,t,a)=>{const s=a(4404),i=a(1191),r=a(4298),o=a(5622),n=a(7211),d=a(1058),c=a(2087),l=a(3129),p=a(3464),u=a(3708),h=a(4959),g=a(4032),f=a(6018),m=a(703),w=a(146),y=a(4841),k=a(571),v=a(6675),b=a(8123),x=a(6586),S=a(5057),O=S.sleep,I=S.httpGet;e.exports=async function(e){const t=e.wss,a=e.chiConfig,S=a.system.docker_path,P=a.system.dataFilePath,j=a.system.taskLogFolder,F=await p.findOne({"auths.base":9}),T=async function(e,t){let a=-1;t&&(a=t.dataFiles.indexOf(e.id));try{await e.unlinkFileAndRemove(P),a>=0&&t.dataFiles.splice(a,1),A.socketBroadcast(t.getListeners(),"dataChange",{type:"remove",target:"DataFile",data:e.getModel()})}catch(e){console.log("Deleting files has errors"),console.log(e)}},D=async function(t){await e.taskRunner.deleteTaskInQueue(t.id),await e.taskRunner.stopRunningTask(t.id)},$=async function(e){let t=!1,a=null;const s=e.outFiles;for(;!t;){a=await h.findOne({_id:e.project}).populate("owner managers runners viewers"),a||console.log("Can not find the project");let i=!0;for(;i&&(i=await D(e),i);)await O(3e3);let n=[];const d=a.results.indexOf(e.id);d>=0&&(n=a.results.splice(d,1));const c=a.dataFiles.length;a.dataFiles=a.dataFiles.filter((e=>{for(const t of s)if(e.toString()===t.toString())return!1;return!0}));const l=a.dataFiles.length,p=o.resolve(j,e.id);await r.pathExists(p)&&await r.remove(p);try{(n.length>0||l!==c)&&await a.save(),t=!0}catch(e){t=!1}await O(1e3)}for(let e=0;e<s.length;e++){const t=s[e].getModel();try{await s[e].unlinkFileAndRemove(P),A.socketBroadcast(a.getListeners(),"dataChange",{type:"remove",target:"DataFile",data:t})}catch(e){}}const i=e.getModel();try{await f.deleteOne({_id:e._id}),A.socketBroadcast(a.getListeners(),"dataChange",{type:"remove",target:"Result",data:i})}catch(e){}},A={setTaskRunner:function(t){e.taskRunner=t},getCode:function(e,t){const a=s[e]?e:"unknown";return t&&t.attached&&(t.attached=t.attached.stack?t.attached.stack:JSON.stringify(t.attached)),{code:a,name:t&&t.name?t.name:s[a].name,type:t&&t.type?t.type:s[a].type,details:t&&t.details?t.details:s[a].details,attached:t&&t.attached?t.attached:void 0}},errorHandler:function(e,t){return e.errors||(e.errors=[]),Array.isArray(t)?e.errors.push.apply(e.errors,t):t&&(console.log(t),"MongoError"===t.name?e.errors.push(A.getCode("s003",{attached:t.stack?t.stack:t})):e.errors.push(A.getCode("s002",{details:"Errors occur during this request. Please try again or report issues.",attached:t.stack?t.stack:t}))),e},getNumberOfConns:async function(){return t.clients.size},isAuthenticated:async function(e,t,a){let s=e.query.authToken,i=null;if(s){s=s.toString();const e=await p.findOne({authToken:s});if(e){const t=e.authTime;((new Date).getTime()-t.getTime())/864e5<=3&&(i=e)}}if(!i&&e.isAuthenticated())try{const s=e.session.passport.user.id;i=await A.getAuthAsync(s,t||"base",a||2)}catch(e){console.log(e)}return i},escapeText:function(e){let t=String(e);return t=t.replace(/\\/g,"\\\\").replace(/\'/g,"\\'").replace(/\"/g,'\\"').replace(/\|/g,"\\|").replace(/\;/g,"\\;").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/\ /g,"\\ "),"win32"===c.platform()?`"${t}"`:`'${t}'`},logMessages:async function(e,t,a){const s=[];for(const i of t){const t=new u({account:e,code:i.code,name:i.name,type:i.type,routePath:a,details:i.details,attached:i.attached});s.push(t.save())}const i=s.map((async e=>{const t=await e;return u.findOne({_id:t.id}).populate("account")}));if(F&&F.id)for(const e of i){const t=await e;A.socketBroadcast(F.id,"dataChange",{type:"insert",target:"system-error",data:t.getModel()})}},async getTaskByMap(e){let t=await m.findOne({_id:e.id,key:e.key}).populate("package");if(t)return t;if(t=await m.findOne({_id:e.id}).populate("package"),t)return t;const a=A.pkgNameFormatter(e.pkg+"-"+e.ver).split("-").slice(0,-1).join("-"),s=await w.find({$or:[{_id:e.pkgid},{name:{$regex:"^"+a}}]});if(0===s.length)return null;let i;const r=s.filter((t=>t.id===e.pkgid));if(1===r.length)i=r[0].id;else{const t=s.filter((t=>0===t.name.indexOf(e.pkg)));if(1===t.length)i=t[0].id;else if(t.length>1){const a=t.filter((t=>t.name.split("-").slice(-1)[0]===e.ver));i=1===a.length?a[0].id:x(t,[e=>e.name.split("-").slice(-1)[0]],"desc")[0].id}}return t=await m.findOne({key:e.key,package:i}).populate("package"),t||null},chiAsyncWrap:function(e){return e.length<=3?function(t,a,s){return e(t,a,s).catch((e=>{let a={errors:[]};if(a=A.errorHandler(a,e),a.errors.length>0){const e=t.isAuthenticated()?t.session.passport.user.id:null;A.logMessages(e,a.errors,t.originalUrl).catch(console.log)}return a})).then((e=>e?a.json(e):"")).catch(s)}:function(t,a,s,i){return e(t,a,s,i).catch((e=>{let t={errors:[]};if(t=A.errorHandler(t,e),t.errors.length>0){const e=a.isAuthenticated()?a.session.passport.user.id:null;A.logMessages(e,t.errors,a.originalUrl).catch(console.log)}return t})).then(s.json).catch(i)}},getAuthAsync:async function(e,t,a){let s;try{s=await p.findOne({_id:e})}catch(e){throw[A.getCode("s003",{attached:e})]}if(s){if(s.auths[t]<a)throw[A.getCode("a017")];return s}throw[A.getCode("a015")]},reCAPTCHA:function(e){const t={secret:a.reCaptcha.reCaptchaSecret,response:e},s=i.stringify(t),r={hostname:"www.google.com",port:443,path:"/recaptcha/api/siteverify",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":s.length}};return new Promise(((e,t)=>{const a=n.request(r,(a=>{let s="";a.on("data",(e=>{s+=e})),a.on("end",(function(){const a=JSON.parse(s);return a.success?e(a):t([A.getCode("a012")])}))}));a.write(s),a.end()}))},sendVerifyEmail:function(e,t){if(a.email&&a.email.smtpConfig){const s=a.serverConfig.site_domain+"/account/email-verify?authToken="+t,i=b.createTransport(a.email.smtpConfig),r={to:e,from:"chiyang@mail.cgu.edu.tw",subject:"Verify your email for Bio-Data Processor",html:`${a.email.verificationContent||""}<hr><p>This is a verfication email for Bio-Data Processor.<br>\n            If you did not register to Bio-Data Processor, please skip this email and DO NOT click the following link.<br><br>\n            </p><br> <b><a target=_blank href='${s}'>Verify this email</a></b><br><br>Sincerely,<br>Big-Data Processor<br>`};return new Promise(((e,t)=>i.sendMail(r,(a=>a?t([{code:"a021",attached:a}]):e()))))}return Promise.resolve()},userInList:function(e,t){for(let a=0;a<e.length;a++)if(e[a]===t||e[a]._id===t||e[a].id===t)return!0;return!1},makeResultStopped:async function(e){try{if(await y.errorRun(e.id),"workflow"===e.type){console.log("Starting to stop the workflow");const t=await f.find({parent:e.id}).populate("owner inFiles outFiles task");for(const e of t)await D(e)}await D(e),"workflow"===e.type&&(e.status=3),await e.save()}catch(e){console.log(e)}},makeResultDeleted:async function(t){try{if(t.status=4,await t.save(),await y.deleteRun(t.id),"workflow"===t.type){console.log(`Start deleting workflow (result: ${t.id})`),await e.taskRunner.deleteWorkflow(t.id);const a=await f.find({parent:t.id}).populate("owner inFiles outFiles task");for(const e of a)await D(e);await O(1e3);for(const e of a)console.log(`remove children => id: ${e.id}; status: ${e.status}.`),await $(e)}console.log(`removing result => id: ${t.id}; status: ${t.status}`),await $(t),console.log(`Result removed => id: ${t.id}.`)}catch(e){console.log(e)}},runProcessAsync:function(e,t,a){return new Promise(((s,i)=>{process.stderr.write(`[${(new Date).toString()}] ${a} starting.\n`),process.stderr.write(`[command] ${e} ${t.join(" ")}\n`);const r=l.spawn(e,t,{cwd:process.cwd(),stdio:"inherit",shell:!0});r.on("error",(e=>{process.stderr.write(`[${(new Date).toString()}] ${a} has errors.\n`),process.stderr.write(JSON.stringify(e)),i(a+" failed.")})),r.on("exit",(e=>(process.stderr.write(`[${(new Date).toString()}] ${a} finished.\n`),e?i(a+" failed."):s(a+" Finished.")))),r.on("SIGTERM",(()=>r.kill())),r.on("SIGINT",(()=>r.kill()))}))},getContainerIP:async function(e){return e?new Promise((t=>{let a="";const s=l.spawn(S,["inspect","--format='{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}'",e],{stdio:"pipe",shell:!0});s.on("error",(()=>t(null))),s.stdout.on("data",(e=>{a+=e.toString()})),s.on("exit",(e=>t(0===e?a.replace(/\'/g,"").replace(/\n/g,""):null))),s.on("SIGTERM",(()=>{s.kill(),t(null)})),s.on("SIGINT",(()=>{s.kill(),t(null)}))})):null},makeDataFileDeleted:async function(e,t){if("Folder"!==e.format)await T(e,t);else{const a=await g.find({parent:e.id});for(let e=0;e<a.length;e++)await T(a[e],t);await T(e,t)}return t.save()},getProjectByID:async function(e){return await h.findOne({_id:e}).populate("owner managers runners viewers package packages").populate({path:"dataFiles",populate:{path:"owner"}}).populate({path:"results",populate:{path:"owner"}}).populate({path:"packages",populate:{path:"owner"}})},socketBroadcast:function(e,a,s){return t&&t.broadcast&&t.broadcast(a,s,e)},pkgNameFormatter:function(e){let t="";if(e.indexOf("-")<0)t=k(e,{condense:!0}).slice(0,220)+"-nover";else{const a=e.split("-"),s=a.pop();t=k(a.join("-"),{condense:!0}).slice(0,220)+"-"+s.slice(0,7)}return t},playbookHandler:async function(e,t,a,s){if(a&&(a=k(a,{condense:!0})).length>32)throw"The Task Key is too long. Please use a shorter text.";const i=await r.pathExists(e);let n={tasks:{}};if(i||"create"!==t){if(!i&&"created"!==t)throw"Task index file not found";{const t=await r.readFile(e,"utf8");n=v.load(t)}}else await r.ensureFile(e);n.tasks||(n={tasks:{}});const d=n.tasks;if("read"===t){if(!n.tasks[a])throw`The task key, ${a}, is not existed in the task-index file ${e}`;let t="";try{return t=await r.readFile(o.resolve(o.dirname(e),n.tasks[a]),"utf8"),t}catch(e){t=""}return t}switch(t){case"create":if(d[a])throw`The task key, ${a}, is existed in the task index file: ${e}`;d[a]="./tasks/"+a+".yaml",await r.outputFile(o.resolve(e,"../tasks/",a+".yaml"),s);break;case"update":d[a]="./tasks/"+a+".yaml",await r.outputFile(o.resolve(e,"../tasks/",a+".yaml"),s);break;case"delete":let t="";t=d[a]?o.resolve(o.dirname(e),d[a]):o.resolve(e,"../tasks/"+a+".yaml"),await r.pathExists(t)&&await r.remove(t),delete d[a]}await r.outputFile(e,v.dump(n))},getProxyJobListByResultId:async function(e,t){const a=o.join(j,e,"progress-index.txt");return await r.pathExists(a)?new Promise((e=>{const s=[];let i=!0;const o=d.createInterface({input:r.createReadStream(a)});o.on("line",(e=>{if(i)return void(i=!1);const a=e.split("\t");a[15]&&"null"!==a[15]&&(t||"null"!==a[9]&&"null"===a[10]&&"null"===a[14])&&s.push({jobId:a[0],proxy:JSON.parse(a[15])})})),o.on("close",(()=>e(s)))})):[]},getFirstProxyJobId:async function(e){const t=o.join(j,e,"progress-index.txt");return await r.pathExists(t)?new Promise((e=>{const a=[];let s=!0;const i=d.createInterface({input:r.createReadStream(t)});i.on("line",(e=>{if(s)return void(s=!1);const t=e.split("\t");t[15]&&"null"!==t[15]&&"null"!==t[9]&&"null"===t[10]&&"null"===t[14]&&(a.push(t[0]),i.close())})),i.on("close",(()=>e(a[0]||null)))})):null},readTaskLogIndex:function(e,t,a){const s="stdout"===a?7:"stderr"===a?8:1;return new Promise((a=>{let i="";const o=r.createReadStream(e),n=d.createInterface({input:o});n.on("line",(e=>{const a=e.split("\t");a[0]===t&&(i=a[s],n.close())})),n.on("close",(()=>{o.close(),a(i)}))}))},getFirstTaskName:async function(e){if(!await r.pathExists(e))return null;let t=null;return new Promise((a=>{const s=r.createReadStream(e),i=d.createInterface({input:s});i.on("line",(e=>{const a=e.split("\t");"process"!==a[0]&&null===t&&"null"==a[10]&&(t=a[0],i.close())})),i.on("close",(()=>{s.close(),a(t)}))}))},viewNpmPkg:async function(e,t){const a=`https://registry.npmjs.com/${e}`;try{new URL(a)}catch(e){throw A.getCode("s004",{attached:e})}let s;try{s=await I(a)}catch(e){return{}}const i=JSON.parse(s),r=i["dist-tags"]&&i["dist-tags"].latest?i["dist-tags"].latest:null;let o=null;if(t?i.versions[t]&&(o=i.versions[t]):r&&i.versions[r]&&(o=i.versions[r]),!o)throw A.getCode("s004",{details:`Sorry, we cannot find the version, ${t}, of the package ${e}.`});delete o.dist;const n=o["big-data-processor"]||{},d="string"==typeof o.author?o.author:o.author?o.author.name:"",c=o.author&&o.author.email?o.author.email:null;return{versions:Object.keys(i.versions).reverse(),latest:r,pkgInfo:{name:o.name,version:o.version,description:n.description||o.description,author:n.author||d,email:n.email||c,link:`https://npmjs.com/package/${o.name}`},bdp:n.type?n:null}},exportPackageDB:async function(e){const t=e.path,a=o.resolve(t,"db"),s=o.resolve(t,"scripts");await r.ensureDir(s),await r.ensureDir(a);const i=await m.find({package:e.id}),n={package:{name:e.name,category:e.category,desc:e.desc,img:e.img,thumbnail:e.thumbnail,readme:e.readme,author:e.author,email:e.email,scope:e.scope,status:e.status,formatMapping:e.formatMapping,allowedFormats:e.allowedFormats,pages:e.pages},tasks:i.map((e=>{const t=e.toObject();return delete t.createdAt,delete t.updatedAt,t}))},d=o.resolve(a,"bdp-package.json");await r.writeJson(d,n)}};return A}},3464:(e,t,a)=>{const s=a(5619),i=a(3966),r=s.model("Account",i);e.exports=r},4032:(e,t,a)=>{var s=a(5619),i=a(9556),r=s.model("DataFile",i);e.exports=r},146:(e,t,a)=>{const s=a(5619),i=a(2172),r=s.model("Package",i);e.exports=r},4959:(e,t,a)=>{const s=a(5619),i=a(3433),r=s.model("Project",i);e.exports=r},4841:(e,t,a)=>{var s=a(5619),i=a(6289),r=s.model("ResultHistory",i);e.exports=r},6018:(e,t,a)=>{var s=a(5619),i=a(325),r=s.model("Result",i);e.exports=r},3708:(e,t,a)=>{const s=a(5619),i=a(3156),r=s.model("SystemError",i);e.exports=r},7537:(e,t,a)=>{const s=a(5619),i=a(8516),r=s.model("SystemInfo",i);e.exports=r},6092:(e,t,a)=>{var s=a(5619),i=a(7956),r=s.model("taskQueue",i);e.exports=r},703:(e,t,a)=>{const s=a(5619),i=a(7895),r=s.model("Task",i);e.exports=r},3966:(e,t,a)=>{const s=a(5619),i=s.Schema,r=a(6417),{v5:o}=a(1231),n="panelSelectionUser",d=new s.Schema({name:{type:String,default:""},email:{type:String,match:/[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+(?:[A-Z]{2}|com|org|net|edu|gov|mil|biz|info|mobi|name|aero|asia|jobs|museum)\b/},passwd:{type:String},isLoggedIn:{type:Boolean,default:!1},lastLoggedIn:{type:Date,default:Date.now()},auths:{base:{type:Number,default:0},bdp:{type:Number,default:0}},authToken:{type:String},authTime:{type:Date,default:Date.now()},providers:[{type:String,default:"local"}],providerIDs:{Google:{type:i.Types.Mixed},BaseSpace:{type:i.Types.Mixed}}},{timestamps:!0});d.methods.verifyPassword=function(e){return r.createHash("sha256",n).update(e).digest("base64")===this.passwd},d.methods.register=async function(){const e=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if("local"===this.providers[0]){if(!e.test(this.email))throw[{code:"a002",details:"The email format has errors"}];if("string"!=typeof this.passwd||this.passwd.length<8||this.passwd.length>64)throw[{code:"a003",details:"The password has errors"}]}if(await this.model("Account").findOne({email:this.email}))throw[{code:1,msg:"The email has been used."}];if("local"===this.providers[0]){const e=r.createHash("sha256",n),t=this.passwd;this.passwd=e.update(t).digest("base64")}return 0===await this.model("Account").count({})&&(this.auths.base=9,this.auths.bdp=9),await this.save(),this.getModel()},d.methods.getModel=function(){const e=this.email.match(/((...).+?)\@(.*)\.(.*)/);return Array.isArray(e),{id:this.id,name:this.name,email:this.email,lastLoggedIn:this.lastLoggedIn.getTime(),isLoggedIn:this.isLoggedIn,auths:this.auths,chiblogAuth:this.chiblogAuth,providers:this.providers,createdAt:this.createdAt,updatedAt:this.updatedAt,chiblogAuth:this.chiblogAuth}},d.methods.getSlimModel=function(){return{id:this.id,name:this.name,lastLoggedIn:this.lastLoggedIn}},d.methods.getSimpleModel=function(){return{id:this.id,email:this.email,name:this.name,lastLoggedIn:this.lastLoggedIn}},d.methods.setAuthToken=async function(){let e=0;for(;e<1e3;){this.authTime=Date.now();const t=o(this.email+this.id+this.authTime,o.URL);if(0===(await this.model("Account").find({authToken:t})).length)return this.authToken=t,await this.save();e++}return null},d.methods.verifyEmail=async function(e){const t=await this.model("Account").count({}),a=await this.model("Account").findOne({authToken:e});if(!a)throw[{code:"a004",details:"Invalid auth token."}];const s=new Date,i=a.authTime;if((s.getTime()-i.getTime())/864e5>7)throw[{code:"a005",name:"Expired auth token",details:"This token has been expired. We have generated a new token for you. Please sign in and go to user profile page to resend the new token."}];return this.auths.base=1===t?9:1,await this.save(),this.getModel()},d.methods.signIn=async function(){return this.set("isLoggedIn",!0),await this.save(),this.getModel()},d.methods.signOut=async function(){return this.set("isLoggedIn",!1),await this.save(),!0},e.exports=d},9218:(e,t,a)=>{const s=a(5619),i=s.Schema,r=s.Schema({name:String,desc:String,type:{type:String,enum:["static","value","list","inFile","outFile","inDir","outDir"]},format:String,tags:[String],tagMatchRule:{type:String,enum:["or","and","all"],default:"or"},option:{type:String,default:""},optional:{type:Boolean,default:!1},multiple:{type:Boolean,default:!1},default:[{type:i.Types.Mixed}],list:[String],dependOn:String,listType:String,listSplitter:{type:String,default:","},component:{type:String,default:"default"},preview:Boolean,hidden:{type:Boolean,default:!1},outFolderStyle:{type:String,enum:["name","path"],default:"path"},outPreFolder:{type:Boolean,default:!1}},{_id:!1});e.exports=r},9556:(e,t,a)=>{const s=a(5619),i=s.Schema,r=a(4298),o=a(4673),n=a(5622),d=new s.Schema({name:{type:String,default:""},desc:{type:String,default:""},format:{type:String,default:""},path:{type:String,default:""},realPath:{type:String,default:""},tags:[String],parent:{type:i.Types.ObjectId},project:{type:i.Types.ObjectId,ref:"Project"},owner:{type:i.Types.ObjectId,ref:"Account"},result:{type:i.Types.ObjectId,ref:"Result"},status:{type:Number,default:0},additionInfo:{type:i.Types.Mixed,default:{}},size:{type:Number,default:0},hidden:{type:Boolean,default:!1},readOnly:{type:Boolean,default:!1},prefix:{type:String,default:""},suffix:{type:String,default:""}},{timestamps:!0});d.methods.getName=function(){return this.name?this.name:this.id},d.methods.getModel=function(){return{id:this.id,name:this.name,desc:this.desc,format:this.format,tags:this.tags,project:this.project,result:this.result&&this.result.getModel?this.result.getModel():this.result,status:this.status,addition:this.addition,parent:this.parent,hidden:this.hidden,size:this.size,path:this.path,realPath:this.realPath,owner:this.owner&&this.owner.getSlimModel?this.owner.getSlimModel():this.owner,prefix:this.prefix,suffix:this.suffix,createdAt:this.createdAt,updatedAt:this.updatedAt}},d.methods.checkFile=async function(){let e=!1,t=4;if(await r.pathExists(this.path))try{e=await r.stat(this.path),t=1}catch(e){t=4}else t=4;return t!==this.status&&(this.status=t,await this.save()),e},d.methods.ensureFile=async function(e){let t=!1,a=4,s=!1;if(await r.pathExists(this.path))try{t=await r.stat(this.path),a=1}catch(e){a=4}else a=4;if(4===a){const i=this.project._id?this.project._id.toString():this.project,o=this._id.toString(),d="Folder"===this.format?n.resolve(e,i,o):n.resolve(e,i,`${o}.${this.format}`);if(await r.pathExists(d))try{t=await r.stat(d),a=1,this.path=d,s=!0}catch(e){a=4}}return(a!==this.status||s)&&await this.save(),t},d.methods.unlinkFileAndRemove=async function(e){this.status=3;const t=await this.save();if(e)if(o(n.resolve(t.path),n.resolve(e)))try{let a="";a="Folder"===this.format?n.resolve(e,"shared",this.id):n.resolve(e,"shared",this.id+"."+this.format),await r.pathExists(a)&&await r.remove(a),await r.remove(t.path)}catch(e){console.log(e)}else console.log("The Path: "+t.path+" is outside of "+e);await this.remove()},d.methods.move=async function(e){const t=this.path;this.status=2,await this.save(),await r.move(t,e)},d.methods.extractInfo=function(){this.tags.indexOf("subset")},d.index({project:1,owner:1}),e.exports=d},2172:(e,t,a)=>{const s=a(5619),i=s.Schema,r=s.Schema({ext:{type:String},tags:[{type:String}]},{_id:!1}),o=function(e,t){if(!t)return!1;for(let a=0;a<e.length;a++)if(e[a]==t||e[a]._id==t||e[a].id==t)return!0;return!1},n=function(e,t){return e.getSimpleModel||e.getSlimModel?t&&t.canSetMember?e.getSimpleModel():e.getSlimModel():e},d=new s.Schema({name:{type:String,required:!0,index:!0,unique:!0},desc:{type:String,default:""},author:{type:String,default:""},email:{type:String,default:""},category:{type:String,default:""},img:{type:String,default:""},thumbnail:{type:String,default:""},path:{type:String,required:!0},fromPath:{type:String,required:!1},scope:[{type:String}],status:{type:Number,default:0},allowedFormats:[{type:String,default:""}],formatMapping:[r],backups:[{type:String}],setupSteps:{type:Number,default:0},stdOut:{type:String},stdErr:{type:String},error:{type:i.Types.Mixed},link:{type:String,default:""},sheetID:{type:String,default:""},sheetName:{type:String,default:""},pages:{indexPages:[{name:{type:String,default:""},desc:{type:String,default:""},path:{type:String,default:""},thumbnail:{type:String,default:""},key:{type:String,default:""},img:{type:String,default:""}}],resultPages:[{name:{type:String,default:""},desc:{type:String,default:""},path:{type:String,default:""},tasks:[{type:String}],thumbnail:{type:String,default:""},key:{type:String,default:""},img:{type:String,default:""}}],filePages:[{name:{type:String,default:""},desc:{type:String,default:""},path:{type:String,default:""},tags:[{type:String}],rules:{type:String,default:"or"},format:{type:String,default:""},thumbnail:{type:String,default:""},key:{type:String,default:""},img:{type:String,default:""}}]},owner:{type:i.Types.ObjectId,ref:"Account"},managers:[{type:i.Types.ObjectId,ref:"Account"}],viewers:[{type:i.Types.ObjectId,ref:"Account"}],runners:[{type:i.Types.ObjectId,ref:"Account"}],public:{type:Boolean,default:!1},open:{type:Boolean,default:!1}},{timestamps:!0});d.methods.setPages=function(e){const t={indexPages:[],resultPages:[],filePages:[]};e&&(Array.isArray(e.indexPages)&&(t.indexPages=e.indexPages.map((e=>({name:e.name||"",desc:e.desc||"",path:e.path||"/assets/pages/index.html",thumbnail:e.thumbnail,key:e.key||"",img:e.img})))),Array.isArray(e.resultPages)&&(t.resultPages=e.resultPages.map((e=>({name:e.name||"",desc:e.desc||"",path:e.path||"/assets/pages/index.html",thumbnail:e.thumbnail,key:e.key||"",img:e.img,tasks:Array.isArray(e.tasks)?e.tasks:[]})))),Array.isArray(e.filePages)&&(t.filePages=e.filePages.map((e=>({name:e.name||"",desc:e.desc||"",path:e.path||"/assets/pages/index.html",thumbnail:e.thumbnail,key:e.key||"",img:e.img,tags:Array.isArray(e.tags)?e.tags.map((e=>e.replace(/[^a-z0-9\-\_]/g,""))):[],rules:-1===["and","or","all"].indexOf(e.rules)?"or":e.rules,format:e.format||""}))))),this.pages=t},d.methods.getModel=function(e){const t={id:this.id,name:this.name.split("-").slice(0,-1).join("-"),desc:this.desc,author:this.author,email:this.email,img:this.img,thumbnail:this.thumbnail,status:this.status,scope:this.scope,allowedFormats:this.allowedFormats,formatMapping:this.formatMapping,pages:this.pages,version:this.name.split("-").slice(-1)[0],createdAt:this.createdAt,updatedAt:this.updatedAt,link:this.link,setupSteps:this.setupSteps,privilege:e||this.privilege||{},sheetID:this.sheetID,sheetName:this.sheetName,owner:{},viewers:this.viewers.map(n,e),managers:this.managers.map(n,e),runners:this.runners.map(n,e),public:this.public};return this.owner&&(this.owner.getSimpleModel||this.owner.getSlimModel?t.owner=e&&e.setMember?this.owner.getSimpleModel():this.owner.getSlimModel():t.owner=this.owner),t},d.methods.getDetailModel=function(e){const t={id:this.id,name:this.name.split("-").slice(0,-1).join("-"),desc:this.desc,author:this.author,email:this.email,status:this.status,img:this.img,thumbnail:this.thumbnail,scope:this.scope,allowedFormats:this.allowedFormats,formatMapping:this.formatMapping,pages:this.pages,version:this.name.split("-").slice(-1)[0],backups:this.backups,createdAt:this.createdAt,updatedAt:this.updatedAt,setupSteps:this.setupSteps,stdOut:this.stdOut,stdErr:this.stdErr,error:this.error,link:this.link,sheetID:this.sheetID,sheetName:this.sheetName,privilege:e||{},owner:{},viewers:this.viewers.map(n,e),managers:this.managers.map(n,e),runners:this.runners.map(n,e),public:this.public};return this.owner&&(this.owner.getSimpleModel||this.owner.getSlimModel?t.owner=e&&e.setMember?this.owner.getSimpleModel():this.owner.getSlimModel():t.owner=this.owner),t},d.methods.getListeners=function(e){let t=[];return this.public||(this.owner&&this.owner._id?t.push(this.owner._id.toString()):this.owner&&t.push(this.owner),t.push.apply(t,this.managers.map((e=>e._id?e._id:e))),t.push.apply(t,this.runners.map((e=>e._id?e._id:e))),t.push.apply(t,this.viewers.map((e=>e._id?e._id:e)))),e&&Array.isArray(e)&&t.push.apply(t,e),t=t.map((e=>e.toString())),t.length>=1?t:[]},d.methods.getPrivilege=function(e){e&&e.auths||(e={id:"",auths:{bdp:0}});const t=e.auths.bdp,a=!(!this.owner||this.owner.toString()!==e.id&&this.owner.id!==e.id),s=o(this.managers,e.id),i=o(this.viewers,e.id),r=o(this.runners,e.id),n={canView:!1,canRun:!(this.runners&&this.runners.length>0),canEdit:!1,canDelete:!1,canSetMember:!1,isOwner:a,isManager:s,isRunner:r,isViewer:i};return 9===t?Object.assign(n,{canView:!0,canRun:!0,canEdit:!0,canDelete:!0,canSetMember:!0}):(n.canView=t>=7&&(a||s||i||this.public),n.canRun=t>=2&&(a||s||r||this.public),n.canEdit=t>=7&&(a||s),n.canDelete=t>=8&&a,n.canSetMember=t>=8&&(a||s),n)},e.exports=d},3433:(e,t,a)=>{const s=a(5619),i=s.Schema,r=function(e,t){if(!t)return!1;for(let a=0;a<e.length;a++)if(e[a]==t||e[a]._id==t||e[a].id==t)return!0;return!1},o=new s.Schema({name:{type:String,default:""},owner:{type:i.Types.ObjectId,ref:"Account"},desc:{type:String,default:""},dataFiles:[{type:i.Types.ObjectId,ref:"DataFile"}],results:[{type:i.Types.ObjectId,ref:"Result"}],type:[{type:i.Types.String,default:""}],package:{type:i.Types.ObjectId,ref:"Package"},packages:[{type:i.Types.ObjectId,ref:"Package"}],managers:[{type:i.Types.ObjectId,ref:"Account"}],runners:[{type:i.Types.ObjectId,ref:"Account"}],viewers:[{type:i.Types.ObjectId,ref:"Account"}],public:{type:Boolean,default:!1},open:{type:Boolean,default:!1}},{timestamps:!0});o.methods.getModel=function(e){const t=function(t){return t.getSimpleModel||t.getSlimModel?e&&e.canSetMember?t.getSimpleModel():t.getSlimModel():t},a={id:this.id,name:this.name,desc:this.desc,type:this.type,packages:this.packages.map((e=>e&&e.getModel?e.getModel():e)),dataFiles:this.dataFiles.map((e=>e&&e.getModel?e.getModel():e)),results:this.results.map((e=>e&&e.getModel?e.getModel():e)),owner:{},viewers:this.viewers.map(t),managers:this.managers.map(t),runners:this.runners.map(t),public:!!this.public,privilege:e||{},createdAt:this.createdAt,updatedAt:this.updatedAt};return this.owner&&(this.owner.getSimpleModel||this.owner.getSlimModel?a.owner=e&&e.setMember?this.owner.getSimpleModel():this.owner.getSlimModel():a.owner=this.owner),a},o.methods.getListeners=function(e){let t=[];return this.public||(this.owner&&this.owner._id?t.push(this.owner._id.toString()):this.owner&&t.push(this.owner),t.push.apply(t,this.managers.map((e=>e._id?e._id:e))),t.push.apply(t,this.runners.map((e=>e._id?e._id:e))),t.push.apply(t,this.viewers.map((e=>e._id?e._id:e))),t=t.map((e=>e.toString()))),e&&Array.isArray(e)&&t.push.apply(t,e),t.length>=1?t:[]},o.methods.formatChecked=function(e){return this.rawData=e,this.formatCheck=1,this.save(),this},o.methods.getPrivilege=function(e){const t=e.auths.bdp,a=!(!this.owner||this.owner.toString()!==e.id&&this.owner.id!==e.id),s=r(this.managers,e.id),i=r(this.runners,e.id),o=r(this.viewers,e.id),n={canView:!1,canRun:!1,canEdit:!1,canDelete:!1,canDeleteResult:!1,canEditResult:!1,canDeleteFile:!1,canAddFile:!1,canEditFile:!1,canSetMember:!1,isOwner:a,isManager:s,isRunner:i,isViewer:o};return 9===t?Object.assign(n,{canView:!0,canRun:!0,canEdit:!0,canDelete:!0,canDeleteResult:!0,canEditResult:!0,canDeleteFile:!0,canAddFile:!0,canEditFile:!0,canSetMember:!0}):(n.canView=t>=2&&(a||s||i||o||this.public),n.canRun=t>=2&&(a||s||i),n.canEdit=t>=2&&(a||s),n.canDelete=t>=2&&a,n.canEditResult=t>=2&&(a||s||i),n.canDeleteResult=t>=2&&(a||s||i),n.canDeleteFile=t>=2&&(a||s||i),n.canAddFile=t>=2&&(a||s||i),n.canEditFile=t>=2&&(a||s||i),n.canSetMember=t>=2&&(a||s),n)},e.exports=o},6289:(e,t,a)=>{const s=a(5619),i=s.Schema,r=new s.Schema({result:{type:i.Types.ObjectId,ref:"Result"},user:{type:i.Types.ObjectId,ref:"Account"},project:{type:i.Types.ObjectId,ref:"Project"},projectName:{type:String,default:""},projectDesc:{type:String,default:""},taskName:{type:String,default:""},title:{type:String,default:""},desc:{type:String,default:""},prefix:{type:String,default:""},suffix:{type:String,default:""},status:{type:Number,default:0},timer:[{type:Date}]},{timestamps:!0});r.methods.getModel=function(){return{id:this.id,title:this.title,prefix:this.prefix,suffix:this.suffix,desc:this.desc,status:this.status,timer:this.timer,taskName:this.taskName,projectName:this.projectName,projectDesc:this.projectDesc,project:this.project,result:this.result,user:this.user.getModel()}},r.statics.startRun=async function(e){const t=await this.find({result:e}).sort({createdAt:-1});return t.length>0&&(t[0].status=1,t[0].timer=[t[0].timer[0],new Date],t[0].markModified("timer"),await t[0].save())},r.statics.finishRun=async function(e){const t=await this.find({result:e}).sort({createdAt:-1});return t.length>0&&(t[0].status=2,t[0].timer=[t[0].timer[0],t[0].timer[1],new Date],t[0].markModified("timer"),await t[0].save())},r.statics.errorRun=async function(e){const t=await this.find({result:e}).sort({createdAt:-1});return t.length>0&&(t[0].status=3,t[0].timer=[t[0].timer[0],t[0].timer[1],new Date],t[0].markModified("timer"),await t[0].save())},r.statics.deleteRun=async function(e){const t=await this.find({result:e}).sort({createdAt:-1});return t.length>0&&(t[0].status=4,t[0].timer=[t[0].timer[0],t[0].timer[1],t[0].timer[2],new Date],t[0].markModified("timer"),await t[0].save())},e.exports=r},325:(e,t,a)=>{const s=a(5619),i=s.Schema,r=a(7895),o=new s.Schema({name:{type:String,required:!0},type:{type:String},desc:{type:String,default:""},owner:{type:i.Types.ObjectId,ref:"Account"},project:{type:i.Types.ObjectId,ref:"Project"},script:{type:String,default:""},children:[{type:i.Types.Mixed}],task:{type:i.Types.ObjectId,ref:"Task"},taskSnapshot:r,parent:{type:i.Types.ObjectId,ref:"Result"},arguments:[{type:i.Types.Mixed}],cwd:{type:String},command:{type:String,default:""},commandArgs:[{type:String}],outFiles:[{type:i.Types.ObjectId,ref:"DataFile"}],inFiles:[{type:i.Types.ObjectId,ref:"DataFile"}],status:{type:Number,default:-1},stdErr:{type:String,default:""},stdOut:{type:String,default:""},error:{type:i.Types.Mixed},readOnly:{type:Boolean,default:!1},timer:[{type:Date}],pid:{type:Number},workflowProgress:[],prefix:{type:String,default:""},suffix:{type:String,default:""},env:{type:i.Types.Mixed},extDirs:[{type:String}]},{timestamps:!0});o.methods.getModel=function(){return{id:this.id,name:this.name,type:this.type,desc:this.desc,owner:this.owner&&this.owner.getSlimModel?this.owner.getSlimModel():this.owner,project:this.project,task:this.task&&this.task.getModel?this.task.getModel():this.task,taskSnapshot:this.taskSnapshot&&this.taskSnapshot.getModel?this.taskSnapshot.getModel():this.taskSnapshot,parent:this.parent,children:this.children,arguments:this.arguments,commandArgs:this.commandArgs,cwd:this.cwd,command:this.command,inFiles:this.inFiles.map((e=>e&&e.getModel?e.getModel():e)),outFiles:this.outFiles.map((e=>e&&e.getModel?e.getModel():e)),status:this.status,stdErr:this.stdErr,stdOut:this.stdOut,error:this.error,timer:this.timer,readOnly:this.readOnly,pid:this.pid,workflowProgress:[],createdAt:this.createdAt,updatedAt:this.updatedAt,prefix:this.prefix||"",suffix:this.suffix||""}},o.index({project:1,owner:1}),e.exports=o},3156:(e,t,a)=>{const s=a(5619),i=s.Schema,r=new s.Schema({account:{type:i.Types.ObjectId,ref:"Account"},code:String,type:String,name:String,details:String,routePath:String,attached:i.Types.Mixed},{timestamps:!0});r.methods.getModel=function(){return{id:this._id,account:this.account?this.account.getSimpleModel():null,code:this.code,type:this.type,name:this.name,details:this.details,attached:this.attached,routePath:this.routePath,createdAt:this.createdAt}},e.exports=r},8516:(e,t,a)=>{const s=new(0,a(5619).Schema)({name:{type:String,unique:!0},modules:[{name:String,pkgName:String,moduleType:String,author:String,email:String,desc:String,version:String,status:Number,stdout:String,stderr:String}]},{timestamps:!0});s.methods.getModel=function(){return{modules:this.modules.map((e=>({name:e.name,pkgName:e.pkgName,moduleType:e.moduleType,author:e.author,email:e.email,desc:e.desc,version:e.version,status:e.status,stdout:e.stdout,stderr:e.stderr})))}},e.exports=s},7956:(e,t,a)=>{const s=a(5619),i=s.Schema,r=new s.Schema({taskQueue:[],processing:{type:i.Types.Mixed,default:{}},workflowProcess:{type:i.Types.Mixed,default:{}}});e.exports=r},7895:(e,t,a)=>{const s=a(5619),i=s.Schema,r=a(9218),o=(a(2087),new s.Schema({name:{type:String,default:""},key:{type:String,default:""},desc:{type:String,default:""},package:{type:i.Types.ObjectId,ref:"Package"},img:{type:String,default:""},thumbnail:{type:String,default:""},script:{type:String},exec:{type:String},cwd:{type:String},type:{type:String},arguments:[r],tags:[{type:String}],mapper:[{type:i.Types.Mixed}],stepNames:[{type:String}],encodeArg:{type:Boolean},proxy:{enabled:{type:Boolean,default:!1},protocol:{type:String,default:"http"},pathRewrite:Boolean,port:Number,ip:String,entryPath:{type:String,default:"/"}}},{timestamps:!0})),n=function(e,t){return t?Buffer.from(String(e),"utf8").toString("base64"):String(e).replace(/\\/g,"\\\\").replace(/\'/g,"\\'").replace(/\"/g,'\\"').replace(/\|/g,"\\|").replace(/\;/g,"\\;").replace(/\(/g,"\\(").replace(/\)/g,"\\)")};o.methods.getScriptPath=function(e,t,a){return this.script?this.script.match(/^\$PackageFolder/)&&e?this.script.replace(/^\$PackageFolder/,e):this.script.match(/^\$ScriptFolder/)?this.script.replace(/^\$ScriptFolder/,a):this.script.match(/^\$ProjectFolder/)&&t?this.script.replace(/^\$ProjectFolder/,t):this.script.match(/^\$SystemFolder/)?this.script.replace(/^\$SystemFolder/,process.env.BDP_SYSTEM_FOLDER):this.script:""},o.methods.compose=function(e,t,a,s){const i=this.arguments;let r=[];const o=[],d=this.encodeArg;"workflow"!==this.type&&(r=[this.exec,'"'+this.getScriptPath(t,a,s)+'"']);for(let t=0;t<i.length;t++){const a=i[t],s=a.type;if(a.hidden)continue;const r=a.listSplitter?a.listSplitter:",";if(a.option&&o.push(n(String(a.option),d)),"value"===s){if(a.optional&&(null===e[t][s]||void 0===e[t][s])){a.option&&o.pop();continue}o.push(n(String(e[t][s]),d))}else if("static"===s)o.push(n(String(e[t][s]),d));else if("list"===s){if(a.optional&&(null===e[t][s]||void 0===e[t][s]||0===e[t][s].length)){a.option&&o.pop();continue}Array.isArray(e[t][s])?o.push(n(e[t][s].join(r),d)):o.push(n(e[t][s].toString()),d)}else{if(a.optional&&(null===e[t][s]||void 0===e[t][s]||""===e[t][s])){a.option&&o.pop();continue}o.push(n(e[t][s],d))}}return{command:r.join(" "),commandArgs:o}},o.methods.outputProvider=function(){const e=[];for(let t=0;t<this.arguments.length;t++){const a=this.arguments[t];"outFile"==a.type&&(a.dependOn&&a.default?e.push({format:a.format,tags:a.tags,index:t,name:a.name,dependOn:a.dependOn,default:a.default[0],outPreFolder:a.outPreFolder,outFolderStyle:a.outFolderStyle}):e.push({format:a.format,tags:a.tags,index:t,name:a.name,outPreFolder:a.outPreFolder,dependOn:null,default:"",outFolderStyle:a.outFolderStyle}))}return e},o.methods.getModel=function(e){return{id:this.id,name:this.name,desc:this.desc,key:this.key,package:this.package,script:this.script,img:this.img,thumbnail:this.thumbnail,exec:this.exec,cwd:this.cwd,type:this.type,arguments:this.arguments,mapper:this.mapper,stepNames:Array.isArray(this.stepNames)?this.stepNames:[],version:this.version,encodeArg:!!this.encodeArg,workflowPlaybook:e||"",proxy:this.proxy&&this.proxy.enabled?{protocol:this.proxy.protocol,pathRewrite:!!this.proxy.pathRewrite,port:this.proxy.port,ip:this.proxy.ip,entryPath:this.proxy.entryPath||"/"}:null}},o.methods.getModelForViewer=function(){return{id:this.id,name:this.name,desc:this.desc,key:this.key,package:this.package&&this.package.getModel?this.package.getModel():this.package,img:this.img,thumbnail:this.thumbnail,type:this.type,arguments:this.arguments,mapper:this.mapper,stepNames:Array.isArray(this.stepNames)?this.stepNames:[],version:this.version,encodeArg:!!this.encodeArg,proxy:this.proxy&&this.proxy.enabled?{protocol:this.proxy.protocol,pathRewrite:!!this.proxy.pathRewrite,port:this.proxy.port,ip:this.proxy.ip,entryPath:this.proxy.entryPath||"/"}:null}},e.exports=o},4647:e=>{e.exports=class{#addressToProxy;#resultToProxy;constructor(){this.#addressToProxy=new Map,this.#resultToProxy=new Map,this.keyPrefix="bdp:proxy"}#saveProxy(e,t,a){this.#addressToProxy.set(e,a),this.#resultToProxy.set(t,a),console.log(`Proxy object saved for ${e} and ${t}`)}async getProxyObj(e,t){return this.#resultToProxy.get(`${e}:${t}`)}async register(e,t,a,s,i,r,o){const n=`${e}:${t}`,d=`${a}:${s}`,c=this.#addressToProxy.get(n),l=this.#resultToProxy.get(d),p={ip:e,port:t,resultId:a,jobId:s,pathRewrite:"true"===i.toString(),protocol:r,entryPath:o};if(c||l)if(c&&!l){if(c.resultId!==a||c.jobId!==s)throw`This proxy settings (${JSON.stringify(p)}) for the resultId: ${a} and the jobId: ${s} have been used.`;this.#saveProxy(n,d,p)}else if(!c&&l){const e=`${l.ip}:${l.port}`,t=this.#addressToProxy.get(e);t.resultId===a&&t.jobId===s&&this.#addressToProxy.delete(e),this.#saveProxy(n,d,p)}else this.#saveProxy(n,d,p);else this.#saveProxy(n,d,p)}async unregisterByResultId(e){const t=`${e}:`;this.#resultToProxy.forEach(((a,s)=>{if(0===s.indexOf(t)){const t=`${a.ip}:${a.port}`,i=this.#addressToProxy.get(t);i&&i.resultId===e&&this.#addressToProxy.delete(t),this.#resultToProxy.delete(s)}})),console.log(`Proxy objects deleted for the resultId: ${e}`)}async unregister(e,t){const a=`${e}:${t}`,s=this.#resultToProxy.get(a);if(!s)return;this.#resultToProxy.delete(a);const i=`${s.ip}:${s.port}`,r=this.#addressToProxy.get(i);r&&r.resultId===e&&r.jobId===t&&this.#addressToProxy.delete(i),console.log(`Proxy objects deleted for the resultId: ${e} and the jobId: ${t}`)}}},3259:(e,t,a)=>{const s=a(2127),i=a(8922),r=a(479),o=a(6).Strategy,n=a(6888).Strategy;e.exports=function(e){const t=e.chiConfig,d=e.helpers,c=d.chiAsyncWrap,l=d.sendVerifyEmail,p=d.reCAPTCHA,u=d.getCode,h=d.getAuthAsync,g=d.socketBroadcast,f=s.Router(),m=a(3464);i.serializeUser((function(e,t){t(null,{id:e.id,auth:e.auths.base})})),i.deserializeUser((function(e,t){m.findById(e.id,(function(e,a){t(e,a)}))})),i.use("local",new n({usernameField:"email",passwordField:"passwd"},(function(e,t,a){m.findOne({email:e},(function(e,s){return e?a(e):s&&s.verifyPassword(t)?a(null,s):a(null,!1)}))})));const w=function(e,t){return new Promise(((a,s)=>{e.login(t,(e=>e?s([u("a009",{details:"Failed to login. Please try again.",attached:e})]):a()))}))};if(t.GoogleAuth&&t.GoogleAuth.clientID&&t.GoogleAuth.clientSecret){let e="";e=0===t.serverConfig.site_domain.indexOf("http://")&&80===t.serverConfig.port||0===t.serverConfig.site_domain.indexOf("https://")&&443===t.serverConfig.port?t.serverConfig.site_domain+"/account/auth/google/callback":t.serverConfig.site_domain+":"+t.serverConfig.port+"/account/auth/google/callback",i.use(new o({clientID:t.GoogleAuth.clientID,clientSecret:t.GoogleAuth.clientSecret,callbackURL:e},(function(e,t,a,s){const i=a.emails[0].value,r=a.displayName;m.findOne({email:i},(function(o,n){if(n){if(-1!==n.providers.indexOf("Google"))return s(o,n.getModel());n.providers.push("Google"),n.providerIDs.Google={id:a.id,accessToken:e,refreshToken:t},n.save((function(){return s(o,n.getModel())}))}else new m({email:i,name:r,auths:{base:1},providerIDs:{Google:{id:a.id,accessToken:e,refreshToken:t}},providers:["Google"]}).register().then((e=>s(null,e))).catch((e=>{s(e)}))}))}))),f.get("/auth/google",i.authenticate("google",{scope:["email","openid"]})),f.get("/auth/google/callback",i.authenticate("google",{failureRedirect:"/account/signIn"}),(function(e,t){t.redirect("/project/list")}),(function(e,t,a,s){e&&(console.log("XD"),console.log(e)),s()}))}return f.post("/register",c((async e=>{const a={errors:[]},s=e.body.token;if(t.reCaptcha&&t.reCaptcha.reCaptchaSecret&&!(await p(s)).success)throw[u("a004",{name:"reCaptcha challenge failed",details:"We do not accept a robot to sign up our site."})];const i=await new m({email:e.body.email,passwd:e.body.passwd,providers:["local"]});await i.register();const r=await i.setAuthToken();return t.email&&t.email.smtpConfig?await l(r.email,r.authToken):9!==i.auths.base&&(i.auths.base=1,await i.save()),await w(e,r),a.success=await r.signIn(),a}))),f.get("/email-resend",c((async e=>{const a={errors:[]};if(!e.isAuthenticated())throw[u("a011")];const s=e.session.passport.user.id,i=await m.findById(s);if(!i)return e.logout(),a.success={isLoggedIn:!1},a;if(0!==i.auths.base||!t.email||!t.email.smtpConfig)throw 0===i.auths.base?(i.auths.base=1,await i.save(),g(i.id,"dataChange",{type:"update",target:"User",data:i.getModel()}),[u("a008")]):[u("a008")];return await l(i.email,i.authToken),a.success={resend:!0},a}))),f.get("/email-verify",c((async(e,t)=>{const a=e.query.authToken;if(void 0!==e.query.authToken){const e=await m.findOne({authToken:a});if(e)if(0===e.auths.base){try{await e.verifyEmail(a)}catch(e){if(!Array.isArray(e))throw e;t.redirect("/account/email-verifying?code="+e[0].code)}t.redirect("/account/email-verifying?code=a006")}else t.redirect("/account/email-verifying?code=a008");else t.redirect("/account/email-verifying?code=a004")}else t.redirect("/account/email-verifying")}))),f.post("/rename",c((async e=>{const t={errors:[]};if(!e.isAuthenticated())throw[u("a011")];const a=e.session.passport.user.id,s=e.body.newName,i=await m.findById(a);if(!i)throw[u("a015",{details:"The user account does not exist. Please check if you use the correct user ID."})];return s?s.length>60?t.errors.push(u("a022",{details:"The new name is too long. Please use a name with fewer than 61 characters."})):s.length<2?t.errors.push(u("a022",{details:"The new name is too short. Please use a name with more than 5 characters."})):(i.name=s,await i.save(),t.success=i.getModel()):t.errors.push(u("a022",{details:"The new name is empty. Please specify at least 6 characters as your name."})),t}))),f.get("/checkSignIn",c((async e=>{const t={errors:[]};if(!e.isAuthenticated())return e.logout(),t.success={isLoggedIn:!1},t;e.session.touch();const a=await m.findById(e.session.passport.user.id);return a?t.success=await a.signIn():(e.logout(),t.success={isLoggedIn:!1}),t}))),f.get("/signOut",c((async(e,t)=>{let a;e.isAuthenticated()&&(a=e.session.passport.user.id,await m.updateOne({_id:a},{$set:{isLoggedIn:!1}})),e.logout();t.json({errors:[],success:{isLoggedIn:!1}}),a&&g(a,"message",u("15"))}))),f.post("/signIn",c((async(e,a,s)=>{const r={errors:[]},o=e.body.token;if(t.reCaptcha&&t.reCaptcha.reCaptchaSecret&&!(await p(o)).success)throw[u("a004",{name:"reCaptcha challenge failed",details:"We do not accept a robot to sign up our site."})];const n=await function(e,t,a,s){return new Promise(((e,r)=>{i.authenticate("local",((t,a)=>t?r([u("a009",{details:"Failed to authenticate your account. Please try again.",attached:t})]):e(a)))(t,a,s)}))}(0,e,a,s);if(!n)throw[u("a009")];return await w(e,n),r.success=await n.signIn(),r}))),f.get("/api/login",r(),c((async e=>{const t=e.query.authToken.toString();if(!t)throw[u("a009")];const a=await m.findOne({authToken:t});if(!a)throw[u("a009",{details:"Invalid auth token."})];const s=a.authTime;if(((new Date).getTime()-s.getTime())/864e5>7)throw[u("a009",{details:"The auth token is expired."})];if(!a.auths||a.auths.base<2||a.auths.bdp<2)throw[u("a009",{details:"Sorry, you do not have privileges to login with the authToken."})];return await w(e,a),{errors:[],success:await a.signIn()}}))),f.get("/api/search",c((async e=>{const t={errors:[]},a=decodeURIComponent(e.query.q),s=e.session.passport.user.id;await h(s,"base",2);const i=new RegExp(a),r=await m.find({name:{$regex:i,$options:"i"}});return t.success=r.map((e=>e.getSlimModel())),t}))),f.get("/api/getAuthToken",c((async e=>{if(!e.isAuthenticated())throw[u("12")];const t=e.session.passport.user.id,a=await h(t,"base",2);if(a.auths.bdp<2)throw[u("a017",{details:"Sorry, you do not have enough priviledges to get the auth token."})];const s=a.authTime;let i;return((new Date).getTime()-s.getTime())/864e5>3&&(i=await a.setAuthToken()),i&&i.authToken?{errors:[],success:i.authToken}:{errors:[],success:a.authToken}}))),f}},230:(e,t,a)=>{const s=a(2127),i=a(5619),r=a(703),o=a(3708),n=a(4032),d=a(4959),c=a(6018),l=a(4841),p=a(3464),u=a(4298),h=a(5622);e.exports=function(e){const t=e.chiConfig,a=e.helpers,g=a.chiAsyncWrap,f=a.getAuthAsync,m=e.taskRunner,w=a.socketBroadcast,y=a.getCode,k=t.system.dataFilePath,v=t.system.taskLogFolder,b=s.Router();return b.all("/api/*",((e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(y("a011")),t.json(s);a()})),b.get("/api/task/list",g((async e=>{const t=e.session.passport.user.id;return await f(t,"bdp",8),{errors:[],success:(await r.find({})).map((e=>e.getModel()))}}))),b.get("/api/account/list",g((async e=>{const t=e.session.passport.user.id;return await f(t,"base",9),{errors:[],success:(await p.find({})).map((e=>e.getModel()))}}))),b.post("/api/user/:userId/approve",g((async e=>{const t={errors:[]},a=e.session.passport.user.id,s=parseInt(e.body.auth),r=e.body.authField?e.body.authField:"base",o=e.params.userId;if(isNaN(s))throw[y("a018")];if(a&&!i.Types.ObjectId.isValid(a))throw[y("a015",{details:"Invalid user id to change authority."})];await f(a,"base",9);const n=await p.findOne({_id:o});if(!n)throw[y("901")];if("base"===r&&9===n.auths[r])throw[y("a018",{details:"You may not change the admin's user auth."})];if(void 0===n.auths[r])throw[y("a018",{details:"Unknown user auth settings."})];if(isNaN(s))throw[y("a018",{details:"The user auth value should be a number."})];if(s>9)throw[y("a018",{details:"The user auth value should be less than 9."})];return n.auths[r]=s,await n.save(),t.success=n.getModel(),w(o,"dataChange",{type:"update",target:"User",data:t.success}),t}))),b.delete("/api/user/:userId",g((async e=>{const t=e.session.passport.user.id,a=e.params.userId;if(!i.Types.ObjectId.isValid(a))throw[y("a015",{details:"The user id you request is invalid. Please check if you use the correct user id."})];if(await f(t,"base",9),t===a)throw[y("a018",{details:"Sorry Administrator can not be deleted."})];const s=await p.findOne({_id:a});if(!s)throw[y("a015",{details:"The user id you request is invalid. Please check if you use the correct user id."})];const r=await c.find({owner:a});if(r.length>0)for(let e=0;e<r.length;e++){const t=r[e];0===t.status?await m.deleteTaskInQueue(t.id):1===t.status&&-1!==t.pid&&await m.stopRunningTask(t.id)}await n.deleteMany({owner:a}),await c.deleteMany({owner:a});try{await u.remove(h.resolve(k,a))}catch(e){throw[y("s001",{name:"Delete user folder failed",details:`You may want to delete the folder manually. The path: ${k}`,attached:e})]}return await s.remove(),{errors:[],success:s.getModel()}}))),b.get("/api/tasklogs/cleanups",g((async e=>{const t=e.session.passport.user.id;await f(t,"base",9);const a=await c.find({}),s=await u.readdir(v),i=a.map((e=>e.id));let r=0;for(let e=0;e<s.length;e++){const t=s[e];i.indexOf(t)<0&&(r++,await u.remove(h.join(v,t)))}return{errors:[],success:{msg:`${r} tasklog folders were removed.`}}}))),b.get("/api/temp/project_packages",g((async e=>{const t=e.session.passport.user.id;await f(t,"base",9);const a=await d.find();for(let e=0;e<a.length;e++){const t=a[e];t.packages=[t.package],await t.save()}return{errors:[],success:"ok"}}))),b.get("/api/result/history/:range",g((async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.range;let i;if(-1===["latest","week","twoWeeks","fourWeeks"].indexOf(s)&&(i=s.split("-"),2!==i.length))throw[y("903",{name:"Unknown date range",details:"The "+s+" is not a known range to request result histories. Please check again."})];if(await f(a,"bdp",9),"latest"===s){const e=await l.find().sort({createdAt:-1}).limit(20).populate("user"),a=[];for(let t=0;t<e.length;t++){const s=e[t],i={id:s.id,title:s.title,desc:s.desc,status:s.status,timer:s.timer,taskName:s.taskName,projectName:s.projectName,projectDesc:s.projectDesc,project:s.project,result:s.result,user:s.user?s.user.getModel():"(deleted user)",createdAt:s.createdAt,updatedAt:s.updatedAt};a.push(i)}t.success=a}else{const e=(new Date).getTime();let a,r;switch(s){case"week":a=new Date(e-6048e5);break;case"twoWeeks":a=new Date(e-12096e5);break;case"fourWeeks":a=new Date(e-24192e5);break;default:i?(a=new Date(Number(i[0])),r=new Date(Number(i[1]))):a=new Date(e-6048e5)}r||(r=new Date);const o=await l.find({createdAt:{$gte:a,$lte:r}}).sort({createdAt:-1}).populate("user"),n=[];for(let e=0;e<o.length;e++){const t=o[e],a={id:t.id,title:t.title,desc:t.desc,status:t.status,timer:t.timer,taskName:t.taskName,projectName:t.projectName,projectDesc:t.projectDesc,project:t.project,result:t.result,user:t.user?t.user.getModel():t.user,createdAt:t.createdAt,updatedAt:t.updatedAt};n.push(a)}t.success=n}return t}))),b.get("/api/system-errors/list",g((async e=>{const t=e.session.passport.user.id;return await f(t,"base",9),{errors:[],success:(await o.find({}).sort({createdAt:-1}).populate("account")).map((e=>e.getModel()))}}))),b.delete("/api/system-errors/:sysErrId/remove",g((async e=>{const t=e.session.passport.user.id,a=e.params.sysErrId;if(!i.Types.ObjectId.isValid(a))throw[y("s004")];await f(t,"base",9);const s=await o.deleteOne({_id:a});return w(t,"dataChange",{type:"remove",target:"system-error",data:a}),{errors:[],success:s}}))),b.delete("/api/system-errors/all",g((async e=>{const t=e.session.passport.user.id;return await f(t,"base",9),{errors:[],success:await o.deleteMany({})}}))),b}},5963:(e,t,a)=>{const s=a(2127),i=a(5619),r=a(4959),o=a(4032),n=a(4298),d=a(479),c=a(5622),l=a(4673),p=a(9644),u=a(5543),h=a(2709),g=a(8162),f=a(1600);e.exports=function(e){const t=e.chiConfig.system.dataFilePath,m=e.helpers,w=m.chiAsyncWrap,y=m.getAuthAsync,k=m.isAuthenticated,v=m.getCode,b=s.Router(),x={};return b.use("/static/:dataFileId",d({methods:["GET","HEAD","OPTIONS"],allowedHeaders:["range","Cache-control","If-None-Match","Content-Type"],exposedHeaders:["Content-Length","Content-Range","Content-Type"],credentials:!0}),w((async(e,t,a)=>{const n=e.params.dataFileId;if(!i.Types.ObjectId.isValid(n))throw[v("27")];const d=await k(e,"bdp",2);if(!d)throw[v("12")];const c=await o.findOne({_id:n});if(!c)throw[v("27",{details:"Sorry, we can not find the file record for you."})];if(!(await r.findOne({_id:c.project})).getPrivilege(d).canView)throw[v("38",{details:"Sorry, you do not have privileges to view files in this project."})];if(!x[n])return x[n]=c.realPath||c.path,b.use("/static/"+n,s.static(x[n]),h(x[n],{icons:!0,view:"details"})),t.redirect(`/data/static/${n}/${e.path}`),!1;a()}))),b.post("/api/data/download",w((async(e,t)=>{if(!e.isAuthenticated())throw[v("12")];const a=e.session.passport.user.id,s=e.body.projectID,i=e.body.fileIDs,d=await y(a,"bdp",2),c=await r.findOne({_id:s});if(!c)throw[v("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!c.getPrivilege(d).canView)throw[v("38",{details:"Sorry, you do not have privileges to view files in this project."})];const l=i.filter((e=>c.dataFiles.indexOf(e)>=0)),p=await o.find({_id:{$in:l},project:c.id});t.header("Content-Type","application/zip"),t.header("Content-Disposition",'attachment; filename="bdp-download.zip"');const h=u("zip",{zlib:{level:1}});h.pipe(t);const f={},m={};for(const e of p){const t=await n.realpath(e.path);if(await n.pathExists(t)){const a=await n.stat(t),s=e.prefix+e.name+e.suffix;a.isDirectory()?void 0===m[s]?(m[s]=0,h.directory(t+"/",g(s,{replacement:"_"}))):(m[s]++,h.directory(t+"/",g(s+"("+m[s]+")",{replacement:"_"}))):a.isFile()&&(void 0===f[s]?(f[s]=0,h.file(t,{name:g(s,{replacement:"_"})+"."+e.format})):(f[s]++,h.file(t,{name:g(s+"("+f[s]+")",{replacement:"_"})+"."+e.format})))}}return h.finalize(),!1}))),b.get("/api/dataFile/:dataFileId/:viewType",d({methods:["GET","HEAD","OPTIONS"],allowedHeaders:["range","Cache-control","If-None-Match","Content-Type"],exposedHeaders:["Content-Length","Content-Range","Content-Type"],credentials:!0}),w((async(e,d)=>{const p={errors:[]},g=e.params.dataFileId,m=e.params.viewType,w="true"===e.query.preview;let y=e.query.subPath;if(!i.Types.ObjectId.isValid(g))throw[v("27")];const S=await k(e,"bdp",2);if(!S)throw[v("12")];const O=await o.findOne({_id:g});if(!O)throw[v("27")];const I=await r.findOne({_id:O.project});if(!I.getPrivilege(S).canView)throw[v("38",{details:"Sorry, you do not have privileges to view files in this project."})];const P=await O.checkFile();if(!P)throw[v("27",{name:"File does not exist"})];if("download"===m){if("Folder"!==O.format){const e=O.prefix+O.name+O.suffix+"."+O.format;d.set({"Content-disposition":f(e),"x-no-compression":!0,"Content-Length":P.size});const a=c.resolve(t+"/"+I.id);if(!l(O.path,a))throw[v("27",{details:"Invalid file to download."})];return d.sendFile(O.path),!1}{if(y){y=y.replace(/\.\./g,"");const e=c.join(O.path,y);if(l(e,O.path)&&await n.pathExists(e)){const t=await n.stat(e);if(t.isFile())return d.set({"Content-disposition":`attachment; filename="${c.basename(e)}"`,"x-no-compression":!0,"Content-Length":t.size}),d.sendFile(e),!1}throw[v("27",{details:"Invalid file to download"})]}d.header("Content-Type","application/zip"),d.header("Content-Disposition",`attachment; filename="${O.prefix}${O.name}${O.suffix}.zip"`);const e=u("zip",{zlib:{level:9}});return e.pipe(d),e.directory(O.path+"/",!1),e.finalize(),!1}}if("static"===m)return null==x[g]&&"Folder"===O.format&&(x[g]=O.realPath||O.path,b.use("/static/"+g,s.static(x[g]),h(x[g],{icons:!0,view:"details"}))),d.redirect("/data/static/"+g),!1;if("csv"==O.format){const e=O.path,t=[];let s=0;const i=a(1058).createInterface({input:n.createReadStream(e)});return i.on("line",(function(e){s++;let a=e.split(",");"rownames"===m&&w?a=a.slice(0,5):"rownames"!==m||w||(a=a[0]),t.push(a),"colnames"===m&&w?s>=5&&i.close():"colnames"!==m||w||1===s&&i.close()})),void i.on("close",(function(){p.success={id:g,viewType:m,isPreview:w,data:t},d.json(p)}))}if("json"==O.format){const e=O.path;let t="";const s=a(1058).createInterface({input:n.createReadStream(e)});return s.on("line",(function(e){t+=e})),void s.on("close",(function(){p.success={id:g,viewType:m,isPreview:w,data:JSON.parse(t)},d.json(p)}))}throw[v("-2",{name:"Data currently not supported"})]}))),b.post("/api/dataFile/:dataFileId/glob",w((async e=>{const t={errors:[],success:[]};if(!e.isAuthenticated())throw[v("12")];const a=e.session.passport.user.id,s=e.params.dataFileId,n=e.body.globbyExprs,d=await y(a,"bdp",2);if(!i.Types.ObjectId.isValid(s))return t;const c=await o.findOne({_id:s});if(!c)throw[v("27")];if(!(await r.findOne({_id:c.project})).getPrivilege(d).canView)throw[v("38",{details:"Sorry, you do not have privileges to view files in this project."})];return"Folder"!==c.format||(t.success=await p(n,{cwd:c.path,root:c.path,follow:!1})),t}))),b}},2545:(e,t,a)=>{const s=a(2127),i=a(5619),r=a(7211),o=a(4959),n=a(4032),d=a(1671),c=a(5622),l=a(4298),p=a(4673),{google:u}=a(2944),h=a(6047),g=u.auth.OAuth2,f=/[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+(?:[A-Z]{2}|com|org|net|edu|gov|mil|biz|info|mobi|name|aero|asia|jobs|museum)\b/;e.exports=function(e){const t=e.chiConfig,a=e.helpers,m=a.chiAsyncWrap,w=a.getAuthAsync,y=a.errorHandler,k=a.logMessages,v=a.makeDataFileDeleted,b=t.system.dataFilePath,x=a.getCode,S=a.socketBroadcast,O=s.Router(),I={"application/vnd.google-apps.document":["text/html","text/plain","application/rtf","application/vnd.oasis.opendocument.text","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/pdf"],"application/vnd.google-apps.spreadsheet":["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/x-vnd.oasis.opendocument.spreadsheet","text/csv","application/pdf"],"application/vnd.google-apps.drawing":["image/jpeg","image/png","image/svg+xml","application/pdf"],"application/vnd.google-apps.presentation":["application/vnd.openxmlformats-officedocument.presentationml.presentation","application/pdf","text/plain"]};if(O.all("/api/*",((e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(x("a011")),t.json(s);a()})),O.get("/api/:dataFileId",m((async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(a))throw[x("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const r=await w(s,"bdp",2),d=await n.findOne({_id:a}).populate("owner").populate({path:"result",populate:{path:"owner outFiles inFiles task"}});if(!d)throw[x("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const c=await o.findOne({_id:d.project});if(!c)throw[x("19",{details:"We can not find the project for this data file please check if this is the right ID."})];if(!c.getPrivilege(r).canView)throw[x("38",{details:"Sorry, you do not have privileges to view the data file information."})];return t.success=d.getModel(),t}))),O.patch("/api/batchUpdate",m((async e=>{const t=e.body.dataFiles,a=e.session.passport.user.id,s=await w(a,"bdp",2),r=t.map((e=>i.Types.ObjectId.isValid(e.id)?e.id:null)).filter((e=>null!==e)),d=await n.find({_id:{$in:r}}).populate("owner result"),c=[...new Set(d.map((e=>e.project.toString())))],l=await o.find({_id:{$in:c}}),p=[];for(let e=0;e<d.length;e++){const i=d[e],r=t.filter((e=>e.id===i.id))[0],o=l.filter((e=>e.id===i.project.toString()))[0];if(r&&o){const e=o.getPrivilege(s);if(!e.canEditFile)continue;if(e.isRunner&&(!i.owner||i.owner.id!==a))continue;i.name=r.name.slice(0,80),i.desc=r.desc.slice(0,300),i.prefix=r.prefix.slice(0,36),i.suffix=r.suffix.slice(0,36);const t=i.tags.indexOf("Folder")>=0;i.tags=r.tags.map((e=>"Folder"===e?e:e.toLowerCase().replace(/[^a-zA-Z0-9\.\-\_]/g,"")));const n=i.tags.indexOf("Folder");t&&n<0&&i.tags.unshift("Folder"),!t&&n>=0&&(i.tags[n]=i.tags[n].toLowerCase());const d=(await i.save()).getModel();S(o.getListeners(),"dataChange",{type:"update",target:"DataFile",data:d}),p.push(d)}}return{errors:[],success:p}}))),O.patch("/api/:dataFileId",m((async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(a))throw[x("27",{details:"We can not find the data file id: "+a+". please check if this is the right ID."})];const r=await w(s,"bdp",2),d=await n.findOne({_id:a}).populate("owner result");if(!d)throw[x("27",{details:"We can not find the data file id: "+a+". please check if this is the right ID."})];const c=await o.findOne({_id:d.project}),l=c.getPrivilege(r);if(!l.canEditFile)throw[x("38",{details:"Sorry, you do not have privileges to edit files in this project."})];if(l.isRunner&&(!d.owner||d.owner.id!==s))throw[x("38",{details:"Sorry, you can only update information of your own DataFiles. This DataFile is not created by you."})];const p=e.body.name,u=e.body.desc,h=e.body.prefix||"",g=e.body.suffix||"";if(p.length>80)throw[x("28",{details:"The name for the data (id: "+a+") is too long. Please shorten the name and try saving again."})];if(u.length>300)throw[x("29",{details:"The description for the data file (id: "+a+") is too long. Please shorten the description and try saving again."})];const f=r.auths.bdp;if(d.name=p,d.desc=u,d.prefix=h.slice(0,36),d.suffix=g.slice(0,36),f>=2&&(e.body.format&&d.format,e.body.tags)){const t=d.tags.indexOf("Folder")>=0;d.tags=e.body.tags.map((e=>"Folder"===e?e:e.toLowerCase().replace(/[^a-zA-Z0-9\.\-\_]/g,"")));const a=d.tags.indexOf("Folder");t&&a<0&&d.tags.unshift("Folder"),!t&&a>=0&&(d.tags[a]=d.tags[a].toLowerCase())}return await d.save(),t.success=d.getModel(),S(c.getListeners(),"dataChange",{type:"update",target:"DataFile",data:t.success}),t}))),O.delete("/api/:dataFileId",m((async(e,t)=>{const a={errors:[]},s=e.params.dataFileId,r=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(s))throw[x("27",{details:`We can not find the data file id: ${s}. please check if this is the right ID.`})];const d=await w(r,"bdp",2),c=await n.findOne({_id:s}).populate("owner").populate({path:"result",populate:{path:"owner outFiles inFiles task"}});if(!c)throw[x("27",{details:`We can not find the data file id: ${s}. Please check if this is the right ID.`})];const l=await o.findOne({_id:c.project});if(!l)throw[x("19",{details:"We can not find the project for this data file please check if this is the right ID."})];const p=l.getPrivilege(d);if(!p.canDeleteFile)throw[x("38",{details:"Sorry, you do not have privileges to edit files in this project."})];if(p.isRunner&&(!c.owner||c.owner.id!==r))throw[x("38",{details:"Sorry, you can only delete your own DataFiles. This DataFile is not created by you."})];c.readOnly=!0,c.status=3;const u=c.getModel();return u.owner=d.getSlimModel(),a.success=u,await c.save(),t.json(a),S(l.getListeners(),"dataChange",{type:"update",target:"DataFile",data:u}),await v(c,l),!1}))),O.post("/api/:projectId/batchRemoveFiles",m((async(e,t)=>{const a={errors:[]},s=e.params.projectId,r=e.body.fileIDs||[],d=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(s))throw[x("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(0===r.length)throw[x("612",{type:"warning",details:"No files to be removed."})];if(r.filter((e=>!i.Types.ObjectId.isValid(e))).length>0)throw[x("612",{type:"warning",details:"There are invalid data file ids in your request."})];const c=await w(d,"bdp",2),l=await o.findOne({_id:s});if(!l)throw[x("19",{details:"We can not find the project for this data file please check if this is the right ID."})];const p=l.getPrivilege(c);if(!p.canDeleteFile)throw[x("38",{details:"Sorry, you do not have privileges to edit files in this project."})];const u={project:l.id,_id:{$in:r}};p.isRunner&&(u.owner=d);const h=await n.find(u).populate("owner result");h.forEach((e=>{e.readOnly=!0,e.status=3}));const g=h.map((e=>e.save()));for(const e of g)await e;a.success=h.map((e=>{const t=e.getModel();return t.owner=c.getSlimModel(),t})),t.json(a);for(const e of a.success)S(l.getListeners(),"dataChange",{type:"update",target:"DataFile",data:e});for(const e of h)await v(e,l);return!1}))),O.get("/api/:dataFileId/ls",m((async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id;let r=e.query.p;if(r&&(r=decodeURIComponent(r)),!i.Types.ObjectId.isValid(a))throw[x("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const d=await w(s,"bdp",2),p=await n.findOne({_id:a});if(!p)throw[x("27",{name:"Invalid data file ID",details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];if("Folder"!==p.format)throw[x("27",{name:"Failed to list files",details:`The file id: ${a} is not a folder. please check if this is the right ID.`})];if(!(await o.findOne({_id:p.project})).getPrivilege(d).canView)throw[x("38",{details:"Sorry, you do not have privileges to edit files in this project."})];let u="";try{u=await l.realpath(p.path)}catch(e){return{success:[],errors:[]}}if(r){const e=c.relative(p.path,r),t=c.relative(u,r);if(e.indexOf("..")>=0&&t.indexOf("..")>=0)throw[x("27",{name:"Invalid file path",details:"The path you are going to see is invalid. Please check if the path is correct."})];e.indexOf("..")<0&&(r=c.resolve(p.path,e)),t.indexOf("..")<0&&(r=c.resolve(u,t))}const h=r||u;let g=[];try{if((await l.stat(h)).isDirectory()){const e=(await l.readdir(h)).slice(0,5e3);for(const t of e){const e=await l.stat(c.resolve(h,t)),a=e.isDirectory()?"directory":e.isFile()?"file":e.isSymbolicLink()?"symlink":null;"directory"!==a&&"file"!==a&&"symlink"!==a||g.push({children:"directory"===a?[]:void 0,extensions:"file"===a||"symlink"===a?c.extname(t):void 0,name:t,size:e.size,type:a,path:c.resolve(h,t)})}}else g=[]}catch(e){console.log(e),g=[]}return t.success=g,t}))),O.post("/api/:dataFileId/move",m((async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id,r=e.body.dest;if(!i.Types.ObjectId.isValid(a))throw[x("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];if(""!==r&&!i.Types.ObjectId.isValid(r))throw[x("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const d=await w(s,"bdp",3),u=await n.findOne({_id:a}).populate("owner");if(!u)throw[x("27",{name:"Invalid data file ID",details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const g=await o.findOne({_id:u.project}),f=g.getPrivilege(d);if(!f.canEditFile)throw[x("38",{details:"Sorry, you do not have privileges to edit files in this project."})];if(f.isRunner&&(!u.owner||u.owner.id!==s))throw[x("38",{details:"Sorry, you can only move your own DataFiles. This DataFile is not created by you."})];const m=await l.realpath(u.path),y=await l.lstat(u.path),k=c.join(b,g.id),v=c.join(b,"shared");let S=!1,O=!1;if(p(m,k)?S=!0:p(m,v)&&(O=!0),""===r){const e=c.extname(u.path),a=c.join(b,u.project.toString(),u.id.toString()+e);if(u.path===a)t.success=u.getModel();else{try{if(S&&!y.isSymbolicLink())await l.move(u.path,a);else{if(!O||!y.isSymbolicLink())throw"Invalid scenarios to move files.";await l.ensureSymlink(c.relative(c.dirname(a),m),a),await l.unlink(u.path)}}catch(e){throw[x("27",{name:"File movement error",details:e.toString()})]}u.path=a,u.parent=void 0,t.success=u.getModel(),await u.save()}}else{const e=await n.findOne({_id:r,format:"Folder"});if(!e)throw[x("27",{name:"File movement error",details:`We can not find the folder id: ${r}. please check if this is the right ID.`})];const a=c.extname(u.path),s=h(u.name)+(a||""),i=c.join(e.path,s);if(u.path===i)u.parent=e.id,u.path=i,t.success=u.getModel(),await u.save();else{try{if(S&&!y.isSymbolicLink())await l.move(u.path,i);else{if(!O||!y.isSymbolicLink())throw"Invalid scenarios to move files.";await l.ensureSymlink(c.relative(c.dirname(i),m),i),await l.unlink(u.path)}}catch(e){throw[x("27",{name:"File movement error",attached:e})]}u.parent=e.id,u.path=i,await u.save(),t.success=u.getModel()}}return t}))),O.get("/api/:dataFileId/untrack",m((async(e,t)=>{const a={errors:[]},s=e.params.dataFileId,r=e.session.passport.user.id;if(!i.Types.ObjectId.isValid(s))throw[x("27",{name:"Invalid data file ID",details:`We can not find the data file id: ${s}. please check if this is the right ID.`})];const d=await w(r,"bdp",2),c=await n.findOne({_id:s}).populate("owner");if(!c)throw[x("27",{name:"Invalid data file ID",details:`We can not find the data file id: ${s}. please check if this is the right ID.`})];const p=await o.findOne({_id:c.project}),u=p.getListeners(),h=p.getPrivilege(d);if(!h.canEditFile)throw[x("38",{details:"Sorry, you do not have privileges to untrack files in this project."})];if(h.isRunner&&(!c.owner||c.owner.id!==r))throw[x("38",{details:"Sorry, you can only untrack your own DataFiles. This DataFile is not created by you."})];if(!c.parent)throw[x("608",{name:"Failed to untrack the file",details:"You cannot untrack a file that belongs to no folders."})];if(!await n.findOne({_id:c.parent,project:c.project}).populate("owner"))throw[x("608",{name:"Failed to untrack the file",details:"We encountered an error that the file to be untracked belongs to a folder that does not exist in the database.Please contact admin. You might want to delete the datafile directly."})];if(c.readOnly=!0,c.status=3,await c.save(),a.success=c.getModel(),S(u,"dataChange",{type:"update",target:"DataFile",data:c.getModel()}),t.json(a),"Folder"===c.format){const e=await n.find({parent:c.id}).populate("owner");for(let t=0;t<e.length;t++)e[t].parent=c.parent,await e[t].save(),S(u,"dataChange",{type:"update",target:"DataFile",data:e[t].getModel()})}c.realPath&&await l.remove(c.path);const g=c.getModel();await c.remove(),g.owner=d.getSlimModel(),p.dataFiles=p.dataFiles.filter((e=>e!==c.id)),await p.save(),S(p.getListeners(),"dataChange",{type:"remove",target:"DataFile",data:g})}))),O.post("/api/:dataFileId/track",m((async e=>{const t={errors:[]},a=e.params.dataFileId,s=e.session.passport.user.id,r=e.body.path;if(!i.Types.ObjectId.isValid(a))throw[x("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];const o=await w(s,"bdp",2);let d=await n.findOne({_id:a}).populate("owner").populate({path:"project",populate:{path:"owner managers runners viewers dataFiles results package"}});if(!d)throw[x("27",{details:`We can not find the data file id: ${a}. please check if this is the right ID.`})];if("Folder"!==d.format)throw[x("607",{details:"Please track files in a folder."})];d.parent&&(d=await n.findOne({_id:d.parent}).populate("owner").populate({path:"project",populate:{path:"owner managers runners viewers dataFiles results package"}}));const u=d.project;if(!u)throw[x("608",{name:"Failed to untrack the file",details:"This data file does not belong to any project. Please check if the integrity of the data file."})];const h=u.getPrivilege(o);if(!h.canEditFile)throw[x("38",{details:"Sorry, you do not have privileges to track files in this project."})];if(h.isRunner&&(!d.owner||d.owner.id!==s))throw[x("38",{details:"Sorry, you can only track your own DataFiles. This DataFile is not created by you."})];let g=[];if(Array.isArray(u.packages)&&u.packages.length>0&&(g=[].concat.apply([],u.packages.map((e=>e.formatMapping))).filter((e=>null!=e))),await n.findOne({realPath:r,parent:d.id,project:u.id}).populate("owner"))throw[x("607",{details:"The path is already being tracked in this project."})];const f=await l.realpath(r);let m;try{m=await l.stat(r)}catch(e){throw[x("607",{details:"The file/folder path you are going to track does not exist or the system can not see the file/folder",attached:e.stacks})]}const y=await l.realpath(d.path);let k;try{k=await l.stat(y)}catch(e){throw[x("607",{details:"The folder has some errors",attached:e})]}if(!k.isDirectory())throw[x("607",{details:"The files to be tracked should be in a folder.Please check again since you are trying to track file(s) in a non-folder."})];if(!p(f,y))throw[x("607",{details:`The tracked file does not in the folder, ${d.getName()}.`})];const v=c.basename(f);let O=v.split(".").slice(-1)[0],I=["file"];m.isDirectory()?(O="Folder",I=["Folder"]):(I=g.filter((e=>v.match(new RegExp(".*("+e.ext.replace(/\./g,"\\.").replace(/\-/g,"\\-").replace(/\_/g,"\\_")+")$")))).map((e=>e.tags))[0],I&&I.length||(I=[]));const P=c.join(b,u.id),j=c.join(b,"shared"),F=new n({name:c.parse(r).name,desc:"",format:O,owner:s,realPath:"",path:"",parent:d.id,project:u.id,tags:I,status:1});let T="";p(f,P)?T=f:p(f,j)?(T="Folder"===O?c.join(b,u.id,F.id):c.join(b,u.id,F.id+"."+O),F.realPath=f,await l.ensureSymlink(c.relative(c.dirname(T),f),T)):(T="Folder"===O?c.resolve(b,u.id,F.id):c.resolve(b,u.id,F.id+"."+O),F.realPath=f,await l.ensureSymlink(f,T)),F.path=T,u.dataFiles.push(F.id),await F.save(),await u.save();const D=F.getModel(h);return D.owner=o.getSlimModel(),D.project=u.id,S(u.getListeners(),"dataChange",{type:"insert",target:"DataFile",data:D}),t.success=D,t}))),O.post("/api/import/gdrive/file",m((async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,p=e.body.fileID,u=e.body.name,h=e.body.dataFileName||null,g=e.body.desc,f=e.body.authToken,m=e.body.mimeType,v=e.body.projectID,O=e.body.tags||[],P=e.body.prefix||"",j=e.body.suffix||"",F=e.body.keepFileName,T=e.body.folder||null;if(!i.Types.ObjectId.isValid(v))throw[x("19",{details:`We can not find the project id: ${v}. please check if this is the right ID.`})];if(T&&!i.Types.ObjectId.isValid(T))throw[x("19",{details:"The parent folder id is invalid."})];const D=await w(s,"bdp",2),$=await o.findOne({_id:v}).populate("packages");if(!$)throw[x("19",{details:`We can not find the project id: ${v}. please check if this is the right ID.`})];if(!$.getPrivilege(D).canAddFile)throw[x("38",{details:"Sorry, you do not have privileges to import files."})];let A;if(T&&(A=await n.findOne({_id:T}),!A||"Folder"!==A.format))throw[x("19",{details:`Sorry, we couldn't find the parent folder of the id: ${T}`})];const _=[...new Set([].concat.apply([],$.packages.map((e=>e.allowedFormats))))],M=function(e,t){const a=I[e];if(a)for(let e=0;e<t.length;e++)for(let s=0;s<a.length;s++)if(d.extensions[a[s]])for(let i=0;i<d.extensions[a[s]].length;i++){const r=d.extensions[a[s]][i];if(t[e]===r||t.indexOf("*")>=0)return{ext:r,mimeType:a[s]}}}(m,_),E=function(e,t){const a=d.extensions[e];for(let e=0;e<a.length;e++)if(t.indexOf("*")>=0||t.indexOf(a[e])>=0)return a[e]}(m,_);if(!M&&!E)throw[x("unknown",{name:"Type not supported",details:`The mime file type, ${m}, is currently not supported`})];const C=M?`/drive/v3/files/${p}/export?alt=media&mimeType=${M.mimeType}`:`/drive/v3/files/${p}?alt=media`,N=M?M.mimeType:m,R=M?M.ext:E;let L=[];if(Array.isArray($.packages)&&$.packages.length>0){const e=[].concat.apply([],$.packages.map((e=>e.formatMapping))).filter((e=>null!=e));e&&e.length>0&&(L=e.filter((e=>e.ext===R)).map((e=>e.tags))[0]||[])}Array.isArray(O)&&(L.push.apply(L,O.map((e=>e.toLowerCase().replace(/[^a-z0-9\.\-\_]/g,"").trim()))),L=L.filter((e=>null!=e||""!==e)));const q=new n({name:h?h.slice(0,80):u.slice(0,80),prefix:P.slice(0,36),suffix:j.slice(0,36),desc:g.slice(0,300),status:0,format:R,owner:s,project:v,tags:[...new Set(L)].map((e=>e.toString())),readOnly:!1});let V=c.resolve(`${b}/${v}/${q.id}.${R}`);A&&(q.parent=A.id,V=F?c.resolve(A.path,`${u}.${R}`):c.resolve(A.path,`${q.id}.${R}`)),q.path=V;const W=await q.save();$.dataFiles.push(q.id),await $.save();const B=W.getModel();a.success=B;const z=$.getListeners();S(z,"dataChange",{type:"insert",target:"DataFile",data:B}),t.json(a);try{await function(e,t,a,s,i){return new Promise(((o,n)=>{const d={hostname:"www.googleapis.com",port:443,path:`/drive/v3/files/${e}/export?alt=media&mimeType=text/csv`,method:"GET",path:s,headers:{Authorization:"Bearer "+a}};r.request(d,(e=>{const a=e.headers["content-type"]===i;if(a){const a=l.createWriteStream(t);e.pipe(a),e.on("end",(function(){a.end(),o()}))}else{let t="";e.on("data",(e=>t+=e)),e.on("end",(function(){let s;a||(-1!==e.headers["content-type"].indexOf("application/json")?(s=JSON.parse(t),s.error?n([x("unknown",{name:s.error.message,attached:s.error})]):n([x("unknown",{attached:s})])):n([x("unknown",{attached:t})]))}))}})).end()}))}(p,V,f,C,N),q.status=1,q.readOnly=!1,await q.save();const e=q.getModel();e.owner=D.getSlimModel(),S(z,"dataChange",{type:"update",target:"DataFile",data:e})}catch(t){y(a,t),k(s,a.errors,e.route.path);for(const e of a.errors)S(z,"message",e)}return!1}))),t.GoogleAuth&&t.GoogleAuth.Google_clientID&&t.GoogleAuth.Google_clientSecret){let e="";e=0===t.serverConfig.site_domain.indexOf("http://")&&80===t.serverConfig.port||0===t.serverConfig.site_domain.indexOf("https://")&&443===t.serverConfig.port?t.serverConfig.site_domain+"/datafile/export/gdrive/callback":`${t.serverConfig.site_domain}:${t.serverConfig.port}/datafile/export/gdrive/callback`;const a=new g(t.GoogleAuth.Google_clientID,t.GoogleAuth.Google_clientSecret,e),s=function(e){return new Promise(((t,s)=>{a.getToken(e,(function(e,a){return e?s(e):t(a)}))}))};O.get("/:dataFileId/export/gdrive",m((async(e,t)=>{if(!e.isAuthenticated())throw[x("a011")];const s=e.session.passport.user.id;await w(s,"bdp",2);const i={dataFileID:e.params.dataFileId},r=e.query.share;r&&(i.share=r);const o=a.generateAuthUrl({state:JSON.stringify(i),scope:["https://www.googleapis.com/auth/drive.file"]});return t.redirect(o),!1}))),O.get("/export/gdrive/callback",m((async(e,t)=>{const r=e.query.code,d=JSON.parse(e.query.state),c=d.dataFileID,p=d.share;if(!e.isAuthenticated())throw[x("a011")];if(!i.Types.ObjectId.isValid(c))throw[x("27",{details:`We can not find the data file id: ${c}. please check if this is the right ID.`})];const h=e.session.passport.user.id,g=await w(h,"bdp",2),m=await n.findOne({_id:c}).populate("owner");if(!m)throw[x("27",{details:`We can not find the data file id: ${c}. please check if this is the right ID.`})];const y=await o.findOne({_id:m.project}),k=y.getPrivilege(g),v=y.getListeners();if(!k.canEditFile)throw[x("38",{details:"Sorry, but you do not have privileges to edit files."})];const b=await s(r);a.setCredentials(b);const O=u.drive({version:"v3",auth:a}),I=m.path;let P="",j="";return"csv"===m.format&&(P="text/csv",j="application/vnd.google-apps.spreadsheet"),t.write("<script> window.open('', '_self', ''); window.close(); <\/script>"),S(h,"message",x("609",{name:"File exporting",details:`The datafile, <b>${m.getName()}</b>, is now exporting to GoogleDrive. Please wait.`})),t.end(),P&&j?O.files.create({resource:{name:m.getName(),mimeType:j},media:{mimeType:P,body:l.createReadStream(I)}},((e,t)=>{if(e)S(h,"message",x("600",{details:`The datafile, ${m.getName()}, failed to export to Google Drive. Please try again.`,attached:e}));else if(S(v,"message",x("601",{details:`The datafile, ${m.getName()}, has exported to your Google Drive.`})),p&&f.test(p)){const e=t.id;O.permissions.create({resource:{type:"user",role:"writer",emailAddress:p},fileId:e,fields:"id"},(function(e){e?S(h,"message",x("602",{details:`The datafile, ${m.getName()}, has exported to your Google Drive.`,attached:e})):S(v,"message",x("603",{details:`The datafile, ${m.getName()}, has been successfully shared to ${p}`}))}))}else p&&S(h,"message",x("602",{details:`Please check the email format (${p}) you are going to share.`}))})):S(h,"message",x("600",{details:`The datafile, ${m.getName()}, failed to export to Google Drive. This file type is currently not supported to export.`})),!1})))}return O}},2133:(e,t,a)=>{const s=a(2127),i=a(5619),r=a(146),o=a(3464),n=a(4298),d=a(4673),c=a(5622);e.exports=function(e){const t=e.helpers,a=e.chiConfig.serverConfig,l=t.chiAsyncWrap,p=t.getAuthAsync,u=t.getCode,h=t.socketBroadcast,g=s.Router();return g.get("/api/:packageId/*",l((async(e,t)=>{const s=0===a.site_domain.indexOf("https://"),o=e.params.packageId;if(!i.Types.ObjectId.isValid(o))throw[u("700")];const l=await r.findOne({_id:o});if(!l)throw[u("700",{details:"This package does not exist"})];if(s){if(!e.isAuthenticated())throw[u("a011")];const t=e.session.passport.user.id,a=await p(t,"bdp",2);if(!l.getPrivilege(a).canRun)throw[u("700",{details:"Sorry, you do not have privileges to view this entry page."})]}const h=l.path,g=c.normalize(e.path.replace("/api/"+o,h+"/client"));if(d(g,h)&&await n.pathExists(g)&&(await n.stat(g)).isFile())return void t.sendFile(g);const f=c.normalize(e.path.replace("/api/"+o,c.resolve(process.env.BDP_SYSTEM_FOLDER,"public")));if(!(d(f,c.resolve(process.env.BDP_SYSTEM_FOLDER,"public"))&&await n.pathExists(f)&&(await n.stat(f)).isFile()))return t.redirect("/assets/pages/not-found.html"),!1;t.sendFile(f)}))),g.all("/*",((e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(u("a011")),t.json(s);a()})),g.post("/api/pages/save",l((async e=>{const t={errors:[]},a=e.session.passport.user.id,s=await p(a,"bdp",7),n=e.body.package;if(!i.Types.ObjectId.isValid(n.id))throw[u("714")];const d=await r.findOne({_id:n.id});if(!d)throw[u("714")];if(!d.getPrivilege(s).canEdit)throw[u("714",{details:"Sorry, you have no privileges to edit the entry pages."})];const c=n.pages;if(!Array.isArray(c.indexPages)||!Array.isArray(c.resultPages)||!Array.isArray(c.filePages))throw[u("714")];let l="indexPages";const g=function(e){return{name:e.name||"unnamed",desc:e.desc||"(no description)",path:e.path||"/assets/pages/index.html",key:e.key||"",img:e.img||"",thumbnail:e.thumbnail||"",tasks:"resultPages"!==l?void 0:Array.isArray(e.tasks)?e.tasks.map((e=>e.toString())):[],tags:"filePages"!==l?void 0:Array.isArray(e.tags)?e.tags.map((e=>e.toString())):[],rule:"filePages"!==l?void 0:["or","and","all"].indexOf(e.rule)>=0?e.rule:"or",format:"filePages"!==l?void 0:e.format||""}};c.indexPages=c.indexPages.map(g),l="resultPages",c.resultPages=c.resultPages.map(g),l="filePages",c.filePages=c.filePages.map(g),d.pages=c;const f=await d.save(),m=f.getModel(f.getPrivilege(s)),w=(await o.find({"auths.bdp":{$gte:8}})).map((e=>e._id.toString()));return h(w,"dataChange",{type:"update",target:"Package",data:m}),t.success=m,t}))),g.get("/api/list",l((async e=>{const t={errors:[],success:[]},a=e.session.passport.user.id,s=await p(a,"bdp",2),o=e.query.only,n=e.query.package;if(!i.Types.ObjectId.isValid(n))throw[u("700")];const d=await r.findOne({_id:n});if(!d)throw[u("700",{details:"This package does not exist"})];const c=d.getPrivilege(s),l=d.name.split("-").slice(0,-1).join("-");if(!c.canView&&!c.canRun)return t;const h=s.auths.bdp,g=await r.find({scope:{$in:[l,"all","utility"]}}),f=[d.id];for(const e of g)e.scope.indexOf("admin")>=0?h>=8&&f.push(e.id):f.push(e.id);const m={_id:[d.id]};o||(m._id={$in:f});const w=await r.find(m);return t.success=w.map((e=>e.getModel(e.getPrivilege(s)))),t}))),g}},1773:(e,t,a)=>{const s=a(2127),i=a(5619),r=a(4959),o=a(146),n=a(6018),d=a(4032),c=a(3464),l=a(4673),p=a(8633),u=a(5622),h=a(4298),g=a(8162);e.exports=function(e){const t=e.chiConfig,a=t.system.dataFilePath,f=e.helpers,m=f.chiAsyncWrap,w=f.getCode,y=f.getAuthAsync,k=f.getProjectByID,v=f.socketBroadcast,b=f.makeResultDeleted,x=f.makeDataFileDeleted,S=p.diskStorage({destination:function(e,a,s){s(null,u.resolve(t.system.uploadFolder))},filename:function(e,t,a){a(null,"Data-"+Date.now())}}),O={fileSize:t.system.fileLimits||1/0},I=p({storage:S,limits:O}).array("file"),P=s.Router();return P.all("/api/*",((e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(w("a011")),t.json(s);a()})),P.post("/api/create",m((async e=>{const t=e.session.passport.user.id,s=await y(t,"base",2),i=e.body.projectName,n=e.body.projectDesc,d=e.body.projectPackages,c=e.body.isPublic,l=(await o.find({_id:d})).filter((e=>!(s.auths.base<8&&e.scope.indexOf("admin")>=0)&&e.scope.indexOf("utility")<0)),p=new r({name:i.slice(0,160),owner:t,desc:n.slice(0,1e3),packages:d.map((e=>l.filter((t=>t.id===e))[0])).filter((e=>!!e)).map((e=>e.id)),dataFiles:[],results:[],managers:[],runners:[],viewers:[],public:!!c});await h.ensureDir(u.resolve(a+"/"+p.id)),await p.save();const g=await k(p.id);return{success:g.getModel(g.getPrivilege(s)),errors:[]}}))),P.post("/api/:pid/upload",m((async(e,a)=>{const s={errors:[]},r=e.session.passport.user.id,o=e.params.pid;if(!i.Types.ObjectId.isValid(o))throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];const n=await y(r,"bdp",2),c=await k(o);if(!c)throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];if(!c.getPrivilege(n).canAddFile)throw[w("38",{details:"Sorry, you can not create data files in this project."})];const l=c.packages;try{await((e,t)=>new Promise(((a,s)=>I(e,t,(e=>e?s(e):a())))))(e,a)}catch(t){for(const t of e.files)await h.unlink(t.path);throw[w("13",{code:13,name:"File upload failed",attached:t})]}const p=e.body.folder?e.body.folder:null,g="true"===e.body.keepFileName,f=e.body.tags?e.body.tags.split(","):[],m=e.body.name||"",b=e.body.desc||"",x=e.body.prefix||"",S=e.body.suffix||"",O=[],P=[],j=await d.findOne({_id:p});for(let a=0;a<e.files.length;a++){const s=e.files[a],i=s.originalname,p=s.path,y=[...new Set([].concat.apply([],c.packages.map((e=>e.allowedFormats))))].map((e=>e.toString()));let k=!1,I="",F=[];for(let e=0;e<y.length;e++){const t=y[e].replace(/\./g,"\\.").replace(/\-/g,"\\-").replace(/\_/g,"\\_"),a="*"===t?new RegExp(".*\\.(.*)$"):new RegExp(".*("+t+")$"),s=i.match(a);if(s){k=!0,I=s[1];for(let e=0;e<l.length;e++){const t=l[e].formatMapping;for(let e=0;e<t.length;e++){const a=t[e];if(a.ext===I){F=a.tags;break}}}break}}if(!k){await h.remove(p),console.log(i),O.push(w("16",{details:"The file ,"+i+", is invalid. Please check the format."}));continue}let T="";Array.isArray(f)&&(F.push.apply(F,f.map((e=>e.toLowerCase().replace(/[^a-z0-9\.\-\_]/g,"").trim()))),F=F.filter((e=>!!e)));const D=new d({name:m&&m.slice?m.slice(0,80):u.basename(i,"."+I),desc:b&&b.slice?b.slice(0,300):"",format:I,owner:r,project:o,tags:F,readOnly:!0,prefix:x.slice(0,36),suffix:S.slice(0,36)});if(j&&"Folder"===j.format?(D.parent=j.id,T=g?u.resolve(j.path+"/"+i):u.resolve(j.path+"/"+D.id+"."+I)):T=u.resolve(t.system.dataFilePath,o,D.id+"."+I),await h.pathExists(T)){O.push(w("604",{details:`The file name '${i}' has being used. Please change the file name and upload again.`})),await h.remove(p);continue}try{await h.stat(T)}catch(e){if("EEXIST"===e.code){D.status=3,await h.remove(p),O.push();continue}if("ENOENT"!==e.code){D.status=3,h.remove(p),O.push(w("604",{details:`The file '${i}' failed to be uploaded. Please try again.`,attached:e}));continue}try{await h.copy(u.resolve(p),T,{overwrite:!1}),await h.remove(p)}catch(e){await h.remove(p),O.push(w("605",{attached:e}));continue}}c.dataFiles.push(D.id),D.path=T,D.status=1,D.readOnly=!1,await D.save(),await c.save();const $=D.getModel();$.owner=n.getSlimModel(),$.project=o,v(c.getListeners(),"dataChange",{type:"insert",target:"DataFile",data:$}),P.push($)}return s.errors=O,s.success=P,s}))),P.post("/api/:pid/createFolder",m((async e=>{const t={errors:[]},s=e.session.passport.user.id,o=e.params.pid,n=e.body.folder||"",c=e.body.keepFileName,l=e.body.prefix||"",p=e.body.suffix||"",f=e.body.tags,m=e.body.name;if(!i.Types.ObjectId.isValid(o))throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];if(n&&!i.Types.ObjectId.isValid(n))throw[w("19",{details:`Sorry, we could not find valid parent id: ${n}.`})];const k=await y(s,"bdp",2),b=await r.findOne({_id:o}).populate("dataFiles results");if(!b)throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];if(!b.getPrivilege(k).canAddFile)throw[w("38",{details:"Sorry, you do NOT have privileges to create folders in this project."})];let x;if(n&&(x=await d.findOne({_id:n}),!x||"Folder"!==x.format))throw[w("19",{details:`Sorry, we could not find valid parent id: ${n}.`})];let S=[];Array.isArray(f)&&S.push.apply(S,f.map((e=>"Folder"===e?e:e.toLowerCase().replace(/[^a-z0-9\.\-\_]/g,"").trim()))),S=[...new Set(S)].map((e=>e.toString())),S.indexOf("Folder")<0&&S.unshift("Folder");const O=new d({name:m,format:"Folder",owner:s,project:o,tags:S,readOnly:!1,prefix:l.slice(0,36),suffix:p.slice(0,36)});let I=u.resolve(`${a}/${o}/${O.id}`);if(x){O.parent=x.parent?x.parent:x.id;const e=g(m,{replacement:"_"})||O.id;I=c?u.resolve(x.path,e):u.resolve(x.path,O.id)}await h.ensureDir(I),O.path=I,O.status=1;const P=(await O.save()).getModel();return t.success=P,b.dataFiles.push(O.id),await b.save(),v(b.getListeners(),"dataChange",{type:"insert",target:"DataFile",data:P}),t}))),P.post("/api/:pid/importFromPath",m((async(e,t)=>{const s={errors:[]},o=e.session.passport.user.id,n=e.params.pid,c=e.body.directLink;let p=e.body.importedPath;const g=e.body.name,f=e.body.prefix||"",m=e.body.suffix||"",k=e.body.desc||"",b=e.body.keepFileName,x=e.body.folder||"",S=e.body.tags;if(!p)throw[w("605",{name:"Data File creation failed",details:"The folder path is empty."})];if(!i.Types.ObjectId.isValid(n))throw[w("19",{name:"Invalid project ID",details:`We can not find the project id: ${n}. please check if this is the right ID.`})];if(x&&!i.Types.ObjectId.isValid(x))throw[w("19",{name:"Invalid parent folder ID",details:`The parent folder id, ${x}, is invalid. please check if this is the right ID.`})];const O=await y(o,"bdp",3),I=await r.findOne({_id:n}).populate("packages");if(!I)throw[w("19",{details:`We can not find the project id: ${n}. please check if this is the right ID.`})];if(!I.getPrivilege(O).canAddFile)throw[w("38",{details:"Sorry, you do NOT have privileges to create folders in this project."})];let P;if(x&&(P=await d.findOne({_id:x}),!P||"Folder"!==P.format))throw[w("19",{name:"Invalid parent folder ID",details:`We can not find the valid parent folder id: ${x}. please check if this is the right ID.`})];const j=I.getListeners();let F;try{F=await h.stat(p),p=await h.realpath(p)}catch(e){throw[w("605",{details:"The folder does not exist or cannot be accessed.",attached:e})]}const T=u.parse(p),D=T.name,$=T.base,A=T.ext.replace(".","");let _=[];const M=[...new Set([].concat.apply([],I.packages.map((e=>e.allowedFormats))))].map((e=>e?e.toString():e));if(!F.isDirectory()){let e=!1;for(let t=0;t<M.length;t++){const a=M[t].replace(/\./g,"\\.").replace(/\-/g,"\\-").replace(/\_/g,"\\_"),s="*"===a?new RegExp(".*\\.(.*)$"):new RegExp(".*("+a+")$");if($.match(s)){e=!0;break}}if(!e)throw[w("605",{details:`The file, ${$}, has invalid extension.`})];if(Array.isArray(I.packages)&&I.packages.length>0){const e=[].concat.apply([],I.packages.map((e=>e.formatMapping)));e&&e.length>0&&(_=e.filter((e=>e.ext===A)).map((e=>e.tags))[0]||[])}}const E=new d({name:g?g.slice(0,80):D.slice(0,80),prefix:f.slice(0,36),suffix:m.slice(0,36),desc:k.slice(0,300),owner:o,project:n,tags:[],readOnly:!1,status:0});if(Array.isArray(S)){_.push.apply(_,S.map((e=>"Folder"===e?e:e.toLowerCase().replace(/[^a-z0-9\.\-\_]/g,"").trim()))),_=_.filter((e=>null!=e||""!==e));const e=_.indexOf("Folder");e>=0&&_.splice(e,1)}_=[...new Set(_)].map((e=>e.toString())),F.isDirectory()?(E.format="Folder",_.unshift("Folder")):E.format=A,E.tags=_;let C=u.resolve(a,n,E.id);if(P&&(E.parent=P.id,C=b?u.join(P.path,D):u.join(P.path,E.id)),"Folder"!==E.format&&(C+="."+A),E.path=C,await h.pathExists(C))throw[w("605",{details:`The path, ${C}, is already existed.`})];await E.save();const N=E.getModel();if(N.owner=O.getSlimModel(),I.dataFiles.push(E.id),await I.save(),s.success=N,v(j,"dataChange",{type:"insert",target:"DataFile",data:s.success}),t.json(s),!l(p,a)&&!c){let e=u.resolve(a,"shared",E.id);F.isDirectory()||(e+="."+A);try{await h.ensureDir(u.resolve(a,"shared")),await h.copy(p,e,{dereference:!0})}catch(t){return await h.remove(e),await E.remove(),console.log(t),void console.log("Failed")}p=e}try{if(c){const e=/^[\\\/]{2,}[^\\\/]+[\\\/]+[^\\\/]+/;if(F.isDirectory()&&!e.test(p)){await h.ensureSymlink(p,C,"junction");try{await h.stat(C)}catch(e){await h.remove(C),await h.ensureSymlink(p,C)}}else await h.ensureSymlink(p,C)}else await h.ensureSymlink(u.relative(u.dirname(C),p),C)}catch(e){return console.log(e),await h.remove(C),await E.remove(),void v(j,"dataChange",{type:"remove",target:"DataFile",data:E.getModel()})}E.status=1,E.realPath=p,await E.save();const R=E.getModel();return R.owner=O.getSlimModel(),v(j,"dataChange",{type:"update",target:"DataFile",data:R}),!1}))),P.post("/api/:pid/importFromDataFile",m((async(e,t)=>{const s=e.session.passport.user.id,o=e.params.pid,n=e.body.fileIDs,c=!!e.body.copy;if(!n||0===n.length)throw[w("605",{name:"Data File creation failed",details:"No data file to import."})];if(!i.Types.ObjectId.isValid(o))throw[w("19",{name:"Invalid project ID",details:`We can not find the project id: ${o}. please check if this is the right ID.`})];const p=await y(s,"bdp",2),g=await r.findOne({_id:o});if(!g)throw[w("19",{details:`We can not find the project id: ${o}. please check if this is the right ID.`})];if(!g.getPrivilege(p).canAddFile)throw[w("38",{details:"Sorry, you do NOT have privileges to create folders in this project."})];const f=g.getListeners(),m=p.getSlimModel(),k=(await d.find({_id:{$in:n}}).populate("project")).filter((e=>e.project&&e.project.getPrivilege&&e.project.id!==o&&e.project.getPrivilege(p).canView&&1===e.status)),b=[],x=[];for(let e=0;e<k.length;e++){const t=k[e],i=new d({name:t.name,owner:s,project:o,tags:t.tags,format:t.format,readOnly:t.readOnly,prefix:t.prefix||"",suffix:t.suffix||"",status:0});i.path=u.resolve(`${a}/${o}/${i.id}`),"Folder"!==t.format&&(i.path=i.path+"."+t.format),await i.save(),g.dataFiles.push(i.id),x.push({targetModel:i,sourceModel:t});const r=i.getModel();r.owner=m,r.project=o,v(f,"dataChange",{type:"insert",target:"DataFile",data:r}),b.push(r)}await g.save(),t.json({errors:[],success:b});for(const e of x){const t=e.targetModel,s=e.sourceModel,i=s.path,r=t.path;try{const e=await h.lstat(i);if(e.isDirectory()&&!c){await h.ensureSymlink(i,r,"junction");try{await h.stat(r)}catch(e){await h.remove(r),await h.ensureSymlink(i,r)}t.realPath=i}else if(e.isSymbolicLink()){const e=await h.realpath(i);if(c)await h.copy(e,r);else if(l(e,u.join(a,"shared")))await h.ensureSymlink(u.relative(u.dirname(r),e),r);else{await h.ensureSymlink(e,r,"junction");try{await h.stat(r)}catch(t){await h.remove(r),await h.ensureSymlink(e,r)}}t.realPath=e}else if(c)await h.copy(i,r);else{let e=u.resolve(a,"shared",s.id);if("Folder"!==s.format&&(e=e+"."+s.format),await h.pathExists(e))throw[w("605",{name:"The shared source file already existed.",details:`Please contact the system admin. The source path: ${e}.`})];await h.move(i,e,{dereference:!0}),await h.ensureSymlink(u.relative(u.dirname(i),e),i),s.realPath=e,await s.save(),t.realPath=e,await h.ensureSymlink(u.relative(u.dirname(r),e),r)}t.status=1}catch(e){console.log(e),t.status=4}await t.save();const n=t.getModel();n.owner=m,n.project=o,v(f,"dataChange",{type:"update",target:"DataFile",data:n})}return!1}))),P.get("/api/searchList",m((async e=>{const t={errors:[],success:[]},a=e.session.passport.user.id,s=await y(a,"bdp",2),i=decodeURIComponent(e.query.q),o=new RegExp(i);let n={};void 0===e.query.q||""==e.query.q?(n={$or:[{owner:a},{managers:a},{runners:a},{viewers:a}]},9===s.auths.bdp&&(n={})):(n={$and:[{name:{$regex:o,$options:"i"}},{$or:[{owner:a},{managers:a},{runners:a},{viewers:a}]}]},9===s.auths.bdp&&(n={name:{$regex:o,$options:"i"}}));const d=await r.find(n).populate("owner");return t.success=d.map((e=>({id:e.id,name:e.name,owner:e.owner?e.owner.name:"Unknown",privilege:e.getPrivilege(s)}))),t}))),P.get("/api/list",m((async e=>{const t={errors:[]},a=e.session.passport.user.id,s=void 0!==e.query.pageIndex?e.query.pageIndex:0,i=!isNaN(parseInt(e.query.pageSize))&&[5,10,30,50,100,300,500].indexOf(parseInt(e.query.pageSize))>=0?parseInt(e.query.pageSize):10,o=await y(a,"bdp",2),n=await r.countDocuments({owner:a}),d=n%i>0?Math.floor(n/i)+1:Math.floor(n/i),c=await r.find({owner:a}).sort({updatedAt:-1}).skip(i*s).limit(i).populate("owner managers runners viewers packages").populate({path:"packages",populate:{path:"owner"}});return t.success={records:c.map((e=>e.getModel(e.getPrivilege(o)))),totalPage:d,pageIndex:s,totalCount:n,pageSize:i},t}))),P.get("/api/sharedList",m((async e=>{const t=e.session.passport.user.id,a=void 0!==e.query.pageIndex?e.query.pageIndex:0,s=!isNaN(parseInt(e.query.pageSize))&&[5,10,30,50,100,300,500].indexOf(parseInt(e.query.pageSize))>=0?parseInt(e.query.pageSize):10,i=await y(t,"bdp",2),o=9===i.auths.bdp?{owner:{$ne:t}}:{$and:[{owner:{$ne:t}},{$or:[{managers:t},{runners:t},{viewers:t}]}]},n=await r.countDocuments(o),d=n%s>0?Math.floor(n/s)+1:Math.floor(n/s);return{errors:[],success:{records:(await r.find(o).sort({updatedAt:-1}).skip(s*a).limit(s).populate("owner managers runners viewers packages").populate({path:"packages",populate:{path:"owner"}})).map((e=>e.getModel(e.getPrivilege(i)))),totalPage:d,pageIndex:a,totalCount:n,pageSize:s}}}))),P.get("/api/publicList",m((async e=>{const t=e.session.passport.user.id,a=void 0!==e.query.pageIndex?e.query.pageIndex:0,s=!isNaN(parseInt(e.query.pageSize))&&[5,10,30,50,100,300,500].indexOf(parseInt(e.query.pageSize))>=0?parseInt(e.query.pageSize):10,i=await y(t,"bdp",2),o={public:!0},n=await r.countDocuments(o),d=n%s>0?Math.floor(n/s)+1:Math.floor(n/s);return{errors:[],success:{records:(await r.find(o).sort({updatedAt:-1}).skip(s*a).limit(s).populate("owner managers runners viewers packages").populate({path:"packages",populate:{path:"owner"}})).map((e=>e.getModel(e.getPrivilege(i)))),totalPage:d,pageIndex:parseInt(a),totalCount:n,pageSize:s}}}))),P.get("/api/:projectId/cleanup",m((async e=>{const t=e.session.passport.user.id,s=e.params.projectId,o=await y(t,"bdp",2);if(!i.Types.ObjectId.isValid(s))throw[w("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(o.id))throw[w("23",{details:"Please check if you use the correct userID."})];const c=await r.findOne({_id:s});if(!c)throw[w("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!c.getPrivilege(o).canEdit)throw[w("38",{details:"Sorry, you do not have privileges to process the cleanup procedure in this project."})];const l=c.dataFiles.map((e=>e.toString())),p=c.results.map((e=>e.toString())),u=await d.find({project:s}),h=u.map((e=>e.id)),g=u.filter((e=>l.indexOf(e._id.toString())<0));for(let e=0;e<g.length;e++)await g[e].unlinkFileAndRemove();c.dataFiles=l.filter((e=>h.indexOf(e)>=0));const f=u.filter((e=>l.indexOf(e._id.toString())>=0));for(let e=0;e<f.length;e++)await f[e].ensureFile(a);const m=await n.find({project:s}),k=m.map((e=>e.id)),v=m.filter((e=>p.indexOf(e._id.toString())<0));for(let e=0;e<v.length;e++)await b(v[e]);return c.results=p.filter((e=>k.indexOf(e)>=0)),await c.save(),{errors:[],success:{orphanDataFiles:g.length,orphanResults:v.length,projectDataFiles:c.dataFiles.length,projectResults:c.results.length}}}))),P.get("/api/:projectId",m((async e=>{const t=e.session.passport.user.id,a=e.params.projectId,s=await y(t,"bdp",2);if(!i.Types.ObjectId.isValid(a))throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(s.id))throw[w("23",{details:"Please check if you use the correct userID."})];const r=await k(a);if(!r)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const o=r.getPrivilege(s);if(!o.canView)throw[w("38",{details:"Sorry, you do not have privileges to view this project."})];return{errors:[],success:r.getModel(o)}}))),P.patch("/api/:projectId",m((async e=>{const t=e.session.passport.user.id,a=e.params.projectId,s=e.body.name,n=e.body.desc,d=e.body.packageIDs,c=!!e.body.public;if(!i.Types.ObjectId.isValid(a))throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(t))throw[w("23",{details:"Please check if you use the correct userID."})];const l=d.map((e=>e&&i.Types.ObjectId.isValid(e)?e:null)).filter((e=>null!==e)),p=await y(t,"bdp",2),u=(await r.findOne({_id:a})).getPrivilege(p);if(!u.canEdit)throw[w("38",{details:"Sorry, you do not have privileges to view this project."})];let h;h=l.length>=1?await o.find({_id:{$in:l}}):[];const g=h.map((e=>e.id)),f=h.map((e=>e.getPrivilege(p))),m={name:s,desc:n,public:c};m.packages=l.map((e=>{const t=g.indexOf(e);return t<0?null:f[t]&&f[t].canRun?e:null})).filter((e=>null!==e));const k=await r.findOneAndUpdate({_id:a},{$set:m},{new:!0}).populate("owner managers runners viewers packages").populate({path:"dataFiles",populate:{path:"owner"}}).populate({path:"results",populate:{path:"owner"}}).populate({path:"packages",populate:{path:"owner"}});if(!k)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];return{errors:[],success:k.getModel(u)}}))),P.delete("/api/:projectId",m((async e=>{const t=e.session.passport.user.id,s=e.params.projectId;if(!i.Types.ObjectId.isValid(s))throw[w("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(t))throw[w("23",{desc:"Please check if you use the correct userID."})];const o=await y(t,"bdp",2),c=await r.findOne({_id:s}).populate("dataFiles");if(!c)throw[w("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(!c.getPrivilege(o).canDelete)throw[w("38",{details:"Sorry, you do NOT have privileges to delete this project."})];const l=await n.find({project:s}).populate("inFiles outFiles task");for(const e of l)await b(e);const p=await d.find({project:s});for(const e of p)await x(e,c);await c.remove();const g=u.resolve(a+"/"+c.id);return await h.remove(g),{success:c.getModel(),errors:[]}}))),P.post("/api/:projectId/setMembers",m((async e=>{const t=e.session.passport.user.id,a=e.params.projectId,s=e.body.changes,o=e.body.scope;if(!i.Types.ObjectId.isValid(a))throw[w("19",{details:"The project ID is invalid, please check if this is the right ID."})];if(!s||0===s.length||!o||"runners"!==o&&"managers"!==o&&"viewers"!==o&&"owner"!==o)throw[w("402",{type:"warning",details:"No changing members. Please check if you input all correct member info."})];const n=await y(t,"bdp",2),d=await r.findOne({_id:a});if(!d)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const l=d.getPrivilege(n);if(!l.canSetMember||("owner"===o||"managers"===o)&&l.isManager)throw[w("38",{details:"Sorry, you do not have privileges to set members of this project."})];const p=s.map((e=>e.userID&&i.Types.ObjectId.isValid(e.userID)?e.userID:void 0)).filter((e=>void 0!==e));if(0===p.length)throw[w("402",{type:"warning",details:"No changes."})];const u=d[o],h=await c.find({_id:{$in:p}});if(0===h.length)throw[w("402",{type:"warning",details:"No changes."})];for(let e=0;e<h.length;e++){const t=h[e];for(let e=0;e<s.length;e++){const a=s[e];if("owner"===o&&t.id===a.userID){"add"===a.action?d.owner=t.id:"remove"===a.action&&(d.owner=void 0);break}if(t.id===a.userID){if("add"===a.action&&u.indexOf(t.id)<0){d[o].push(t.id);break}if("remove"===a.action){const e=u.indexOf(t.id);e>=0&&d[o].splice(e,1)}}}}await d.save();const g=await k(a);if(!d)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const f=g.getPrivilege(n);if(!f.canView)throw[w("38",{details:"Sorry, you do not have privileges to view this project."})];return{errors:[],success:g.getModel(f)}}))),P.get("/api/:projectId/relatedPackages",m((async e=>{const t=e.session.passport.user.id,a=e.params.projectId;if(!i.Types.ObjectId.isValid(a))throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];if(!i.Types.ObjectId.isValid(t))throw[w("23",{desc:"Please check if you use the correct userID."})];const s=await y(t,"bdp",2),n=await r.findOne({_id:a}).populate("dataFiles");if(!n)throw[w("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const d=await o.find({_id:{$in:n.packages}}),c=d.map((e=>e.getPrivilege(s))),l=d.filter(((e,t)=>{const a=c[t];return a.canView||a.canRun})).map((e=>e.name.split("-").slice(0,-1).join("-")));l.push("all","utility");const p=await o.find({$or:[{_id:{$in:d.map((e=>e.id))}},{scope:{$in:l}}]}),u=[];for(let e=0;e<n.packages.length;e++){const t=n.packages[e].toString();for(let e=0;e<p.length;e++)if(p[e].id===t){u.push.apply(u,p.splice(e,1));break}}return u.push.apply(u,p),{errors:[],success:u.filter((e=>!(e.scope.indexOf("admin")>=0)||s.auths.bdp>=8)).map((e=>e.getModel(e.getPrivilege(s))))}}))),P}},2689:(e,t,a)=>{const s=a(2127),i=a(5619),r=a(703),o=a(4032),n=a(5622),d=a(571),c=a(6018),l=a(4959),p=a(4298),u=a(146),h=a(6990),g=a(8835),f=a(5057).sleep,m=a(4841),w=h.createProxy({ws:!0});e.exports=function(e){const t=e.chiConfig,a=e.sessionParser,h=t.serverConfig,y=e.chiServer,k=e.proxyStore,v=t.system.dataFilePath,b=t.system.taskLogFolder,x=t.system.docker_path,S=t.system.scriptFolder,O=e.helpers,I=O.chiAsyncWrap,P=O.getCode,j=O.getAuthAsync,F=O.readTaskLogIndex,T=e.taskRunner,D=O.makeResultDeleted,$=O.makeResultStopped,A=O.socketBroadcast,_=s.Router();return _.all("/*",((e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(P("a011")),t.json(s);a()})),_.get("/api/activities",I((async e=>{const t={errors:[],success:void 0},a=e.session.passport.user.id,s=e.query.pageIndex||0,i="shared"===e.query.type?"shared":"owner"===e.query.type?"owner":null;let r=parseInt(e.query.pageSize);r=!isNaN(r)&&[10,30].indexOf(r)>=0?r:10;const o=await j(a,"bdp",2),n={$or:[]};"shared"===i?n.$or.push({managers:a},{runners:a},{viewers:a}):"owner"===i?n.$or.push({owner:a}):n.$or.push({owner:a},{managers:a},{runners:a},{viewers:a});const d=await l.find(n),p=d.map((e=>e.results)),u=[];for(let e=0;e<p.length;e++)Array.isArray(p[e])&&u.push.apply(u,p[e]);const h={};for(let e=0;e<d.length;e++){const t=d[e];h[t.id]=t.getPrivilege(o)}const g=await c.countDocuments({_id:{$in:u}}),f=g%r>0?Math.floor(g/r)+1:Math.floor(g/r),m=await c.find({_id:{$in:u},parent:{$exists:!1}}).sort({updatedAt:-1}).skip(r*s).limit(r).populate("owner inFiles outFiles task project"),w=[];for(let e=0;e<m.length;e++){const t=await T.getCurrentStdOutput(m[e].id);m[e].stdOut=t.stdOut||m[e].stdOut,m[e].stdErr=t.stdErr||m[e].stdErr,w.push(m[e].getModel(h[m[e].project.id]))}return t.success={records:w,totalPage:f,pageIndex:s,totalCount:g,pageSize:r},t}))),_.post("/api/task/:taskId/createResult",I((async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,h=e.body.inputs,g=e.body.outputs,w=e.body.run,y=e.params.taskId,k=e.body.projectID,O=e.body.desc;let I=e.body.prefix||"",F=e.body.suffix||"";const D=e.body.name;if(!i.Types.ObjectId.isValid(y))throw[P("31")];if(!i.Types.ObjectId.isValid(k))throw[P("19",{details:`We can not find the project id: ${k}. please check if this is the right ID.`})];const $=await j(s,"bdp",2),_=await l.findOne({_id:k}).populate("package");if(!_)throw[P("19")];if(!_.getPrivilege($).canRun)throw[P("38",{details:"Sorry, you do not have privileges to run tasks in this project."})];const M=await r.findOne({_id:y}),E=await u.findOne({_id:M.package});if(!E)throw[P("19",{details:"We can not find the package of the task."})];if(!M)throw[P("31")];if("system"===M.type&&$.auths.bdp<8)throw[P("708")];I=I.replace(/\ +$/," ").replace(/^\ +/,""),F=F.replace(/^\ +/," ").replace(/\ +$/,"");const C=new c({name:D?D.trim():`Result from ${M.name}`,desc:O,type:M.type,task:M.id,taskSnapshot:M.getModel(),project:k,owner:s,script:M.script,cwd:M.cwd,status:w?"workflow"===M.type?1:0:-1,readOnly:!1,timer:[new Date],outFiles:[],inFiles:[],arguments:[],prefix:I,suffix:F});let N,R,L,q,V,W=!1;M.proxy&&M.proxy.enabled&&(N=M.proxy.port||void 0,R=M.proxy.ip||void 0,L=M.proxy.protocol||void 0,q=!!M.proxy.pathRewrite,V=M.proxy.entryPath||void 0,W="true");const B={PROJECT_FOLDER:n.resolve(v,_.id),SHARED_FOLDER:n.resolve(v,"shared"),PACKAGE_FOLDER:n.resolve(E.path),TASK_ID:M.id,TASK_KEY:M.key,TASK_NAME:d(M.name,{condense:!0}),TASKLOG_FOLDER:b,DOCKER_PATH:x,BDP_SYSTEM_FOLDER:process.env.BDP_SYSTEM_FOLDER,BDP_HOST_PORT:N,BDP_PROXY_IP:R,BDP_PROXY_PORT:N,BDP_PROXY_PROTOCOL:L,BDP_PROXY_PATHREWRITE:q,BDP_PROXY_ENTRYPATH:V,BDP_PROXY_ENABLED:W,ARG_ENCODING:M.encodeArg?"base64":void 0,RESULT_ID:C._id.toString()};for(let e=0;e<M.arguments.length;e++)"inFile"==M.arguments[e].type&&C.inFiles.push(h[e]);const z=[],G=await o.find({_id:{$in:C.inFiles}}),U={},J={};for(const e of G)1===e.status&&(U[e.id]=e.path),e.realPath&&z.push(e.realPath),J[e.id]=e;const Y=[];for(let e=0;e<M.arguments.length;e++){const t=M.arguments[e];if("value"===t.type){if("number"===t.format){if(!(null!==h[e]&&void 0!==h[e]||t.optional)){Y[e]={type:"Can not be empty",data:h[e]};continue}if(isNaN(parseFloat(h[e]))){Y[e]={type:"Number required",data:h[e]};continue}}C.arguments[e]={value:h[e]}}else if("static"===t.type)C.arguments[e]={static:t.default[0]};else if("inFile"===t.type){let a=U[h[e]];if(!a&&!t.optional){Y[e]={type:"File not available",data:J[h[e]]};continue}!a&&t.optional&&(a=""),C.arguments[e]={inFile:a}}else if("list"===t.type){if(null===h[e]||void 0===h[e]){if(!t.optional){Y[e]={type:"Can not be empty",data:h[e]};continue}h[e]=[]}else if("[object Array]"===Object.prototype.toString.call(h[e])&&0===h[e].length&&!t.optional){Y[e]={type:"Can not be empty",data:h[e]};continue}C.arguments[e]={list:h[e]}}}if(Y.length>0)throw[P("32",{attached:Y})];const H=M.outputProvider(),K=[],Q=[],X={};for(let e=0;e<H.length;e++){const t=H[e].index;X[H[e].index]=e;const a=new o(H[e]);let i="",r="";if(H[e].dependOn&&H[e].default){let t="";const s=H[e].dependOn.split(".");if("argv"!==s[0]){console.log("Error!");continue}{const i=M.arguments[+s[1]];if("outFile"===i.type&&"Folder"===i.format){const e=K[X[+s[1]]];if(!e)continue;t=e.path,a.parent=e.id}else"inFile"===i.type&&"Folder"===i.format&&(t=U[h[+s[1]]],a.parent=h[+s[1]]);H[e].default.indexOf("{$FolderName}")>=0&&(H[e].default=H[e].default.replace(/\{\$FolderName\}/g,n.basename(t))),a.path=n.resolve(t,H[e].default)}}else a.path=n.resolve(`${v}/${k}/${a.id}`);"Folder"!==a.format&&(a.path+="."+a.format),i=g[e]&&g[e].name?g[e].name:a.name+" of the "+M.name,g[e]&&g[e].desc&&(r=g[e].desc),H[e].outPreFolder&&"Folder"===H[e].format&&Q.push(a.path),a.name=i,a.desc=r,a.owner=s,a.project=k,a.result=C.id,a.prefix=I,a.suffix=F,_.dataFiles.push(a.id),C.outFiles.push(a.id),K[e]=a,await K[e].save();const d=a.getModel();d.owner=$.getSlimModel(),A(_.getListeners(),"dataChange",{type:"insert",target:"DataFile",data:d}),"Folder"===a.format&&"name"===H[e].outFolderStyle&&"$ProjectFolder"===M.cwd?C.arguments[t]={outFile:n.basename(a.path)}:("Folder"===a.format&&H[e].outFolderStyle,C.arguments[t]={outFile:a.path})}const Z=M.compose(C.arguments,B.PACKAGE_FOLDER,B.PROJECT_FOLDER,S);if(C.command=Z.command,C.commandArgs=Z.commandArgs,"workflow"!==M.type)if("$ProjectFolder"===M.cwd)C.cwd=n.resolve(v+"/"+k);else if(M.cwd.match(/^\$ScriptFolder/))C.cwd=n.resolve(M.cwd.replace(/^\$ScriptFolder/,S));else if(M.cwd.match(/^\$PackageFolder/))C.cwd=n.resolve(M.cwd.replace(/^\$PackageFolder/,B.PACKAGE_FOLDER));else if(0===M.cwd.indexOf("argv")){const e=M.cwd.split("."),t=parseInt(e[1]);if(isNaN(t))throw[P("32",{details:`The working directory setting has error(s): Current value: ${M.cwd}. Please contact the web admin to correct the task's working directory.`})];if(!M.arguments[t]||"inFile"!==M.arguments[t].type||"Folder"!==M.arguments[t].format)throw[P("32",{details:`The working directory setting has error(s): Current value: ${M.cwd}. Please contact the web admin to correct the task's working directory.`})];C.cwd=C.arguments[t].inFile}if(Q.length>0)for(let e=0;e<Q.length;e++){const t=Q[e];await p.ensureDir(t)}C.env=B,C.extDirs=z,await C.save(),_.results.push(C.id),await _.save();const ee=new m({result:C.id,user:s,project:k,taskName:M.name,projectName:_.name,projectDesc:_.desc,title:C.name,desc:C.desc,prefix:C.prefix,suffix:C.suffix,status:0,timer:[new Date]});await ee.save();const te=await c.findOne({_id:C.id}).populate("owner outFiles inFiles task");if(!te)throw[P("35",{details:`We can not find the result id: ${te.id}. please check if this is the right ID.`})];const ae=te.getModel();a.success=ae,t.json(a),A(_.getListeners(),"dataChange",{type:"insert",target:"Result",data:ae}),await f(800),await T.addToQueue({id:C.id,command:C.command,commandArgs:C.commandArgs,cwd:C.cwd,type:C.type,owner:C.owner,project:C.project,env:C.env||{},extDirs:C.extDirs||[]})}))),_.get("/api/result/:resultId/resume",I((async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.resultId;if(!i.Types.ObjectId.isValid(s))throw[P("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const o=await j(a,"bdp",2),p=await c.findOne({_id:s}).populate("owner inFiles outFiles");if(!p)throw[P("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];if(p.status<=1)throw[P("32",{details:`We can not resume the Task for the result (id: ${s}).`})];const h=await l.findOne({_id:p.project});if(!h)throw[P("19",{details:"We can not find the project for this result, please check if this is the right ID."})];if(!h.getPrivilege(o).canRun)throw[P("38",{details:"Sorry, you do not have privilegs to view results in this project."})];if(!p.task)throw[P("711",{details:"Sorry, the task might have been removed."})];const g=await r.findOne({_id:p.task});if(!g)throw[P("19",{details:"Sorry, the task does not exist."})];const w=await u.findOne({_id:g.package});if(!w)throw[P("19",{details:"We can not find the package of the task."})];const y=p;let k,S,O,I,F,D=!1;g.proxy&&g.proxy.enabled&&(k=g.proxy.port||void 0,S=g.proxy.ip||void 0,O=g.proxy.protocol||void 0,I=!!g.proxy.pathRewrite,F=g.proxy.entryPath||void 0,D=!0);const $={PROJECT_FOLDER:n.resolve(v,h.id),SHARED_FOLDER:n.resolve(v,"shared"),PACKAGE_FOLDER:n.resolve(w.path),TASK_ID:g.id,TASK_KEY:g.key,TASK_NAME:d(g.name,{condense:!0}),TASKLOG_FOLDER:b,DOCKER_PATH:x,BDP_HOST_PORT:k,BDP_PROXY_ENABLED:D,BDP_PROXY_PROTOCOL:O,BDP_PROXY_IP:S,BDP_PROXY_PORT:k,BDP_PROXY_PATHREWRITE:I,BDP_PROXY_ENTRYPATH:F,ARG_ENCODING:g.encodeArg?"base64":void 0,RESULT_ID:y._id.toString()},_=g.arguments.filter((e=>"inFile"===e.type&&!e.optional)),M=p.inFiles.filter((e=>!!e));if(_.length>M.length)throw[P("711",{name:"Input file number inconsistency",details:`The task require ${_.length} input files, but the previous run only has ${M.length} files.Please check if some files were removed or the task arguments were changed.`})];const E={},C={},N=[];M.forEach((e=>{1===e.status&&(E[e.id]=e.path,e.realPath&&N.push(e.realPath),C[e.id]=e)}));const R=g.outputProvider(),L=p.outFiles.filter((e=>!!e));if(R.length!==L.length)throw[P("711",{name:"Output file inconsistency",details:"The task outputs "+R.length+" file records(s), but the previous run expects "+L.length+" record(s). Please check if some output records were removed or the task arguments were changed."})];p.status="workflow"===g.type?1:0,p.timer=[new Date],p.env=$,p.extDirs=N,await p.save();const q=new m({result:y.id,user:a,project:h.id,taskName:g.name,projectName:h.name,projectDesc:h.desc,title:y.name,prefix:y.prefix,suffix:y.suffix,desc:y.desc,status:0,timer:[new Date]});await q.save();const V=p.getModel();return A(h.getListeners(),"dataChange",{type:"update",target:"Result",data:V}),await f(300),y.env=$,y.extDirs=N,await T.addToQueue({id:y.id,command:y.command,commandArgs:y.commandArgs,cwd:y.cwd,type:y.type,owner:y.owner,project:y.project,env:y.env||{},extDirs:y.extDirs||[]}),t.success=V,t}))),_.get("/api/:resultId",I((async e=>{const t=e.session.passport.user.id,a=e.params.resultId;if(!i.Types.ObjectId.isValid(a))throw[P("35",{details:`We can not find the result id: ${a}. please check if this is the right ID.`})];const s=await j(t,"bdp",2),r=await c.findOne({_id:a}).populate("owner inFiles outFiles task");if(!r)throw[P("35",{details:`We can not find the result id: ${a}. please check if this is the right ID.`})];const o=await l.findOne({_id:r.project});if(!o)throw[P("19",{details:"We can not find the project for this result, please check if this is the right ID."})];const n=o.getPrivilege(s);if(!n.canView)throw[P("38",{details:"Sorry, you do not have privilegs to view results in this project."})];if(1===r.status){const e=await T.getCurrentStdOutput(r.id);e&&(r.stdOut=e.stdOut||r.stdOut,r.stdErr=e.stdErr||r.stdErr)}return{success:r.getModel(n),errors:[]}}))),_.patch("/api/:resultId",I((async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.resultId,r=e.body.name,o=e.body.desc,n=e.body.prefix||"",d=e.body.suffix||"";if(!i.Types.ObjectId.isValid(s))throw[P("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const p=await j(a,"bdp",2),u=await c.findOne({_id:s}).populate("owner");if(!u)throw[P("35",{details:`We cannot find the result id: ${s}. please check if this is the right ID.`})];const h=await l.findOne({_id:u.project}),g=h.getPrivilege(p);if(!g.canEditResult)throw[P("38",{details:"Sorry, you do not have privileges to edit results in this project."})];if(g.isRunner&&(!u.owner||u.owner.id!==a))throw[P("38",{details:"Sorry, you can only update information of your own Results. This Result is not created by you."})];if(r.length>160)throw[P("36")];if(o.length>1e3)throw[P("37")];u.name=r||u.name,u.desc=o||u.desc,u.prefix=n.slice(0,36),u.suffix=d.slice(0,36),await u.save();const f=await c.findOne({_id:u.id}).populate("owner outFiles inFiles task");return t.success=f.getModel(),A(h.getListeners(),"dataChange",{type:"update",target:"Result",data:t.success}),t}))),_.get("/api/:resultId/stop",I((async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,r=e.params.resultId;if(!i.Types.ObjectId.isValid(r))throw[P("35",{details:`We can not find the result id: ${r}. please check if this is the right ID.`})];const o=await j(s,"bdp",2),n=await c.findOne({_id:r}).populate("owner outFiles inFiles task");if(!n)throw[P("35",{details:`We can not find the result id: ${r}. please check if this is the right ID.`})];const d=(await l.findOne({_id:n.project})).getPrivilege(o);if(!d.canRun)throw[P("38",{details:"Sorry, you do not have privileges to stop tasks in this project."})];if(d.isRunner&&(!n.owner||n.owner.id!==s))throw[P("38",{details:"Sorry, you can only stop the task of your own Result. This Result is not created by you."})];a.success=n.getModel(),t.json(a);try{await $(n)}catch(e){console.log(e)}return!1}))),_.post("/api/:projectId/batchStopResult",I((async(e,t)=>{const a=e.session.passport.user.id,s=e.params.projectId,r=e.body.resultIDs||[];if(!i.Types.ObjectId.isValid(s))throw[P("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(0===r.length)throw[P("709",{type:"warning",details:"No tasks to stop."})];if(r.filter((e=>!i.Types.ObjectId.isValid(e))).length>0)throw[P("709",{type:"warning",details:"There are invalid result ids in your request."})];const o=await j(a,"bdp",2),n=await l.findOne({_id:s});if(!n)throw[P("19",{details:"We can not find the project for this data file please check if this is the right ID."})];const d=n.getPrivilege(o);if(!d.canRun)throw[P("38",{details:"Sorry, you do not have privileges to stop tasks in this project."})];const p={project:s,_id:{$in:r},status:1};d.isRunner&&(p.owner=a);const u=await c.find(p).populate("owner outFiles inFiles task");t.json({success:u.map((e=>e.getModel())),errors:[]});try{const e=[];for(const t of u)e.push($(t).catch(console.log)),e.length>30&&(await Promise.all(e).catch(console.log),e.length=0);await Promise.all(e).catch(console.log)}catch(e){console.log(e)}return!1}))),_.delete("/api/:resultId",I((async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,r=e.params.resultId;if(!i.Types.ObjectId.isValid(r))throw[P("35",{details:`We can not find the result id: ${r}. please check if this is the right ID.`})];const o=await j(s,"bdp",2),n=await c.findOne({_id:r}).populate("owner outFiles inFiles task");if(!n)throw[P("35",{details:`We can not find the result id: ${r}. please check if this is the right ID.`})];const d=(await l.findOne({_id:n.project})).getPrivilege(o);if(!d.canDeleteResult)throw[P("38",{details:"Sorry, you do not have privileges to delete results in this project."})];if(d.isRunner&&(!n.owner||n.owner.id!==s))throw[P("38",{details:"Sorry, you can only delete your own Result. This Result is not created by you."})];return n.readOnly=!0,n.status=4,a.success=n.getModel(),t.json(a),await D(n),!1}))),_.post("/api/:projectId/batchRemoveResult",I((async(e,t)=>{const a=e.session.passport.user.id,s=e.params.projectId,r=e.body.resultIDs||[];if(!i.Types.ObjectId.isValid(s))throw[P("19",{details:`We can not find the project id: ${s}. please check if this is the right ID.`})];if(0===r.length)throw[P("709",{type:"warning",details:"No tasks to stop."})];if(r.filter((e=>!i.Types.ObjectId.isValid(e))).length>0)throw[P("709",{type:"warning",details:"There are invalid result ids in your request."})];const o=await j(a,"bdp",2),n=await l.findOne({_id:s});if(!n)throw[P("19",{details:"We can not find the project for this data file please check if this is the right ID."})];const d=n.getPrivilege(o);if(!d.canDeleteResult)throw[P("38",{details:"Sorry, you do not have privileges to remove results in this project."})];const p={project:s,_id:{$in:r}};d.isRunner&&(p.owner=a);const u=await c.find(p).populate("owner outFiles inFiles task");u.forEach((e=>{e.readOnly=!0,e.status=4})),t.json({success:u.map((e=>e.getModel())),errors:[]});for(const e of u)await D(e);return!1}))),w.on("proxyReq",(function(e,t,a){const s=a.get("needPathRewrite"),i=t.originalUrl.match(/^\/result\/(.*?)\/proxy/);if("true"===s&&i){const a=i[1];e.path=t.originalUrl.replace(`/result/${a}/proxy`,"")}else e.path=t.originalUrl;const r=e.getHeader("Content-Type");if(t.body&&r)if(r&&r.indexOf("application/x-www-form-urlencoded")>=0){const a=Object.keys(t.body).map((e=>`${encodeURIComponent(e)}=${encodeURIComponent(t.body[e])}`)).join("&");e.setHeader("Content-Length",Buffer.byteLength(a)),e.write(a)}else if(r.indexOf("application/json")>=0){const a=JSON.stringify(t.body);e.setHeader("Content-Type","application/json"),e.setHeader("Content-Length",Buffer.byteLength(a)),e.write(a)}})),w.on("proxyRes",(function(e,t){let a="";const s=e.headers.location;if(e.headers["X-Frame-Options"]="SAMEORIGIN",e.headers["Content-Security-Policy"]="frame-ancestors 'self'",e.headers["Referrer-Policy"]="same-origin always",s&&(0===s.indexOf("http")||0===s.indexOf("https"))){const i=t.originalUrl.match(/^\/result\/(.*?)\/proxy/);a=URL?new URL(s):g.parse(s);const r=`${h.site_domain}:${h.port}/result/${i[1]}/proxy`;a.pathname&&s.indexOf(r+"/")<=0&&(e.headers.location=r+a.pathname+a.search+a.hash)}})),w.on("error",(function(e){console.log("Proxy Error")})),y&&y.on("upgrade",(function(e,t,s){e.url&&"/"!==e.url&&a(e,{},(()=>{try{var a;if(null===(a=e.session.passport)||void 0===a||!a.user)throw"Uninitialized session";if(!e.session.passport.user.id)throw"Unauthorized";const i=e.url.match(/\/result\/(.*)\/proxy/);if(i&&i[1]){let[a,r]=i[1].split("/");(async()=>{if(r||(r=await O.getFirstProxyJobId(a)),!r)throw`The resultId ${a} does not have jobs that need web proxy.`;const o=await k.getProxyObj(a,r);if(!o)throw"No proxy settings";o.pathRewrite?(e.url=e.url.replace(`/result/${i[1]}/proxy`,""),console.log(e.url),w.ws(e,t,s,{target:`${"https"===o.protocol?"wss":"ws"}://${o.ip}:${o.port}`,autoRewrite:!0},(e=>{console.log(e)}))):w.ws(e,t,s,{target:`${"https"===o.protocol?"wss":"ws"}://${o.ip}:${o.port}`},(e=>{console.log(e)}))})().catch((e=>{t.write("HTTP/1.1 401 Unauthorized\r\n\r\n"),t.destroy()}))}}catch(e){t.write("HTTP/1.1 401 Unauthorized\r\n\r\n"),t.destroy()}}))})),_.all("/:resultId/:jobId?/proxy/*",I((async(e,t)=>{const a=e.session.passport.user.id,s=e.params.resultId;let r=e.params.jobId;if(!i.Types.ObjectId.isValid(s))throw[P("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const o=await j(a,"bdp",2),n=await c.findOne({_id:s}).populate("task");if(!n)throw[P("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];if(!(await l.findOne({_id:n.project})).getPrivilege(o).canView)throw[P("38",{details:"Sorry, you do not have privileges to view this Page in this project."})];if(r||(r=await O.getFirstProxyJobId(s)),!r)throw[P("35",{details:`The resultId ${s} does not have jobs that configured for web proxy.`})];const d=await k.getProxyObj(s,r);if(!d)throw[P("501",{details:"We cannot do the web proxy because there is no proxy settings for this Result's task."})];if(!d)throw[P("501",{details:`Sorry, the web proxy has NOT been set for this result. Please try the endpoint '/result/${s}/requestProxy' first.`})];t.set("needPathRewrite",d.pathRewrite),w.web(e,t,{target:`${d.protocol}://${d.ip}:${d.port}/`,autoRewrite:!0,cookieDomainRewrite:`${d.ip}:${d.port}`,ws:!0,changeOrigin:!0,preserveHeaderKeyCase:!0,debug:!0},(function(e){t.write(JSON.stringify(e))}))}))),_.get("/:resultId/:jobId?/requestProxy",I((async(e,t)=>{const a=e.session.passport.user.id,s=e.params.resultId;let r=e.params.jobId;if(!i.Types.ObjectId.isValid(s))throw[P("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const o=await j(a,"bdp",2),n=await c.findOne({_id:s}).populate("task");if(!n)throw[P("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];if(n.task||(n.task={}),!(await l.findOne({_id:n.project})).getPrivilege(o).canView)throw[P("38",{details:"Sorry, you do not have privileges to stop tasks in this project."})];if("workflow"===n.type)throw[P("501",{details:"We cannot proxy the workflow tasks."})];if(1!==n.status&&null===n.task.proxy)throw[P("501",{details:"This is an invalid result to make the proxy."})];if(r||(r=await O.getFirstProxyJobId(s)),!r)throw[P("35",{details:`The resultId ${s} does not have jobs that configured for web proxy.`})];const d=await k.getProxyObj(s,r);if(!d)throw[P("501",{details:"We cannot do the web proxy because there is no proxy settings for this Result's task."})];try{const e=d.entryPath||"/",t=new URL(`http://${d.ip}${e}`);proxyEntryPath=`${t.pathname}${t.search}${t.hash}`}catch(e){A(a,"message",P("501",{details:"The proxy entry path is invalid. We redirect page to the proxy root."}))}return t.redirect(`/result/${s}${r?"/"+r:""}/proxy${proxyEntryPath}`)}))),_.get("/api/:resultId/taskLog",I((async(e,t)=>{const a=e.session.passport.user.id,s=e.params.resultId,r=e.query.jobID,o=e.query.stdoe;if(!i.Types.ObjectId.isValid(s))throw[P("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const d=await j(a,"bdp",2),u=await c.findOne({_id:s}).populate("owner outFiles inFiles task");if(!u)throw[P("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];if(!(await l.findOne({_id:u.project})).getPrivilege(d).canView)throw[P("38",{details:"Sorry, you do not have privileges to stop tasks in this project."})];if("workflow"===u.type)throw[P("710",{details:"Workflow does not have task logs."})];let h="index.txt",g="",f=!1;if(r&&["stdout","stderr"].indexOf(o)>=0){if(g=n.resolve(b,s,h),f=await p.pathExists(g),!f&&(h="progress-index.txt",g=n.resolve(b,s,h),f=await p.pathExists(g),!f))throw[P("710",{details:"Sorry, we cannot find the task log index for this result."})];h=await F(g,r,o);let e=await p.pathExists(h);if(!e){const t=await F(g,r,"taskName");if(h=n.join(b,s,t,`${r}-${o}.txt`),e=await p.pathExists(h),!e)throw[P("710",{details:`Sorry, the ${o} file may have not been created for this result.`})]}t.setHeader("Content-type","text/plain"),t.sendFile(h)}else{let e=n.resolve(b,s,h);if(!await p.pathExists(e)&&(h="progress-index.txt",e=n.resolve(b,s,h),!await p.pathExists(e)))throw[P("710",{details:"Sorry, we cannot find the task logs for this result."})];t.sendFile(e)}return!1}))),_.get("/api/:resultId/proxyJobs",I((async(e,t)=>{const a=e.session.passport.user.id,s=e.params.resultId;if(!i.Types.ObjectId.isValid(s))throw[P("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];const r=await j(a,"bdp",2),o=await c.findOne({_id:s});if(!o)throw[P("35",{details:`We can not find the result id: ${s}. please check if this is the right ID.`})];if(!(await l.findOne({_id:o.project})).getPrivilege(r).canView)throw[P("38",{details:"Sorry, you do not have privileges to list the related proxy pages."})];try{return{success:await O.getProxyJobListByResultId(s),errors:[]}}catch(e){return{success:[],errors:[e]}}}))),_}},4325:(e,t,a)=>{const s=a(2127),i=a(2335),r=a(7537),o=a(5057).spawnProcessAsync,n=["@big-data-processor/utilities","@big-data-processor/task-reader","@hapi/iron","archiver","babel-runtime","body-parser","compression","connect-mongo","content-disposition","cookie-parser","cors","dashify","detect-port","express","express-session","express-status-monitor","filenamify","find-package-json","fluent-ffmpeg","fs-extra","globby","googleapis","greenlock-express","helmet","http-proxy","js-yaml","mime-types","mongoose","morgan","multer","natural-orderby","nodemailer","passport","passport-google-oauth20","passport-local","path-is-inside","request","sanitize-filename","serve-index","ws","unzipper","uuid"];e.exports=function(e){const t=e.chiConfig,a=e.helpers,d=a.chiAsyncWrap,c=a.getCode,l=a.viewNpmPkg,p=a.getAuthAsync,u=a.socketBroadcast,h=s.Router();h.get("/api/info",d((async(e,a)=>{a.json({errors:[],success:{admin_email:t.serverConfig.admin_email,reCaptchaSiteKey:t.reCaptcha?t.reCaptcha.reCaptchaSiteKey:void 0,dropboxKey:t.Dropbox?t.Dropbox.appKey:void 0,googleClientID:t.GoogleAuth?t.GoogleAuth.clientID:void 0,googlePickerAPIKey:t.GooglePicker&&t.GooglePicker.apiKey?t.GooglePicker.apiKey:void 0,home:t.home?t.home:{},fileLimits:t.system.fileLimits.toString()}})}))),h.all("/api/*",((e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(c("a011")),t.json(s);a()})),h.get("/api/npmpkg/list",d((async e=>{const t={errors:[],success:{}},a=e.session.passport.user.id;await p(a,"base",9);const s=i(process.env.BDP_SYSTEM_FOLDER).next().value||null;return t.success=s&&s.dependencies?s.dependencies:{},t}))),h.get("/api/module/list",d((async e=>{const t={errors:[],success:{}},a=e.session.passport.user.id;await p(a,"bdp",7);let s=await r.findOne({name:"big-data-processor"});return s||(s=new r({name:"big-data-processor",modules:[]}),await s.save()),t.success=s.getModel().modules,t}))),h.get("/api/npmpkg/view",d((async e=>{const t={errors:[],success:{}},a=e.query.pkgName,s=e.query.pkgVersion,i=e.session.passport.user.id;if(await p(i,"base",9),t.success=await l(a,s),!t.success.pkgInfo)throw[c("s004",{details:`We cannot find the npm package (${a}).`})];return t})));const g=async function(e,t,a){const s={stdout:"",stderr:""},i=function(a,i){s[a]+=i,u(e,"packageOut",{type:"stdout"===a?"stdOut":"stdErr",target:t,data:s[a]})};let r=0;try{r=0===(await o("npm",["install","--save",`${t}@${a}`],"install-npm-pkg",{mode:"memory"},i)).exitCode?2:1}catch(e){console.log(e),r=1}return{stdout:s.stdout,stderr:s.stderr,status:r}};h.get("/api/npmpkg/install",d((async(e,t)=>{const a={errors:[],success:{}},s=e.query.pkgName,i=e.query.pkgVersion,o=e.session.passport.user.id;await p(o,"base",9);const d=await l(s,i);if(!d.pkgInfo)throw[c("s004",{details:`We cannot find the npm package (${s}).`})];if("@big-data-processor/task-reader"!==s&&n.indexOf(s)>=0)throw[c("s004",{details:`The npm package ${s} is required. You cannot install it.`})];let h="npm";if(d.bdp){const e=d.bdp.type;"adapter"===e?h="adapter":"filter"===e&&(h="filter")}n.indexOf(s)>=0&&(h="system");let f=await r.findOne({name:"big-data-processor"});f||(f=new r({name:"big-data-processor",modules:[]}));let m=-1;for(let e=0;e<f.modules.length;e++)if(f.modules[e].pkgName===s){m=e;break}if(m<0)f.modules.push({name:d.bdp?d.bdp.name:d.pkgInfo.name,pkgName:s,moduleType:h,author:d.pkgInfo.author,email:d.pkgInfo.email,desc:d.pkgInfo.description,version:d.pkgInfo.version,status:0,stdout:"",stderr:""}),m=f.modules.length-1;else{const e=f.modules[m];e.name=d.bdp?d.bdp.name:d.pkgInfo.name,e.moduleType=h,e.author=d.pkgInfo.author,e.email=d.pkgInfo.email,e.desc=d.pkgInfo.description,e.status=0,e.stdout="",e.stderr=""}const w=await f.save();a.success=w.getModel(),u(o,"dataChange",{type:"module",target:"System",data:a.success.modules}),t.json(a);const y=await g(o,s,d.pkgInfo.version);try{const e=f.modules[m];e.name=d.bdp?d.bdp.name:d.pkgInfo.name,e.version=d.pkgInfo.version,e.moduleType=h,e.author=d.pkgInfo.author,e.email=d.pkgInfo.email,e.desc=d.pkgInfo.description,e.status=y.status,e.stdout=y.stdout,e.stderr=y.stderr;const t=await f.save();u(o,"dataChange",{type:"module",target:"System",data:t.getModel().modules})}catch(e){console.log(e)}}))),h.get("/api/npmpkg/uninstall",d((async(e,t)=>{const a={errors:[],success:{}},s=e.query.pkgName,d=e.session.passport.user.id;if(await p(d,"base",9),n.indexOf(s)>=0)throw[c("s004",{details:`The npm package ${s} is required. You cannot uninstall it.`})];const l=i(__dirname).next().value||null,h=l&&l.dependencies?l.dependencies:{};let g=await r.findOne({name:"big-data-processor"});if(g){let e=-1;for(let t=0;t<g.modules.length;t++)if(g.modules[t].pkgName===s){e=t;break}e>=0&&(h[s]?g.modules[e].status=3:g.modules.splice(e,1))}else g=new r({name:"big-data-processor",modules:[]});const f=await g.save();if(a.success=f.getModel(),t.json(a),!h[s])return;const m={stdout:"",stderr:""},w=function(e,t){m[e]+=t,u(d,"packageOut",{type:"stdout"===e?"stdOut":"stdErr",target:s,data:m[e]})};let y=!1;try{if(0===(await o("npm",["uninstall","--save",`${s}`],"uninstall-npm-pkg",{mode:"default"},w)).exitCode){for(let e=0;e<g.modules.length;e++)if(g.modules[e].pkgName===s){g.modules.splice(e,1);break}}else y=!0}catch(e){y=!0}if(y)for(let e=0;e<g.modules.length;e++)if(g.modules[e].pkgName===s){g.modules[e].status=1,g.modules[e].stdout=m.stdout,g.modules[e].stderr=m.stderr;break}const k=await g.save();u(d,"dataChange",{type:"module",target:"System",data:k.getModel().modules})})));let f=!1;return h.get("/api/npmpkg/restore",d((async(e,t)=>{const a={errors:[],success:{}},s=e.session.passport.user.id;await p(s,"base",9);const o=(i(process.env.BDP_SYSTEM_FOLDER).next().value||null).dependencies||{};let n=await r.findOne({name:"big-data-processor"});n||(n=new r({name:"big-data-processor",modules:[]}));const d=await n.save();a.success=d.getModel(),t.json(a);const c=d.modules,l=[];if(f)u(s,"message",{code:"s004",name:"The package restoring is processing",type:"warning",details:"Please wait while we are reinstalling your packages."});else{f=!0;for(let e=0;e<c.length;e++){const t=c[e],a=t.pkgName;if(!o[a]){t.status=0,u(s,"dataChange",{type:"module",target:"System",data:n.getModel().modules}),await n.save();const e=await g(s,a,t.version);t.status=e.status,t.stdout=e.stdout,t.stderr=e.stderr,1===t.status&&l.push(t),await n.save(),u(s,"dataChange",{type:"module",target:"System",data:n.getModel().modules})}}u(s,"message",{code:"s004",name:l.length>0?"Failed to install some packages":"Finished restoring installed packages",type:l.length>0?"error":"success",details:l.length>0?`Several npm packages were failed to install: ${l.map((e=>e.pkgName)).join(", ")}`:"All previous installed packages were restored."}),f=!1}}))),h}},8078:(e,t,a)=>{const s=a(3129).fork,i=a(4032),r=a(6018),o=a(6092),n=a(703),d=a(4959),c=a(3464),l=a(4841),p=a(2087),u=a(571),h=a(4298),g=a(5622),f=a(8614),m=e=>{switch(e){case 0:return"st";case 1:return"nd";case 2:return"rd";default:return"th"}};e.exports=async function(e){const t=new Map,a={},w=new Set,y=new f,k=e.chiConfig,v=e.proxyStore,b=k.system.dataFilePath,x=k.system.scriptFolder,S=k.system.taskLogFolder,O=e.helpers,I=O.getCode,P=O.makeResultDeleted,j=O.socketBroadcast,F=O.getTaskByMap,T=new Set;let D=k.system.concurrentProcNumber,$=!1;const A=[],_=new Map,M=async e=>{y.emit(`job-exit-${e.resultId}`,{resultId:e.resultId,type:e.type})},E=async(e,s)=>{const i=await r.findOne({_id:s}).populate("owner inFiles outFiles task");if(i){const t=i.pid,s=a[t];(s||e)&&(s?(i.stdOut=s.stdOut||i.stdOut,i.stdErr=s.stdErr||i.stdErr):e&&(i.stdErr="Can not spawn the child process\n"+e.toString()),await i.save());const r=await d.findOne({_id:i.project}),o=r?r.getListeners():[];j(o,"resultOut",{type:"stdOut",target:i.project+":"+i.id,data:i.stdout}),j(o,"resultOut",{type:"stdErr",target:i.project+":"+i.id,data:i.stderr}),4===i.status?await P(i):await B(i,i.stdOut,i.stdErr,e),delete a[t]}t.delete(s),await o.updateOne({},{processing:[...t.keys()]}),j(null,"serverStatus",{queue:await G.getCurrentQueueNumber(),running:await G.getCurrentProcessNumber()}),M({resultId:s,type:"error"}).catch(console.log)},C=async()=>{try{if($)return;if(t.size>=D||A.length<=0)return void j(null,"serverStatus",{queue:await G.getCurrentQueueNumber(),running:await G.getCurrentProcessNumber()});const e=A.shift();if(t.has(e.id))return j(null,"serverStatus",{queue:await G.getCurrentQueueNumber(),running:await G.getCurrentProcessNumber()}),void C().catch(console.log);const i=await d.findOne({_id:e.project}),c=i?i.getListeners():[],f=await r.findOne({_id:e.id}).populate("owner");if(console.log(f?f.id:"cannot find result id: "+e.id),!f)return void await l.deleteRun(e.id);await l.startRun(f.id);const m=e.env;Object.keys(process.env).forEach((e=>m[e]=process.env[e])),m.EXTERNAL_FOLDERS=e.extDirs.join(","),m.TASKLOG_FOLDER=S,m.RESULT_ID=f.id;const w=await n.findOne({_id:f.task}).populate("package");let y;w&&(m.TASK_ID=w.id,m.TASK_NAME=u(w.name,{condense:!0}),m.ARG_ENCODING=w.encodeArg?"base64":void 0,w.package&&(m.PACKAGE_FOLDER=g.resolve(w.package.path))),await h.pathExists(e.cwd)||(e.cwd=p.tmpdir());try{const t=g.resolve(process.env.BDP_SYSTEM_FOLDER,"task-portal.js");y=s(t,e.args,{silent:!0,cwd:e.cwd,env:m,stdio:["pipe","pipe","pipe","ipc"]})}catch(t){return void E("Child process failed to spawn",e.id).then(C).catch((e=>console.log(e)))}a[y.pid]={stdOut:"",stdErr:""},y.on("message",(t=>{t&&"bdp-adapter"===t.source&&(async()=>{try{switch(t.action){case"registerProxy":try{const a=t.content;await v.register(a.ip,a.port,e.id,a.jobId,a.pathRewrite,a.protocol,a.entryPath)}catch(e){y.send({source:"bdp-server",action:"rejectProxy",content:Object.assign(t.content,{err:e})})}break;case"unregisterProxy":await v.unregister(e.id,t.content.jobId)}}catch(a){throw`Cannot Process the message: ${JSON.stringify(t)} from ResultId ${e.id}`}})().catch(console.log)})),y.stdout.on("readable",(()=>{const e=y.stdout.read();if(e){const t=e.toString(),s=a[y.pid];s&&(s.stdOut+=t,s.stdOut.length>=1e4&&(s.stdOut="...\n====== Skipped ======\n"+s.stdOut.slice(-1e4)),j(c,"resultOut",{type:"stdOut",target:f.project+":"+f.id,data:s.stdOut}))}})),y.stderr.on("readable",(()=>{const e=y.stderr.read();if(e){const t=e.toString(),s=a[y.pid];s&&(s.stdErr+=t,s.stdErr.length>=1e4&&(s.stdErr="...\n====== Skipped ======\n"+s.stdErr.slice(-1e4)),j(c,"resultOut",{type:"stdErr",target:f.project+":"+f.id,data:s.stdErr}))}}));const k=await r.findOneAndUpdate({_id:e.id},{pid:y.pid,status:1,$push:{timer:new Date}},{new:!0}).populate("owner inFiles outFiles task");k&&(j(c,"dataChange",{type:"update",target:"Result",data:k.getModel()}),j(null,{queue:await G.getCurrentQueueNumber(),running:await G.getCurrentProcessNumber()})),y.on("error",(t=>{console.log("process error:"+y.pid),console.log(t),E(t,e.id).then(C).catch(console.log)})),y.on("exit",((s,i)=>{console.log("process exiting: "+s+"-"+i),(async()=>{await v.unregisterByResultId(e.id),t.has(e.id)&&(0!==s?await E("Exit code is not 0.",e.id):await(async(e,s,i)=>{const n=await r.findOne({_id:i}).populate("owner inFiles outFiles task");if(n){const t=n.pid,i=a[t];if(i){n.stdOut=i.stdOut||n.stdOut,n.stdErr=i.stdErr||n.stdErr,await n.save();const e=await d.findOne({_id:n.project}),t=e?e.getListeners():[];j(t,"resultOut",{type:"stdOut",target:n.project+":"+n.id,data:n.stdOut}),j(t,"resultOut",{type:"stdErr",target:n.project+":"+n.id,data:n.stdErr})}if(4===n.status)await P(n);else if(0!==e||s){const t={code:e,signal:s};await B(n,n.stdOut,n.stdErr,t)}else await W(n,n.stdOut,n.stdErr);delete a[t]}t.delete(i),await o.updateOne({},{processing:[...t.keys()]}),j(null,"serverStatus",{queue:await G.getCurrentQueueNumber(),running:await G.getCurrentProcessNumber()}),M({resultId:i,type:0==e?"finish":"error"}).catch(console.log)})(s,i,e.id))})().then(C).catch(console.log)})),t.set(e.id,{model:f,process:y}),await o.updateOne({},{processing:[...t.keys()],taskQueue:A}),j(null,"serverStatus",{queue:await G.getCurrentQueueNumber(),running:await G.getCurrentProcessNumber()}),C().catch(console.log)}catch(e){console.log(e)}},N=async e=>e?(e=e.toString(),_.get(e)||null):null,R=async e=>{e&&e.id&&(_.set(e.id.toString(),e),await o.updateOne({},{workflowProcess:Object.fromEntries(_)}))},L=async(e,t,a)=>{e=e.toString(),t=t.toString();const s=await N(e);if(!s)return"failed";const i=s.progress,r=s.mapper[i],o=s.results[i],n=s.resultStatus[i];for(let e=0;e<o.length;e++)if(o[e]===t){s.resultStatus[i][e]=parseInt(a);break}const d={success:0,failed:0};for(let e=0;e<n.length;e++)2==n[e]?d.success++:n[e]&&n[e]>=3&&d.failed++;const c=r.length;return d.success+d.failed>=c?d.success>=c?(s.progress++,await R(s),s.progress<s.mapper.length?"nextStep":"success"):(await R(s),"failed"):(await R(s),"unfinished")},q=async e=>{_.delete(e),await o.updateOne({},{workflowProcess:Object.fromEntries(_)})},V=async e=>{try{const t=await N(e);if(!t)return void console.log(`Failed to get the workflow item with the id ${e}`);const a=t.progress,s=t.id,o=t.mapper[a],n=t.user,l=t.project,p=await d.findOne({_id:l}),f=p?p.getListeners():[],m=await c.findOne({_id:n});if(!p)return console.log("Cannot find the project, the workflow will be deleted!"),void await q(s);const w=[],k=await r.findOne({_id:s}).populate("owner inFiles outFiles task"),v=k.children,S=v[a];t.results[a]=v[a]||[],Array.isArray(t.resultStatus[a])||(t.resultStatus[a]=[]);let O={};const I=k.prefix||"",P=k.suffix||"";for(let e=0;e<o.length;e++){const d=o[e],c=await F(d);if(null===c){console.log("Cannot find the task by the task mapper object: "),console.log(d),t.resultStatus[a][e]=3,await B(k,"","Cannot find the task by the task mapper object: \n"+JSON.stringify(d,void 0,4));break}c.package||(t.resultStatus[a][e]=3,await B(k,"","Cannot find the task's package by the task mapper object: \n"+JSON.stringify(d,void 0,4))),c.package.getPrivilege(m).canRun||await B(k,"",`You have no privileges to execute the task, ${c.name}, at the step ${a}-${e+1}`);const v=c.getModel();let T,D;if(v.package=c.package.id,O=c.arguments,S&&S[e]&&(T=await r.findOne({_id:S[e]}),T.parent.toString()===s&&2===T.status)){t.results[a][e]=T.id,t.resultStatus[a][e]=2,T.arguments.forEach(((s,i)=>{const r=Object.keys(s)[0];t.argValues[a][e][i]=s[r]})),await R(t),y.emit("taskFinished",T);continue}D=new r({name:c.name,desc:c.desc,type:"child",task:c.id,taskSnapshot:v,parent:t.id,project:l,owner:n,script:c.script,cwd:c.cwd,status:0,readOnly:!1,timer:[new Date],inFiles:[],outFiles:[],arguments:[],prefix:I,suffix:P});const $=[];for(let s=0;s<O.length;s++){const i=O[s];D.arguments[s]={};const r=i.type;if("static"===r){D.arguments[s][r]=i.default[0];continue}const n=o[e].args[s].split(".");let d;if("argv"===n[0]){if(void 0===t.args[+n[1]])return void await B(k,"",`The workflow has undefined argument of position ${n[1]}. \n                Probably, the task has been updated so the argument does not match. This result cannot be resumed. \n                Please execute another NEW Task instead of resume this result.`);d=null==t.args[+n[1]][r]?t.args[+n[1]].static:t.args[+n[1]][r],t.argValues[a][e][s]=d,D.arguments[s][r]="outFile"===i.type&&"name"===i.outFolderStyle?g.basename(d):d}else if("map"===n[0]){try{d=t.argValues[+n[1]][+n[2]][+n[3]]}catch(e){return void await B(k,"","The task mapper may be updated. This result cannot be resumed. Please execute another NEW task instead of resume this result.")}t.argValues[a][e][s]=d,D.arguments[s][r]=d}"inFile"===r&&d&&$.push(d)}const A=[],_=await i.find({project:l,path:{$in:$}}),M={};_.forEach((e=>{D.inFiles.push(e.id),M[e.path]=e.id,e.realPath&&A.push(e.realPath)}));const E=c.outputProvider(),C=[],N=[],L={};let q=0;for(let s=0;s<E.length;s++){const r=E[s].index;if(L[E[s].index]=s,"outFile"===o[e].args[r].split(".")[0]){const o=new i(E[s]);if(E[s].dependOn&&E[s].default){let i="";const r=E[s].dependOn.split(".");if("argv"!==r[0]){console.log("Error");continue}{const n=c.arguments[+r[1]];if("outFile"===n.type&&"Folder"===n.format){const e=C[L[+r[1]]];if(!e)continue;i=e.path,o.parent=e.id}else"inFile"===n.type&&"Folder"===n.format&&(i=t.argValues[a][e][+r[1]],o.parent=M[i]);E[s].default.indexOf("{$FolderName}")>=0&&(E[s].default=E[s].default.replace(/\{\$FolderName\}/g,g.basename(i))),o.path=g.resolve(i,E[s].default)}}else o.path=g.resolve(`${b}/${l}/${o.id}`);"Folder"!==o.format&&(o.path+="."+o.format),E[s].outPreFolder&&"Folder"===E[s].format&&N.push(o.path),o.owner=m,o.project=l,o.result=D.id,o.hidden=!0,o.prefix=I,o.suffix=P,D.outFiles[q]=o.id,q++,C[s]=o,t.argValues[a][e][r]=o.path,"Folder"===o.format&&"name"===E[s].outFolderStyle&&"$ProjectFolder"===c.cwd?D.arguments[r]={outFile:g.basename(o.path)}:("Folder"===o.format&&E[s].outFolderStyle,D.arguments[r]={outFile:o.path})}}const V=c.compose(D.arguments,c.package.path,t.env.PROJECT_FOLDER,x);if(D.command=V.command,D.commandArgs=V.commandArgs,T){D=T,D.status=0,D.timer=[new Date],D.arguments.forEach(((s,i)=>t.argValues[a][e][i]=s[Object.keys(s)[0]]));const s=c.compose(D.arguments,c.package.path,t.env.PROJECT_FOLDER,x);D.command=s.command,D.commandArgs=s.commandArgs}else{const e=C.filter((e=>e)).map((e=>(p.dataFiles.push(e.id),e.save())));for(let t=0;t<e.length;t++)await e[t],C[t]&&C[t].getModel&&j(f,"dataChange",{type:"insert",target:"DataFile",data:C[t].getModel()})}if("$ProjectFolder"===c.cwd)D.cwd=b+"/"+p.id;else if(c.cwd.match(/^\$ScriptFolder/))D.cwd=g.resolve(c.cwd.replace(/^\$ScriptFolder/,x));else if(0===c.cwd.indexOf("argv")){const e=c.cwd.split("."),t=parseInt(e[1]);if(isNaN(t))return await D.save(),void y.emit("taskError",D);if(!c.arguments[t]||"inFile"!==c.arguments[t].type||"Folder"!==c.arguments[t].format)return await D.save(),void y.emit("taskError",D);D.cwd=D.arguments[t].inFile}if(N.length>0){const e=[];for(let t=0;t<N.length;t++){const a=N[t];try{await h.ensureDir(a)}catch(t){e.push(t)}}if(e.length>0)return await D.save(),void y.emit("taskError",D)}let W,z,U,J,Y,H=!1;c.proxy&&c.proxy.enabled&&(W=c.proxy.port||void 0,z=c.proxy.ip||void 0,U=c.proxy.protocol||void 0,J=!!c.proxy.pathRewrite,Y=c.proxy.entryPath||void 0,H=!0),D.env={PROJECT_FOLDER:t.env.PROJECT_FOLDER,SHARED_FOLDER:g.resolve(b,"shared"),PACKAGE_FOLDER:c.package?c.package.path:t.env.PACKAGE_FOLDER,TASK_ID:c.id,TASK_KEY:c.key,TASK_NAME:u(c.name,{condense:!0}),DOCKER_PATH:t.env.DOCKER_PATH,RESULT_ID:D.id,BDP_SYSTEM_FOLDER:process.env.BDP_SYSTEM_FOLDER,BDP_HOST_PORT:W,BDP_PROXY_ENABLED:H,BDP_PROXY_PROTOCOL:U,BDP_PROXY_IP:z,BDP_PROXY_PORT:W,BDP_PROXY_ENTRYPATH:Y,BDP_PROXY_PATHREWRITE:J,ARG_ENCODING:c.encodeArg?"base64":void 0},D.extDirs=A,Array.isArray(t.results[a])||(t.results[a]=[]),t.results[a][parseInt(e)]=D.id,t.resultStatus[a][parseInt(e)]=0,await D.save();const K=await r.findOne({_id:D.id}).populate("owner outFiles inFiles task project"),Q=K.getModel(K.project.getPrivilege(m));j(f,"dataChange",{type:"insert",target:"Result",data:Q}),await R(t),await G.addToQueue({id:D.id,parent:D.parent,command:D.command,commandArgs:D.commandArgs,cwd:D.cwd,type:D.type,owner:D.owner,project:D.project,env:D.env||{},extDirs:D.extDirs||[]}),w.push(D.id)}const T=await r.findOneAndUpdate({_id:t.id},{children:t.results},{new:!0}).populate("owner outFiles inFiles task");T&&j(f,"dataChange",{type:"update",target:"Result",data:T.getModel()}),p.results.push.apply(p.results,w),await p.save()}catch(e){console.log(e)}};y.on("taskFinished",(e=>{e&&e.parent&&async function(){let t;switch(await L(e.parent,e.id,e.status)){case"nextStep":await V(e.parent);break;case"success":t=await r.findOne({_id:e.parent}).populate("owner inFiles outFiles task"),t&&await W(t);break;case"unfinished":break;default:t=await r.findOne({_id:e.parent}).populate("owner inFiles outFiles task"),await B(t)}}().catch(console.log)})),y.on("taskError",(e=>{e&&e.parent&&(console.log("Workflow Error"),async function(){switch(await L(e.parent,e.id,e.status)){case"unfinished":break;default:const t=await r.findOne({_id:e.parent}).populate("owner inFiles outFiles task");t&&await B(t)}}().catch(console.log))}));const W=async(e,t,a)=>{e.timer.push(new Date),t&&(e.stdOut=t),a&&(e.stdErr=a),await l.finishRun(e.id);const s=await d.findOne({_id:e.project}),i=s?s.getListeners():[],r=e.owner.getSlimModel(),o=e.outFiles,n=[];for(const e of o){if(!await e.checkFile()){n.push(e.id);continue}const t=e.getModel();t.owner=r,j(i,"dataChange",{type:"update",target:"DataFile",data:t})}e.status=0===n.length?2:3,n.length>0&&(e.error||(e.error={}),e.error.notes=["The task is correctly executed BUT NOT ALL outputs are generated. Please check if the corresponding task is correctly configured."]);const c=await e.save(),p=e.name?e.name:e.id;if(j(i,"dataChange",{type:"update",target:"Result",data:c.getModel()}),e.parent||2!==e.status?e.parent||3!==e.status||j(i,"message",I("34",{details:`The task: <b>${e.task?e.task.name:"(unknown)"}</b> is failed.Some output files are not existed as expected.Please see the error messages on the result page (<b>${p}</b>)`})):j(i,"message",I("33",{details:`The task: <b>${e.task?e.task.name:"(unknown)"} </b> is performed and finished.The result, <b>${p}</b> , is created and ready for visualization.`})),"workflow"!==e.type)return 2===c.status?y.emit("taskFinished",e):y.emit("taskError",e);await q(e.id)},B=async(e,t,a,s)=>{e.error=s,e.stdOut=t||e.stdOut,e.stdErr=a||e.stdErr,e.timer.push(new Date),e.status=3,await l.errorRun(e.id);const i=await d.findOne({_id:e.project}),r=i?i.getListeners():[],o=e.outFiles,n=o.map((e=>e.checkFile()));for(let e=0;e<o.length;e++)await n[e],j(r,"dataChange",{type:"update",target:"DataFile",data:o[e].getModel()});const c=await e.save(),p=c.name?c.name:c.id;j(r,"dataChange",{type:"update",target:"Result",data:c.getModel()}),e.parent||T.has(e.id)||j(r,"message",I("34",{details:`The task: <b>${e.task&&e.task.name?e.task.name:"(unknown)"}</b> is failed.Please see the error messages on the result info page (<b>"${p}</b>)`,attached:s})),T.delete(e.id),e.parent||"workflow"!==e.type?y.emit("taskError",e):await q(e.id)},z=(e,a)=>{const s=t.get(e);if(!s)return w.delete(e),void M({resultId:e,type:"not-found"}).catch(console.log);const i=s.process;if(i){const s=i.pid;if(a=a||"SIGTERM",process.stdout.write(`kill the process ${s} (resultId: ${e}) with the signal ${a}\n`),"SIGINT"===a&&T.add(e),"win32"===p.platform())try{"SIGINT"===a?(console.log(`Sending the SIGINT to ${s}`),i.stdin.write("bdp stop task with SIGINT\n")):i.stdin.write("bdp stop task\n")}catch(e){process.stdout.write(`${e.message?e.message:""}\n${e.stacks?e.stacks:e}\n`)}else i.kill(a);setTimeout((()=>{if(!i||!i.killed){if(!t.get(e))return;E("The process kill signal cannot be sent.",e).then(C).catch(console.log)}}),6e5)}return i},G={setConcurrentProcesses:e=>D=e,pause:()=>$=!0,start:()=>{$=!1,C().catch((e=>console.log(e)))},addToQueue:async e=>{try{const t={id:e.id,parent:e.parent,cmd:e.command,args:e.commandArgs,cwd:e.cwd,type:e.type,user:e.owner,project:e.project,env:e.env,extDirs:e.extDirs};"workflow"!==t.type?(A.push(t),await o.updateOne({},{taskQueue:A}).exec().catch((e=>console.log(e))),$||await C(),j(null,"serverStatus",{queue:await G.getCurrentQueueNumber(),running:await G.getCurrentProcessNumber()})):await(async e=>{if(e&&"workflow"===e.type)try{const t=await r.findOne({_id:e.id}).populate("project owner inFiles outFiles task");if(!t)return;const a=t.project,s=a?a.getListeners():[],i=t.task.mapper,o=[];for(let e=0;e<i.length;e++){o[e]=[];for(let t=0;t<i[e].length;t++)o[e][t]=i[e][t].args}const n=[];for(let e=0;e<i.length;e++){if(!Array.isArray(i[e]))throw[I("32",{details:`This workflow has undefined step ${e}. Please check if the workflow is corrected set.`})];const t=[];for(let a=0;a<i[e].length;a++){const s=i[e][a];t.push(F(s))}const a=Promise.all(t);for(let t=0;t<a.length;t++)a[t]||n.push(`At step ${e}, we cannot find the ${t+1}${m(t)} task. It requires the task-key ${i[e][t].key} in the package ${i[e][t].pkg}`)}n.length>0&&console.log("The workflow task has errors"),t.status=1,await l.startRun(e.id),j(s,"dataChange",{type:"update",target:"Result",data:t.getModel()});const d={id:e.id,name:e.name,desc:e.desc,user:e.user,project:e.project,mapper:i,args:t.arguments,argValues:o,progress:0,finished:[],commands:[],results:[],resultStatus:[],env:e.env};for(let e=0;e<i.length;e++)d.results[e]=Array.isArray(t.children[e])?t.children[e]:[];await R(d),await V(d.id)}catch(e){console.log(e)}})(t)}catch(e){console.log(e)}},getCurrentQueueNumber:async()=>A.length,getCurrentProcessNumber:async()=>t.size,getProcess:e=>t.has(e)?t.get(e).process:null,getCurrentStdOutput:async e=>{var t,s;const i=await r.findOne({_id:e}),o=i.pid;return{stdOut:(null===(t=a[o])||void 0===t?void 0:t.stdOut)||i.stdOut,stdErr:(null===(s=a[o])||void 0===s?void 0:s.stdErr)||i.stdErr}},deleteTaskInQueue:async e=>{for(let t=0;t<A.length;t++)if(A[t].id===e){A.splice(t,1),await o.updateOne({},{taskQueue:A});break}j(null,"serverStatus",{queue:await G.getCurrentQueueNumber(),running:await G.getCurrentProcessNumber()})},stopAllWithSIGINT:async()=>{$=!0;const e=t.entries();let a=e.next(),s=[];for(;!a.done;){const t=a.value[0],i=a.value[1].process;i&&i.pid?(s.push(new Promise((e=>{let a=0;y.once(`job-exit-${t}`,(s=>{(async()=>{if("not-found"!==s.type){y.removeAllListeners(`job-exit-${t}`);const e=await r.findOne({_id:t});e&&(A.unshift({id:e.id,parent:e.parent,cmd:e.command,args:e.commandArgs,cwd:e.cwd,type:e.type,user:e.owner,project:e.project,env:e.env,extDirs:e.extDirs}),await o.updateOne({},{taskQueue:A}))}else a++,a>=1&&(y.removeAllListeners(`job-exit-${t}`),await B(result))})().catch(console.log).finally((()=>{w.delete(t),e()}))})),w.has(t)||(w.add(t),z(t,"SIGINT"))}))),s.length>=50&&(await o.updateOne({},{taskQueue:A}),await Promise.all(s).catch(console.log).finally((()=>s.length=0))),a=e.next()):a=e.next()}try{await o.updateOne({},{taskQueue:A}),await Promise.all(s)}catch(e){console.log(e)}},stopRunningTask:async(e,a)=>{const s=await r.findOne({_id:e}).populate("owner inFiles outFiles task");if(s&&!(s.status>1))if("workflow"!==s.type&&0!=s.status){if(t.has(e))return new Promise((t=>{let i=0;y.on(`job-exit-${e}`,(a=>{if("not-found"!==a.type)return y.removeAllListeners(`job-exit-${e}`),w.delete(e),t();i++,i>=1&&(y.removeAllListeners(`job-exit-${e}`),w.delete(e),B(s).catch(console.log).finally(t))})),w.has(e)||(w.add(e),z(e,a))}));await B(s)}else await B(s)},deleteWorkflow:async e=>await q(e)};$=!0;const U=await o.findOne({});if(U){const e=U.processing||[],t=U.taskQueue,a=U.workflowProcess,s=new Map;e.length>0&&(await r.find({_id:{$in:e}})).forEach((e=>{s.set(e.id,{id:e.id,parent:e.parent,cmd:e.command,args:e.commandArgs,cwd:e.cwd,type:e.type,user:e.owner,project:e.project,env:e.env,extDirs:e.extDirs})}));for(let t=0;t<e.length;t++){const a=s.get(e[t]);a&&A.push(a)}if(a){const e=Object.keys(a);for(let t=0;t<e.length;t++){const s=a[e[t]];_.set(s.id,s)}}t.forEach((e=>A.push(e))),U.taskQueue=A,U.processing={},0===U.taskQueue.length&&(U.workflowProcess={}),await U.save()}else{const e=new o;await e.save()}return $=!1,await C(),G}},5702:(e,t,a)=>{const s=a(2127),i=a(5619),r=a(5622),o=a(4298),n=a(8605),d=a(7211),c=a(434),l=a(5585),p=a(571),u=a(703),h=a(4959),g=a(4032),f=a(3464),m=a(146),w=a(8633),y=a(4673),k=a(5543),v=e=>e.isDirectory()?"directory":e.isFile()?"file":e.isSymbolicLink()?"shortcut":"other";e.exports=function(e){const t=e.chiConfig,a=e.helpers,b=a.chiAsyncWrap,x=a.getCode,S=a.getAuthAsync,O=a.pkgNameFormatter,I=t.system.packageFolder,P=t.system.docker_path,j=a.socketBroadcast,F=a.playbookHandler,T=a.getTaskByMap,D=a.exportPackageDB,$={},A={"under development":0,experimenting:1,stable:2,deprecated:3},_=w.diskStorage({destination:function(e,a,s){s(null,r.resolve(t.system.uploadFolder))},filename:function(e,t,a){a(null,"Data-"+Date.now())}}),M=function(e,a,s){s=s||t.system.fileLimits;const i=w({storage:_,limits:{fileSize:s}}).array("file");return new Promise(((t,s)=>i(e,a,(e=>e?s(e):t()))))},E=async(e,t)=>{let a;return new Promise(((s,i)=>{const r=e=>{const a=!t||t&&e.headers["content-type"]===t;let r="";e.on("data",(e=>{r+=e})),e.on("end",(()=>a?s(r):i(r)))};e.match(/^https\:\/\//)?a=d.get(e,r):e.match(/^http\:\/\//)&&(a=n.get(e,r)),a.on("error",(e=>i(e))),a.end()}))},C=async function(e){const t=`https://spreadsheets.google.com/feeds/list/${e=e||"1sUQT7dUrQfjqXVC-AmhmQzt8OiJCCvDqwCf1APysK0g"}/od6/public/values?alt=json`;try{const a=await E(t,"application/json; charset=UTF-8");return JSON.parse(a).feed.entry.filter((e=>e.gsx$name.$t.split("-").length>=2)).map((t=>({category:t.gsx$category.$t,name:O(t.gsx$name.$t),author:t.gsx$author.$t,email:t.gsx$email.$t,fromPath:t.gsx$path.$t,desc:t.gsx$description.$t,link:t.gsx$link.$t,status:A[t.gsx$status.$t],sheetID:e})))}catch(e){throw[x("706",{attached:{response:e}})]}},N=async e=>{const t=`https://spreadsheets.google.com/feeds/worksheets/${e}/public/values?alt=json`;let a;try{a=await E(t,"application/json; charset=UTF-8")}catch(e){throw[x("706",{attached:{response:JSON.stringify(e)}})]}try{const e=JSON.parse(a);if(e&&e.feed&&e.feed.title)return e.feed.title.$t}catch(e){return"No name of this package list"}},R=async(e,t)=>{e=e||"1sUQT7dUrQfjqXVC-AmhmQzt8OiJCCvDqwCf1APysK0g";try{const a=`https://sheets.googleapis.com/v4/spreadsheets/${e}/values/package-list?key=${t}`,s=await E(a,"application/json; charset=UTF-8"),i=JSON.parse(s),r=[],o=i.values[0];for(let t=1;t<i.values.length;t++){const a={};i.values[t].forEach(((e,t)=>a[o[t]]=e)),a.Name.split("-").length>=2&&r.push({category:a.Category,name:O(a.gsx$name.$t),author:a.Author,email:a.Email,status:A[a.Status],fromPath:a.Path,desc:a.Description,link:a.Link,scope:[],allowedFormats:[],formatMapping:[],sheetID:e})}return r}catch(e){throw[x("706",{attached:e})]}},L=async(e,t)=>{const a=`https://sheets.googleapis.com/v4/spreadsheets/${e}?fields=properties.title&key=${t}`;try{const e=await E(a,"application/json; charset=UTF-8"),t=JSON.parse(e);return t&&t.properties&&t.properties.title&&t.properties.title||"No name of this package list"}catch(e){throw[x("706",{attached:e})]}},q=s.Router();return q.all("/api/*",((e,t,a)=>{const s={errors:[]};if(!e.isAuthenticated())return s.errors.push(x("a011")),t.json(s);a()})),q.get("/api/package/list",b((async e=>{const t={errors:[]},a=e.session.passport.user.id,s=await S(a,"bdp",2),i=s.auths.bdp;let r={};if(i<2)throw[x("a017")];i<3?r={status:{$in:[2]}}:i<7&&(r={status:{$in:[1,2,3]}});const o=await m.find(r).populate("owner managers runners viewers"),n=[];for(let e=0;e<o.length;e++){const t=o[e],a=t.getPrivilege(s);n.push(t.getModel(a))}return t.success=n,t}))),q.post("/api/package/save",b((async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,n=await S(s,"bdp",7),d=e.body.package,c=O(d.name+"-"+d.version),l=d.sheetID||"internal",p=d.sheetName||"Internal Package List",u=r.join(I,l,c),h=d.allowedFormats;if(Array.isArray(h)?h.indexOf("*")>=0?d.allowedFormats=["*"]:d.allowedFormats=h.map((e=>e.replace(/[^a-zA-Z0-9\.\-\_]/g,""))).filter((e=>e)):d.allowedFormats=[],"internal"!==l){const e=await m.find({sheetID:l});if(0===e.length)throw[x("700",{details:"The sheet ID does not exist."})];if(e.filter((e=>e.sheetName!==p)).length>0)throw[x("700",{details:"The sheetName and the sheet ID are inconsistent."})]}else if("Internal Package List"!==p)throw[x("700",{details:"The internal package can only have the name: Internal Package List"})];let g,f,w;if(d.id){if(!i.Types.ObjectId.isValid(d.id))throw[x("700")];const e=await m.findOne({_id:d.id});if(!e.getPrivilege(n).canEdit)throw[x("700",{details:"Sorry, you do not have privileges to save this package."})];let t=e.path;if(!await o.pathExists(e.path))throw[x("700",{details:`The original package folder path ${e.path} is not existed.`})];if(e.sheetID!==d.sheetID||e.name!==c){if(await o.pathExists(u))throw[x("702",{details:`Sorry, this package name ${c} has been used. Please try another.`})];try{await o.move(e.path,u)}catch(e){throw[x("701",{attached:e})]}t=u}g=await m.findByIdAndUpdate(d.id,{name:c,desc:d.desc,scope:d.scope,author:d.author,img:d.img,thumbnail:d.thumbnail,email:d.email,status:d.status,allowedFormats:d.allowedFormats,path:t,sheetID:d.sheetID,sheetName:d.sheetName,formatMapping:d.formatMapping,public:!!d.public},{new:!0}).populate("owner managers viewers runners"),w="update",f=g.getModel(g.getPrivilege(n)),a.success=f}else{if(n.auths.bdp<7)throw[x("700",{details:"Sorry, you do not have privileges to create this package."})];if(await o.pathExists(u))throw[x("702",{details:`Sorry, this package name ${c} has been used. Please try another.`})];try{await o.ensureDir(u),await o.ensureDir(u+"/configs"),await o.ensureDir(u+"/scripts"),await o.ensureDir(u+"/tasks"),await o.ensureDir(u+"/db"),await o.ensureDir(u+"/client"),await o.ensureFile(u+"/task-index.yaml"),await o.outputFile(u+"/task-index.yaml","tasks:\n"),await o.outputFile(u+"/configs/package-config.json",'{"default":{"adapter":"docker","concurrency":1,"cpus":1,"memory":"4GB"}}')}catch(e){throw[x("701",{attached:e})]}g=new m({name:c,desc:d.desc,author:d.author,email:d.email,img:d.img,thumbnail:d.thumbnail,path:u,scope:d.scope,status:d.status,allowedFormats:Array.isArray(d.allowedFormats)?d.allowedFormats:["*"],formatMapping:Array.isArray(d.formatMapping)?d.formatMapping:[],sheetID:l,sheetName:p,owner:n.id,runners:[],managers:[],viewers:[]}),await g.save(),g=await m.findOne({_id:g.id}).populate("owner"),w="insert",f=g.getModel(g.getPrivilege(n)),a.success=f}t.json(a),j(n.id,"dataChange",{type:w,target:"Package",data:f}),["managers","viewers","runners"].forEach((e=>{g[e].forEach((e=>{j(e.id,"dataChange",{type:w,target:"Package",data:g.getModel(g.getPrivilege(e))})}))})),D(g)}))),q.delete("/api/package/:packageId",b((async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.packageId;if(!i.Types.ObjectId.isValid(s))throw[x("700")];const r=await S(a,"bdp",8),n=await m.findOne({_id:s});if(!n)throw[x("700",{details:"This package may be already deleted."})];const d=n.getPrivilege(r);if(!d.canDelete)throw[x("700",{details:"Sorry, you do NOT have privileges to delete this package."})];const c=n.getListeners([r.id]);return o.remove(n.path).catch((e=>{console.log(e)})),await u.deleteMany({package:s}),await n.remove(),t.success=n.getModel(d),j(c,"dataChange",{type:"delete",target:"Package",data:n.getModel()}),t}))),q.get("/api/package/:packageId/save",b((async(e,t)=>{const a=e.session.passport.user.id,s=e.params.packageId;if(!i.Types.ObjectId.isValid(s))throw[x("700")];const r=await S(a,"bdp",7),o=await m.findOne({_id:s});if(!o)throw[x("700",{details:"This package does not exist."})];if(!o.getPrivilege(r).canView)throw[x("700",{details:"Sorry, you can not export this package."})];await D(o),t.header("Content-Type","application/zip"),t.header("Content-Disposition",`attachment; filename="${o.name}.zip"`);const n=k("zip",{zlib:{level:1}});return n.pipe(t),n.directory(o.path+"/","bdp-package"),n.finalize(),!1}))),q.get("/api/package/:packageId/getRuntime",b((async e=>{const t=e.session.passport.user.id,a=e.params.packageId;if(!i.Types.ObjectId.isValid(a))throw[x("700")];const s=await S(t,"bdp",7),n=await m.findOne({_id:a});if(!n)throw[x("700",{details:"This package does not exist"})];if(!n.getPrivilege(s).canView)throw[x("700",{details:"Sorry, you do not have privileges to view the runtime configurations."})];const d=n.path,c=r.resolve(d,"configs","package-config.json");if(!await o.pathExists(c))return{errors:[],success:{}};const l=await o.readJson(c,{throws:!1});return l&&l.default?{errors:[],success:l.default}:{errors:[],success:{}}}))),q.post("/api/package/:packageId/saveRuntime",b((async e=>{const t=e.session.passport.user.id,a=e.params.packageId,s=!!e.body.reset,n=e.body.runtime||{adapter:"docker",cpus:1,memory:"4gb",concurrency:1,dockerPath:"docker"};if(!i.Types.ObjectId.isValid(a))throw[x("700")];const d=await S(t,"bdp",7),c=await m.findOne({_id:a});if(!c)throw[x("700",{details:"This package does not exist"})];if(!c.getPrivilege(d).canEdit)throw[x("700",{details:"Sorry, you do not have privileges to edit the runtime configurations."})];const l=c.path,p=r.resolve(l,"configs","package-config.json");try{await o.ensureFile(p)}catch(e){throw[x("905",{details:`The runtime config cannot be accessed, please check if the path (${p}) is available.`})]}let u=await o.readJson(p,{throws:!1});u&&!s||(u={});let h=isNaN(parseFloat(n.cpus))?1:parseFloat(n.cpus);h=h>0?h:1;let g=n._memory||"4gb";g=g.toLowerCase().match(/^(\d+[mg])/),g=g?g[1]+"b":"4gb";const f=isNaN(parseInt(n.concurrency))?1:parseInt(n.concurrency),w=isNaN(parseInt(n.updateInterval))?2e4:parseInt(n.updateInterval),y=isNaN(parseInt(n.nodes))?1:parseInt(n.nodes),k=n.dockerPath||P;if(u.default={adapter:n.adapter,batch:!!n.batch,updateInterval:w,cpus:h,mem:g,concurrency:f,nodes:y,dockerPath:k,debug:n.debug},u.default=Object.assign({},u.default,n.overrides),9!==d.auths.bdp&&"local"===u.default.adapter)throw[x("905",{details:"Only the admin can specify the local adapter."})];return await o.writeJSON(p,u),{errors:[],success:u.default}}))),q.post("/api/package/:packageID/setMembers",b((async e=>{const t=e.session.passport.user.id,a=e.params.packageID,s=e.body.changes,r=e.body.scope;if(!i.Types.ObjectId.isValid(a))throw[x("19",{details:`The package ID ${a} is invalid, please check if this is the right ID.`})];if(!s||0===s.length||!r||"runners"!==r&&"managers"!==r&&"viewers"!==r&&"owner"!==r)throw[x("402",{type:"warning",details:"No changing members. Please check if you input all correct member info."})];const o=await S(t,"bdp",8),n=await m.findOne({_id:a});if(!n)throw[x("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const d=n.getPrivilege(o);if(!d.canSetMember||("owner"===r||"managers"===r)&&d.isManager)throw[x("38",{details:"Sorry, you do not have privileges to set members of this package."})];const c=s.map((e=>e.userID&&i.Types.ObjectId.isValid(e.userID)?e.userID:void 0)).filter((e=>void 0!==e));if(0===c.length)throw[x("402",{type:"warning",details:"No changes."})];const l=n[r],p=await f.find({_id:{$in:c}});if(0===p.length)throw[x("402",{type:"warning",details:"No changes."})];for(let e=0;e<p.length;e++){const t=p[e];for(let e=0;e<s.length;e++){const a=s[e];if("owner"===r&&t.id===a.userID){"add"===a.action?n.owner=t.id:"remove"===a.action&&(n.owner=void 0);break}if(t.id===a.userID){if("add"===a.action&&l.indexOf(t.id)<0){n[r].push(t.id);break}if("remove"===a.action){const e=l.indexOf(t.id);e>=0&&n[r].splice(e,1)}}}}await n.save();const u=await m.findOne({_id:a}).populate("owner managers runners viewers");if(!u)throw[x("19",{details:`We can not find the project id: ${a}. please check if this is the right ID.`})];const h=u.getPrivilege(o),g=u.getModel(h);if(j(o.id,"dataChange",{type:"update",target:"Package",data:u.getModel(h)}),["managers","viewers","runners"].forEach((e=>{u[e].forEach((e=>{j(e.id,"dataChange",{type:"update",target:"Package",data:u.getModel(u.getPrivilege(e))})}))})),!h.canView)throw[x("38",{details:"Sorry, you do not have privileges to view this project."})];return{errors:[],success:g}}))),q.get("/api/package/getList",b((async e=>{let t=e.query.s;const a=e.query.apiKey;let s,i=[];return t&&a?(i=await R(t,a),s=await L(t,a)):(t=t||"1sUQT7dUrQfjqXVC-AmhmQzt8OiJCCvDqwCf1APysK0g",i=await C(t),s=await N(t)),{errors:[],success:{pkgList:i,sheetName:s}}}))),q.post("/api/package/install",b((async e=>{const t={errors:[]},a=e.session.passport.user.id,s=O(e.body.packageName);let i=e.body.installAs;i&&(i=O(i));let n=e.body.s;n||(n="1sUQT7dUrQfjqXVC-AmhmQzt8OiJCCvDqwCf1APysK0g");const d=e.body.apiKey,c=await S(a,"bdp",8),l=n&&d?await R(n,d):await C(n),p=n&&d?await L(n,d):await N(n);let u;for(let e=0;e<l.length;e++)if(l[e].name===s){u=l[e];break}if(!u)throw[x("707",{details:`We cannot find the package (name: ${s}). Please check the package name.`})];const h=await m.findOne({name:s,sheetID:n});if(h&&!i){const e=h.getPrivilege(c);if(!e.canEdit)throw[x("707",{details:`The ${s} in the package list (id: ${n}) is already existed and you do NOT have privilege to edit it. You may want to change a name and reinstall it.`})];h.setupSteps<1&&(h.setupSteps=1),h.desc=u.desc,h.author=u.author,h.email=u.email,h.setupSteps=1,h.sheetName=p,await h.save();const a=await m.findOne({_id:h.id}).populate("owner managers runners viewers");return t.success=a.getDetailModel(e),t}if(i){const e=await m.findOne({name:i,sheetID:n});if(e){const a=e.getPrivilege(c);if(!a.canEdit)throw[x("707",{details:`The ${i} in the package list (id: ${n}) is already existed and you do NOT have privilege to edit it. You may want to change a name and reinstall it.`})];e.setupSteps<1&&(e.setupSteps=1),e.desc=u.desc,e.author=u.author,e.email=u.email,e.setupSteps=1,e.sheetName=p,await e.save();const s=await m.findOne({_id:e.id}).populate("owner managers runners viewers");return t.success=s.getDetailModel(a),t}}t.success=void 0,n||d||(n="internal");const g=r.join(I,n,i||O(u.name));try{await o.ensureDir(g)}catch(e){throw[x("701",{attached:e})]}const f=new m({name:i||O(u.name),desc:u.desc,author:u.author,email:u.email,path:g,fromPath:u.fromPath,scope:u.scope,status:u.status,allowedFormats:u.allowedFormats,formatMapping:u.formatMapping,setupSteps:1,sheetID:n,sheetName:p,owner:c.id,runners:[],managers:[],viewers:[]});await f.save();const w=await m.findOne({_id:f.id}).populate("owner"),y=w.getPrivilege(c);return t.success=w.getDetailModel(y),j(a,"dataChange",{type:"insert",target:"Package",data:t.success}),t}))),q.post("/api/package/upload",b((async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,i=e.query.listID||"internal",n=await S(s,"bdp",8),d=await m.find({sheetID:i});if(d.length<1&&"internal"!==i)throw[x("701",{details:"Invalid package sheet ID"})];try{await M(e,t,5e8)}catch(t){throw e.files.map((async e=>{await o.unlink(e.path)})),[x("13",{code:13,name:"File upload failed",details:t.toString(),attached:t})]}const c="internal"===i?"Internal Package List":d[0].sheetName,h=O(e.query.pkgName||r.basename(e.files[0].originalname,".zip"));if(await m.findOne({name:h,sheetID:i}))throw e.files.map((async e=>{await o.unlink(e.path)})),[x("702")];const g=r.join(I,i,h);if(await o.pathExists(g))throw[x("701",{details:"The package path already exists."})];const f={stdOut:"",stdErr:""};try{await o.createReadStream(e.files[0].path).pipe(l.Parse()).on("entry",(e=>{const t=r.relative("bdp-package",e.path);if("Directory"===e.type)t?o.ensureDir(r.join(g,t),(a=>{a&&(f.stdErr+=JSON.stringify(a)+"\n"),f.stdOut+=t+"\n",e.autodrain()})):(f.stdOut+="Extracting files ...\n",e.autodrain());else if("File"===e.type){f.stdOut+=t+"\n";const a=r.join(g,t);o.ensureFile(a).then((()=>e.pipe(o.createWriteStream(a))))}})).promise()}catch(t){throw e.files.map((async e=>{await o.unlink(e.path)})),await o.remove(g),[x("701",{details:"We encountered errors during package file compression: "+t.toString()})]}e.files.map((async e=>{await o.unlink(e.path)}));const w=r.join(g,"db","bdp-package.json");if(!await o.pathExists(w))throw await o.remove(g),[x("701",{details:"Your package zip file does not contain a '/bdp-package/db/bdp-package.json' file."})];const y=await o.readJSON(w,{throws:!1});if(!y||!y.package||!y.tasks)throw await o.remove(g),[x("701",{details:"Your package definition in '/bdp-package/db/bdp-package.json' has errors."})];const k=new m({name:h,desc:y.package.desc,author:y.package.author,email:y.package.email,path:g,fromPath:"",scope:y.package.scope,status:0,allowedFormats:y.package.allowedFormats,formatMapping:y.package.formatMapping,setupSteps:2,sheetID:i,sheetName:c,stdOut:f.stdOut,stdErr:f.stdErr,owner:n.id,runners:[],viewers:[],managers:[]});k.setPages(y.package.pages),await k.save();const v=y.tasks.filter((e=>"workflow"!==e.type)),b=y.tasks.filter((e=>"workflow"===e.type)),P={},F=[];for(let e=0;e<v.length;e++){const t=v[e],a=new u({name:t.name,type:t.type,desc:t.desc,key:p(t.key,{condense:!0}),package:k.id,img:t.img,thumbnail:t.thumbnail,script:t.script,exec:t.exec,cwd:t.cwd,arguments:t.arguments,mapper:t.mapper,version:t.version,proxy:t.proxy||null});P[t._id]=a.id,F.push(a.save())}for(let e=0;e<b.length;e++){const t=b[e];for(let e=0;e<t.mapper.length;e++){const a=t.mapper[e];for(let s=0;s<a.length;s++){const i=a[s];t.mapper[e][s].id=P[i.id]}}const a=new u({name:t.name,type:t.type,desc:t.desc,key:p(t.key,{condense:!0}),package:k,img:t.img,thumbnail:t.thumbnail,script:t.script,exec:t.exec,cwd:t.cwd,arguments:t.arguments,mapper:t.mapper,stepNames:t.stepNames,version:t.version});F.push(a.save())}for(const e of F)await e;k.setupSteps=3,await k.save();const T=await m.findOne({_id:k}).populate("owner"),D=T.getPrivilege(n),$=T.getDetailModel(D);return j(s,"dataChange",{type:"insert",target:"Package",data:$}),a.success=$,a}))),q.get("/api/package/:packageId/download",b((async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,n=e.params.packageId,d=e.query.restart;if(!i.Types.ObjectId.isValid(n))throw[x("700")];const p=await S(s,"bdp",8),u=await m.findOne({_id:n});if(!u)throw[x("707",{details:`We cannot find the package (id: ${n}). Please check the package id.`})];const h=u.getPrivilege(p);if(!h.canEdit)throw[x("707",{details:"Sorry, you do not have privileges to install this package."})];u.setupSteps=1;const g=await u.save();a.success=g.getDetailModel(h),a.success.stdOut="Recieving stdandard outputs ...\n",a.success.stdErr="Recieving stdandard errors ...\n",a.success.error={},t.json(a),await o.emptyDir(u.path),$[g.id]&&!d||($[u.id]={stdOut:"",stdErr:"",error:{},process:void 0}),$[u.id].stdOut+="Preparing download zip file\n",j(s,"packageOut",{type:"stdOut",target:u.id,data:$[u.id].stdOut});try{await o.ensureDir(u.path+".bak"),await o.emptyDir(u.path+".bak"),await c(u.fromPath).pipe(l.Parse()).on("entry",(e=>{const t=e.path.indexOf("/bdp-package/"),a=e.path.slice(0,t+12),i=r.relative(a,e.path);"Directory"===e.type?i?o.ensureDir(r.join(u.path+".bak",i),(t=>{t&&($[u.id].stdErr+=JSON.stringify(t)+"\n",j(s,"packageOut",{type:"stdErr",target:u.id,data:$[u.id].stdErr})),$[u.id].stdOut+=i+"\n",j(s,"packageOut",{type:"stdOut",target:u.id,data:$[u.id].stdOut}),e.autodrain()})):($[u.id].stdOut+="Extracting files ...\n",j(s,"packageOut",{type:"stdErr",target:u.id,data:$[u.id].stdOut}),e.autodrain()):"File"===e.type&&($[u.id].stdOut+=i+"\n",j(s,"packageOut",{type:"stdOut",target:u.id,data:$[u.id].stdOut}),e.pipe(o.createWriteStream(r.join(u.path+".bak",i))))})).promise(),await o.emptyDir(u.path),await o.copy(u.path+".bak",u.path),await o.remove(u.path+".bak");const e=await m.findOne({_id:u.id});if(e){e.stdOut=$[e.id].stdOut,e.stdErr=$[e.id].stdErr,e.error={},e.setupSteps=2;const t=await e.save();j(s,"packageOut",{type:"stdOut",target:u.id,data:e.stdOut}),j(s,"packageOut",{type:"stdErr",target:u.id,data:e.stdErr}),j(s,"dataChange",{type:"update",target:"Package",data:t.getDetailModel(h)})}delete $[e.id]}catch(e){(async()=>{await o.remove(u.path+".bak");const t=await m.findOne({_id:u.id});t.stdOut=$[t.id].stdOut,t.stdErr=$[t.id].stdErr+e.stack,t.error={},t.setupSteps=1,delete $[t.id];const a=await t.save();j(s,"packageOut",{type:"stdOut",target:t.id,data:t.stdOut}),j(s,"packageOut",{type:"stdErr",target:t.id,data:t.stdErr}),j(s,"dataChange",{type:"update",target:"Package",data:a.getDetailModel(h)})})().then((()=>{j(s,"message",x("701",{name:"Package installation failed",details:`We failed to install the package, <b>${u.name}</b>.`,attached:e}))}))}return!1}))),q.get("/api/package/:packageId/importTasks",b((async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.packageId;if(!i.Types.ObjectId.isValid(s))throw[x("700")];const n=await S(a,"bdp",8),d=await m.findOne({_id:s});if(!d)throw[x("707",{details:`We cannot find the package (id: ${s}). Please check the package id.`})];const c=d.getPrivilege(n);if(!c.canEdit)throw[x("707",{details:"Sorry, you do not have privileges to import tasks to this package."})];const l=await o.readJSON(r.resolve(d.path,"db","bdp-package.json"));if(!l||!l.package||!l.tasks)throw[x("s001",{name:"Wrong backup file"})];d.setPages(l.package.pages);const h=d;h.scope=l.package.scope||[],h.formatMapping=l.package.formatMapping||[],h.allowedFormats=l.package.allowedFormats||[];const g=await m.findOneAndUpdate({_id:s},{name:d.name,desc:d.desc,author:d.author,email:d.email,container:d.container,scope:h.scope,status:d.status,link:d.link,formatMapping:h.formatMapping,allowedFormats:h.allowedFormats,pages:d.pages},{new:!0}).populate("owner managers runners viewers");await u.deleteMany({package:s});const f=l.tasks.filter((e=>"workflow"!==e.type)),w=l.tasks.filter((e=>"workflow"===e.type)),y={},k=[];for(let e=0;e<f.length;e++){const t=f[e],a=new u({name:t.name,type:t.type,desc:t.desc,key:p(t.key,{condense:!0}),package:s,img:t.img,thumbnail:t.thumbnail,script:t.script,exec:t.exec,cwd:t.cwd,arguments:t.arguments,mapper:t.mapper,version:t.version,proxy:t.proxy||null});y[t._id]=a.id,k.push(a.save())}for(let e=0;e<w.length;e++){const t=w[e];for(let e=0;e<t.mapper.length;e++){const a=t.mapper[e];for(let s=0;s<a.length;s++){const i=a[s];t.mapper[e][s].id=y[i.id]}}const a=new u({name:t.name,type:t.type,desc:t.desc,key:p(t.key,{condense:!0}),package:s,img:t.img,thumbnail:t.thumbnail,script:t.script,exec:t.exec,cwd:t.cwd,arguments:t.arguments,mapper:t.mapper,version:t.version});k.push(a.save())}for(const e of k)await e;return g.setupSteps=3,await g.save(),t.success=g.getDetailModel(c),t}))),q.get("/api/package/:packageId",b((async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.packageId;if(!i.Types.ObjectId.isValid(s))throw[x("700")];const r=await S(a,"bdp",2),o=await m.findOne({_id:s}).populate("owner managers viewers runners");if(o){const e=o.getPrivilege(r);if(!e.canView)throw[x("700",{details:"Sorry, you do not have privileges to view this task."})];r.auths&&r.auths.bdp>=8?(t.success=o.getDetailModel(e),$[o.id]&&(t.success.stdOut=$[o.id].stdOut,t.success.stdErr=$[o.id].stdErr)):t.success=o.getModel(e)}else t.success={};return t}))),q.get("/api/package/:packageId/file/list",b((async e=>{const t={errors:[],success:[]},a=e.session.passport.user.id,s=e.params.packageId;let n=e.query.path||"";if(n=n.replace(/\\\\/g,"/").replace("\\","/"),!i.Types.ObjectId.isValid(s))throw[x("700")];const d=await S(a,"bdp",7),c=await m.findOne({_id:s});if(!c)throw[x("700",{details:"This package does not exist"})];if(!c.getPrivilege(d).canView)throw[x("700",{details:"Sorry, you do not have privilege to view the package files."})];const l=c.path,p=n?r.join(l,n):l;if(!y(p,l))return t;const u=await o.readdir(p),h=u.map((e=>o.stat(r.resolve(p,e)))),g=[];for(const e of h){const t=await e;g.push(t)}return t.success=g.map(((e,t)=>{let a="file";a=e.isDirectory()?"directory":e.isFile()?"file":e.isSymbolicLink()?"shortcut":"other";const s=u[t];return{name:u[t],size:e.size,type:a,path:n?n+"/"+s:s}})),t}))),q.get("/api/package/:packageId/file/read",b((async(e,t)=>{const a=e.session.passport.user.id,s=e.params.packageId,n=e.query.path;if(!i.Types.ObjectId.isValid(s))throw[x("700")];const d=await S(a,"bdp",7),c=await m.findOne({_id:s});if(!c)throw[x("700",{details:"This package does not exist"})];if(!c.getPrivilege(d).canView)throw[x("700",{details:"Sorry, you do not have privilege to view the package files."})];const l=c.path,p=n?r.resolve(l,n):l;if(!y(p,l))throw[x("713",{details:"The path to process is invalid."})];if(!await o.pathExists(p))throw[x("713",{details:"The path can not be accessed."})];const u=await o.stat(p);if(!u.isFile())throw[x("713",{details:"The path can not be accessed."})];if(u.size>5e7)throw[x("713",{details:"The file is too large."})];t.sendFile(p)}))),q.post("/api/package/:packageId/file/handle",b((async e=>{const t=e.session.passport.user.id,a=e.params.packageId,s=e.query.type,n=e.query.path||"",d=e.body.fileItems;if(!i.Types.ObjectId.isValid(a))throw[x("700")];if(!s||["add","remove","update","move","rename"].indexOf(s)<0)throw[x("713",{details:"Invalid type to handle."})];const c=await S(t,"bdp",7),l=await m.findOne({_id:a});if(!l)throw[x("700",{details:"This package does not exist"})];if(!l.getPrivilege(c).canEdit)throw[x("700",{details:"Sorry, you do not have privilege to handle the package files."})];const p=l.path;if(n.match(/\./))throw[x("713",{details:"This query path is invalid."})];const u=n?r.join(p,n):p;if(!y(u,p))throw[x("713",{details:"The path to process is invalid."})];if(!y(r.resolve(u),r.resolve(p,"scripts"))&&!y(r.resolve(u),r.resolve(p,"client")))throw[x("713",{details:"The path to process is invalid."})];if(!d||0===d.length)throw[x("713",{details:"No file items to create"})];if(r.normalize(u)===r.normalize(p))throw[x("713",{details:"You cannot handle the package root folder."})];const h=[];for(let e=0;e<d.length;e++){const t=d[e],a={name:t.name,size:0,type:t.type,path:n?n+"/"+t.name:t.name};let i=r.join(u,t.name);switch(s){case"add":if("directory"===t.type)await o.ensureDir(i);else{if("file"!==t.type)throw[x("713",{details:"The file type is not supported."})];await o.ensureFile(i)}break;case"rename":const e=t.name,s=/^\.\./;if(e.match(s))throw[x("713",{details:`The filename, ${e}, is not valid.`})];const d=t.path,c=r.join(p,d),l=r.join(r.dirname(c),t.name);if(!y(r.resolve(c),r.resolve(p,"scripts"))&&!y(r.resolve(c),r.resolve(p,"client")))throw[x("713",{details:"The original path is invalid."})];if(!y(r.join(l),r.join(p,"scripts"))&&!y(r.join(l),r.join(p,"client")))throw[x("713",{details:"The new path is invalid."})];if(await o.pathExists(l))throw[x("713",{details:`The new path ${t.name} has been used.`})];try{await o.move(c,l)}catch(e){throw[x("713",{details:`Moving the file, '${t.path}', has errors.`,attached:e})]}const h=await o.stat(l);a.name=e;const g=d.split(/\//);g.pop(),a.path=g.join("/")+"/"+e,a.size=h.size,h.isDirectory()?a.type="directory":h.isFile()?a.type="file":h.isSymbolicLink()?a.type="shortcut":a.type="other";break;case"update":i=r.join(u);break;case"move":const f=r.resolve(p+"/"+t.path);if(!y(f,r.resolve(p,"scripts"))&&!y(f,r.resolve(p,"client")))throw[x("713",{details:`The file path, ${t.path} , is invalid.`})];if(f===r.resolve(p,"scripts")||f===r.resolve(p,"client"))throw[x("713",{details:"You cannot manipulate the Package root elements"})];try{await o.move(f,r.join(u,t.name))}catch(e){throw[x("713",{details:`Failed to move the file ${t.path}.`,attached:e})]}const m=await o.stat(r.join(u,t.name));a.name=t.name,a.path=n?n+"/"+t.name:t.name,a.size=m.size,a.type=v(m);break;case"remove":await o.remove(i)}h.push(a)}return{errors:[],success:h}}))),q.post("/api/package/:packageId/file/upload",b((async(e,t)=>{const a=e.session.passport.user.id,s=e.params.packageId,n=e.query.path;if(!i.Types.ObjectId.isValid(s))throw[x("700")];if(!n)throw[x("713",{details:"You cannot upload to the package root folder."})];const d=await S(a,"bdp",7),c=await m.findOne({_id:s});if(!c)throw[x("700",{details:"This package does not exist"})];if(!c.getPrivilege(d).canEdit)throw[x("700",{details:"Sorry, you do not have privilege to upload files to this package."})];const l=c.path,p=r.join(l,n);if(!y(r.join(l,n),l))throw[x("713",{details:"The path to process is invalid."})];if(!y(r.resolve(p),r.resolve(l,"scripts"))&&!y(r.resolve(p),r.resolve(l,"client")))throw[x("713",{details:"The path to process is invalid."})];if(!(await o.stat(p)).isDirectory())throw[x("713",{details:"The path is not a directory."})];try{await M(e,t)}catch(t){for(const t of e.files)await o.unlink(t.path);throw[x("13",{code:13,name:"File upload failed",details:"Please try again.",attached:t})]}const u=e.files[0],h=u.originalname,g=u.path,f=r.join(l,n,h);try{await o.move(g,f,{overwrite:!0})}catch(t){for(const t of e.files)await o.unlink(t.path);throw[x("713",{code:13,name:"File upload failed",details:`The file ${u.originalName} has been uploaded but we failed to move the file to its destinations.`,attached:t})]}const w=await o.stat(f);return{errors:[],success:[{name:h,size:w.size,type:v(w),path:n+"/"+h}]}}))),q.get("/api/package/:packageId/file/unzip",b((async e=>{const t=e.session.passport.user.id,a=e.params.packageId,s=e.query.path;if(!i.Types.ObjectId.isValid(a))throw[x("700")];if(!s)throw[x("713",{details:"You cannot upload to the package root folder."})];const n=await S(t,"bdp",7),d=await m.findOne({_id:a});if(!d)throw[x("700",{details:"This package does not exist"})];if(!d.getPrivilege(n).canEdit)throw[x("700",{details:"Sorry, you do not have privilege to unzip files in this package."})];const c=d.path,p=r.resolve(c,s);if(!y(p,r.join(c,"scripts"))&&!y(p,r.join(c,"client")))throw[x("713",{details:"The path to process is invalid."})];if(!await o.pathExists(p))throw[x("713",{details:"The path to process is invalid."})];if(!(await o.stat(p)).isFile())throw[x("713",{details:"The path to process is invalid."})];if(".zip"!==r.extname(p).toLowerCase())throw[x("713",{details:"The path to process is invalid."})];const u=r.dirname(p),h=[];return await o.createReadStream(p).pipe(l.Parse()).on("entry",(e=>{const t=e.path;if(t.indexOf("..")>=0)e.autodrain();else{const a=t.indexOf("/"),s=-1===a||a===t.length-1,i=r.join(u,t);"Directory"===e.type?t?o.ensureDir(i,(a=>{a&&console.log(a),s&&h.push({name:r.basename(t),size:0,type:"directory",path:t}),e.autodrain()})):e.autodrain():"File"===e.type&&(s?e.pipe(o.createWriteStream(i)).on("finish",(()=>{o.stat(i,((e,a)=>{e&&console.log(e),h.push({name:r.basename(t),size:a.size,type:a.isFile()?"file":a.isSymbolicLink()?"shortcut":"other",path:t})}))})):e.pipe(o.createWriteStream(i)))}})).promise(),{errors:[],success:h}}))),q.get("/api/task/bymap",b((async e=>{const t={errors:[],success:{}},a=e.session.passport.user.id,s={pkg:e.query.pkg,pkgid:e.query.pkgid,key:e.query.key,id:e.query.id,ver:e.query.ver},i=await S(a,"bdp",7),r=await T(s);if(r&&r.package){const e=r.package;if(e.getPrivilege){const a=e.getPrivilege(i);a.canRun?(t.success=r.getModelForViewer(),t.success.package=e.getModel(a)):a.canView&&(t.success=r.getModel(),t.success.package=e.getModel(a))}}return t}))),q.post("/api/task/save",b((async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,i=e.body.task;let o="update";if(!i)throw[x("900")];const n=await S(s,"bdp",7);["system","standard","child","workflow"].indexOf(i.type)<0&&(i.type="standard");const d=p(i._key,{condense:!0}),c=await m.findOne({_id:i.package});if(!c)throw[x("900",{details:"Sorry, the package id is not found."})];if(!c.getPrivilege(n).canEdit)throw[x("700",{details:"Sorry, you do not have privilege to edit tasks in this package."})];const l=i.proxy?{enabled:!0,protocol:"http",port:i.proxy.port,ip:i.proxy.ip||"localhost",pathRewrite:!!i.proxy.pathRewrite,entryPath:i.proxy.entryPath||"/"}:null;if(i.id){o="update";const e=await u.findOne({_id:i.id,package:i.package});if(!e)throw[x("900",{details:"Sorry, we cannot find a task of the id: "+i.id})];const t=r.resolve(c.path,"task-index.yaml");if("workflow"!==i.type)if("$SystemFolder/task-portal"===e.script&&"node"===e.exec)if("$SystemFolder/task-portal"===i.script&&"node"===i.exec&&void 0!==i.workflowPlaybook)try{e.key!==d?(await F(t,"delete",e.key),await F(t,"create",d,i.workflowPlaybook)):await F(t,"update",d,i.workflowPlaybook)}catch(e){throw[x("900",{details:e})]}else{if(n.auths.bdp<=8)throw[x("900",{title:"No priviledge!",details:"You are only allowed to define playbook-styled task."})];try{await F(t,"delete",d)}catch(e){throw[x("900",{details:e})]}}else if("$SystemFolder/task-portal"===i.script&&"node"===i.exec&&i.workflowPlaybook)try{await F(t,"create",d,i.workflowPlaybook)}catch(e){throw[x("900",{details:e})]}else if(n.auths.bdp<=8)throw[x("900",{title:"No priviledge!",details:"You are only allowed to define playbook-styled task."})];const s=await u.findByIdAndUpdate(i.id,{name:i.name,type:i.type,desc:i.desc,key:d,img:i.img,thumbnail:i.thumbnail,package:i.package,script:i.script,exec:i.exec,cwd:i.cwd,arguments:i.arguments,encodeArg:!!i.encodeArg,mapper:i.mapper,stepNames:Array.isArray(i.stepNames)?i.stepNames.map((e=>e.slice(0,60))):[],version:i.version,proxy:l||null},{new:!0});a.success=s.getModel(i.workflowPlaybook)}else{o="insert";const e=await u.findOne({key:d,package:c.id});if(e)throw[x("900",{details:`The task key, ${d}, was already used for the task named <b>${e.name}</b>.`})];const t=new u({name:i.name,type:i.type,desc:i.desc,img:i.img,thumbnail:i.thumbnail,key:d,package:c.id,script:i.script,exec:i.exec,cwd:i.cwd,arguments:i.arguments,encodeArg:!!i.encodeArg,mapper:i.mapper,stepNames:Array.isArray(i.stepNames)?i.stepNames.map((e=>e.slice(0,60))):[],version:i.version,proxy:l||null});if("workflow"!==i.type&&"$SystemFolder/task-portal"===i.script&&"node"===i.exec){const e=i.workflowPlaybook;if(!e)throw[x("900",{details:"Please specify the playbook for this task."})];if(c.path){const t=c.path+"/task-index.yaml";try{await F(t,"create",d,e)}catch(e){throw[x("900",{details:e})]}}}else if(n.auths.bdp<=8&&"workflow"!==i.type)throw[x("900",{title:"No priviledge!",details:"You are only allowed to use playbook-styled task."})];const s=await t.save();a.success=s.getModel(i.workflowPlaybook||void 0)}t.json(a);const h=(await f.find({})).map((e=>e._id.toString()));j(h,"dataChange",{type:o,target:"Task",data:a.success}),D(c)}))),q.post("/api/task/:taskId/validInputs",b((async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.taskId,r=e.body.projectID;if(!i.Types.ObjectId.isValid(r))throw[x("19",{details:"We can not find the project id: "+r+". please check if this is the right ID."})];if(!i.Types.ObjectId.isValid(a))throw[x("23")];if(!i.Types.ObjectId.isValid(s))throw[x("31")];const o=await S(a,"bdp",2),n=await u.findOne({_id:s});if(!n)throw[x("31")];if(!(await m.findOne({_id:n.package})).getPrivilege(o).canRun)throw[x("700",{details:"Sorry, you do not have privilege to handle the package files."})];const d=n.arguments,c=[];if(0===d.length)return t.success=[],t;const l=await h.findOne({_id:r});if(!l)throw[x("19",{details:"We can not find the project id: "+r+". please check if this is the right ID."})];if(!l.getPrivilege(o).canRun)throw[x("38",{details:"Sorry, you do not have privileges to view valid inputs in this project."})];for(let e=0;e<d.length;e++){const t=d[e],a=t.type,s=t.tags;if("inFile"===a){const a={};"or"===t.tagMatchRule?a.$in=s:("and"===t.tagMatchRule||"all"===t.tagMatchRule)&&(a.$all=s);const i=await g.find({project:r,tags:a}).sort({updatedAt:-1});i&&i.length>0?c.push({index:e,models:i.filter((e=>("all"!==t.tagMatchRule||e.tags.length===t.tags.length)&&1===e.status)).map((e=>e.getModel()))}):c.push({index:e,models:[]})}}return t.success=c,t}))),q.get("/api/task/list",b((async e=>{const t={errors:[],success:[]};let a="";e.query.package?a=e.query.package:e.query.packages&&(a=e.query.packages);const s=e.query.only,i=e.session.passport.user.id,r=await f.findOne({_id:i});if(!r)throw[x("23")];const o=r.auths.bdp;if(!a)return t;if(a=a.split(","),!Array.isArray(a))return t;const n=await m.find({_id:{$in:a}}),d=n.map((e=>e.id)),c=n.map((e=>e.getPrivilege(r))),l=n.filter(((e,t)=>c[t].canView||c[t].canRun)),p=l.map((e=>e.name.split("-").slice(0,-1).join("-")));p.push("all","utility");const h=await m.find({scope:{$in:p}});a=l.map((e=>e.id));for(const e of h)e.scope.indexOf("admin")>=0?o>=8&&a.push(e.id):a.push(e.id);const g={package:l.map((e=>e.id))};s||(g.package={$in:a}),o<8&&(g.type={$ne:"system"});const w=await u.find(g);return t.success=w.map((e=>{const t=d.indexOf(e.package.toString());if(t<0)return null;const a=c[t];return a&&a.canView?e.getModel():e.getModelForViewer()})).filter((e=>null!==e)),t}))),q.delete("/api/task/:taskId",b((async(e,t)=>{const a={errors:[]},s=e.session.passport.user.id,o=e.params.taskId;if(!i.Types.ObjectId.isValid(o))throw[x("903",{details:"The task id you request is invalid. Please check if you use the correct task id."})];const n=await S(s,"bdp",7),d=await u.findOne({_id:o}).populate("package");if(!d)throw[x("903",{details:"The task you request does not exist."})];if(!d.package||!d.package.getPrivilege)throw[x("903",{details:"The task belongs to no packages."})];if(!d.package.getPrivilege(n).canEdit)throw[x("903",{details:"Sorry, you do not have privileges to delete tasks in this package."})];const c=r.resolve(d.package.path,"task-index.yaml");try{await F(c,"delete",d.key)}catch(e){console.log(e)}await d.remove();const l=d.getModel();l.package=l.package.id,a.success=l,t.json(a);const p=(await f.find({})).map((e=>e._id.toString()));j(p,"dataChange",{type:"delete",target:"Task",data:a.success}),D(d.package)}))),q.get("/api/task/:taskId/playbook",b((async e=>{const t={errors:[]},a=e.session.passport.user.id,s=e.params.taskId;if(!i.Types.ObjectId.isValid(s))throw[x("903",{details:"The task id you request is invalid. Please check if you use the correct task id."})];const o=await S(a,"bdp",7),n=await u.findOne({_id:s}).populate("package");if(!n.package.getPrivilege(o).canView)throw[x("903",{details:"Sorry, you do not have privileges to view the playbook content."})];const d=r.resolve(n.package.path,"./task-index.yaml"),c=n.key;try{t.success=await F(d,"read",c)}catch(e){t.success=""}return t}))),q.get("/api/task/:taskId/getRuntime",b((async e=>{const t=e.session.passport.user.id,a=e.params.taskId;if(!i.Types.ObjectId.isValid(a))throw[x("903",{details:"The task id you request is invalid. Please check if you use the correct task id."})];const s=await S(t,"bdp",7),n=await u.findOne({_id:a}).populate("package"),d=n.key;if(!n.package||!n.package.path)throw[x("905",{details:"The runtime config cannot be accessed."})];if(!n.package.getPrivilege(s).canView)throw[x("903",{details:"Sorry, you do not have privileges to view the runtime config of this task."})];const c=r.resolve(n.package.path,"configs","package-config.json");if(!await o.pathExists(c))return{errors:[],success:{}};const l=await o.readJson(c,{throws:!1});if(!l||!l.default)throw[x("905",{details:"Please first set the runtime configs of package default."})];return{errors:[],success:l[d]||l.default}}))),q.post("/api/task/:taskId/saveRuntime",b((async e=>{const t=e.session.passport.user.id,a=e.params.taskId,s=!!e.body.reset,n=e.body.runtime||null;if(!i.Types.ObjectId.isValid(a))throw[x("903",{details:"The task id you request is invalid. Please check if you use the correct task id."})];const d=await S(t,"bdp",7),c=await u.findOne({_id:a}).populate("package");if(!c||!c.package||!c.package.path)throw[x("905",{details:"The runtime config cannot be accessed."})];const l=c.key;if(!c.package.getPrivilege(d).canEdit)throw[x("903",{details:"Sorry, you do not have privileges to edit the runtime config of this task."})];const p=r.resolve(c.package.path,"configs","package-config.json"),h=await o.readJson(p,{throws:!1});if(!h||!h.default)throw[x("905",{details:"Please first set the runtime configs of package default."})];if(s||!n)return delete h[l],await o.writeJSON(p,h),{errors:[],success:{}};h[l]=n;let g=isNaN(parseFloat(n.cpus))?1:parseFloat(n.cpus);g=g>0?g:1;let f=n._memory||"4gb";f=f.toLowerCase().match(/^(\d+[mg])/),f=f?f[1]+"b":"4gb";const m=isNaN(parseInt(n.concurrency))?1:parseInt(n.concurrency),w=isNaN(parseInt(n.nodes))?1:parseInt(n.nodes),y=n.dockerPath||P,k=isNaN(parseInt(n.updateInterval))?2e4:parseInt(n.updateInterval);if(h[l]=Object.assign({},{adapter:n.adapter,batch:!!n.batch,updateInterval:k,cpus:g,mem:f,concurrency:m,nodes:w,dockerPath:y,debug:n.debug},n.overrides),9!==d.auths.bdp&&"local"===h[l].adapter)throw[x("905",{details:"Only the admin can specify the local adapter."})];return await o.writeJSON(p,h),{errors:[],success:h[l]}}))),q}},3809:e=>{"use strict";e.exports=require("./package.json")},4404:e=>{"use strict";e.exports=require("./public/assets/message-code-table.js")},5057:e=>{"use strict";e.exports=require("@big-data-processor/utilities")},4447:e=>{"use strict";e.exports=require("@hapi/iron")},5543:e=>{"use strict";e.exports=require("archiver")},3129:e=>{"use strict";e.exports=require("child_process")},1531:e=>{"use strict";e.exports=require("cluster")},4995:e=>{"use strict";e.exports=require("compression")},8328:e=>{"use strict";e.exports=require("connect-mongo")},1600:e=>{"use strict";e.exports=require("content-disposition")},358:e=>{"use strict";e.exports=require("cookie-parser")},479:e=>{"use strict";e.exports=require("cors")},6417:e=>{"use strict";e.exports=require("crypto")},571:e=>{"use strict";e.exports=require("dashify")},8614:e=>{"use strict";e.exports=require("events")},2127:e=>{"use strict";e.exports=require("express")},8371:e=>{"use strict";e.exports=require("express-session")},8162:e=>{"use strict";e.exports=require("filenamify")},2335:e=>{"use strict";e.exports=require("find-package-json")},5747:e=>{"use strict";e.exports=require("fs")},4298:e=>{"use strict";e.exports=require("fs-extra")},9644:e=>{"use strict";e.exports=require("globby")},2944:e=>{"use strict";e.exports=require("googleapis")},7693:e=>{"use strict";e.exports=require("greenlock-express")},6725:e=>{"use strict";e.exports=require("helmet")},8605:e=>{"use strict";e.exports=require("http")},6990:e=>{"use strict";e.exports=require("http-proxy")},7211:e=>{"use strict";e.exports=require("https")},6675:e=>{"use strict";e.exports=require("js-yaml")},1671:e=>{"use strict";e.exports=require("mime-types")},5619:e=>{"use strict";e.exports=require("mongoose")},8150:e=>{"use strict";e.exports=require("morgan")},8633:e=>{"use strict";e.exports=require("multer")},6586:e=>{"use strict";e.exports=require("natural-orderby")},8123:e=>{"use strict";e.exports=require("nodemailer")},2087:e=>{"use strict";e.exports=require("os")},8922:e=>{"use strict";e.exports=require("passport")},6:e=>{"use strict";e.exports=require("passport-google-oauth20")},6888:e=>{"use strict";e.exports=require("passport-local")},5622:e=>{"use strict";e.exports=require("path")},4673:e=>{"use strict";e.exports=require("path-is-inside")},1191:e=>{"use strict";e.exports=require("querystring")},1058:e=>{"use strict";e.exports=require("readline")},434:e=>{"use strict";e.exports=require("request")},1301:e=>{"use strict";e.exports=require("rotating-file-stream")},6047:e=>{"use strict";e.exports=require("sanitize-filename")},2709:e=>{"use strict";e.exports=require("serve-index")},5585:e=>{"use strict";e.exports=require("unzipper")},8835:e=>{"use strict";e.exports=require("url")},1231:e=>{"use strict";e.exports=require("uuid")},2439:e=>{"use strict";e.exports=require("ws")}},t={};function a(s){var i=t[s];if(void 0!==i)return i.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,a),r.exports}var s={};(()=>{"use strict";const e=a(2127),t=a(5622),s=a(5747),i=a(7211),r=a(6417),o=a(4298),n=a(4447),d=a(6675),c=a(6725),l=a(1531),p=a(3809),u=a(3129),h=a(1058),g=a(2439),f=new Map;let m=!1;for(let e=2;e<process.argv.length;e++)if("-y"===process.argv[e]){m=!0;break}const w=function(e,t,a){return new Promise(((s,i)=>{process.stderr.write(`[${(new Date).toString()}] ${a} starting.\n`),process.stderr.write(`[command] ${e} ${t.join(" ")}\n`);const r=u.spawn(e,t,{cwd:process.cwd(),stdio:"inherit",shell:!0});r.on("error",(e=>{process.stderr.write(`[${(new Date).toString()}] ${a} has errors."`),process.stderr.write(JSON.stringify(e)),i(a+" failed.")})),r.on("exit",(e=>(process.stderr.write(`[${(new Date).toString()}] ${a} Finished.\n`),e?i(a+" failed."):s(a+" Finished.")))),r.on("SIGTERM",(()=>r.kill())),r.on("SIGINT",(()=>r.kill()))}))},y=e=>new Promise((t=>setTimeout((()=>t()),e))),k=async function(e){l.isMaster&&console.log("[main] Step 3. Connect to mongoDB.");const t=e.chiConfig.mongoDB;if(!t)throw"Invalid mongoDB configurations";const s=`mongodb://${t.mongoUser}:${t.mongoPwd}@${t.mongoHost}:${t.mongoPort}/`,i=t.db_name,r=a(5619);r.Promise=global.Promise,await r.connect(s+i,{autoIndex:!1,useNewUrlParser:!0,useUnifiedTopology:!0,useFindAndModify:!1,poolSize:10}),l.isMaster&&console.log("[main] mongoDB connected.")},v=function(e,t,a){const s=f.get(e);s&&s.forEach((e=>e.emitBdpMsg&&e.emitBdpMsg(t,a)))},b=async function(e){return m?(process.stdout.write(`${e}y\n`),"y"):new Promise((t=>{let a="";const s=h.createInterface({input:process.stdin,output:process.stdout});s.on("close",(()=>t(a))),s.question(e.toString(),(e=>{a=e,s.close()}))}))};(async()=>{try{const u=await async function(){try{const u=await async function(){l.isMaster&&console.log("[main] Step 1. Reading configs");const e={encryption:{saltBits:256,algorithm:"aes-256-cbc",iterations:5},integrity:{saltBits:256,algorithm:"sha256",iterations:2},ttl:0,timestampSkewSec:60,localtimeOffsetMsec:0};let a;const i=await o.pathExists("./configs/server-config.yaml"),c=await o.pathExists("./configs/server-config-template.yaml");!i&&c&&l.isMaster&&await o.copy("./configs/server-config-template.yaml","./configs/server-config.yaml");try{a=d.load(s.readFileSync("./configs/server-config.yaml","utf8"))}catch(t){const s=await o.readJson("./configs/server-config.encrypt");if(!s)throw"No config file.";const i=await o.readFile("./configs/server-config.key");return a=await n.unseal(s.config,i.toString(),e),a}if(!a)throw"Invalid server-config.json file.";if(l.isMaster){const t=r.randomBytes(256).toString("base64"),s=await n.seal(a,t,e);await o.writeFile("./configs/server-config.key",t),await o.writeJson("./configs/server-config.encrypt",{config:s}),process.stdout.write("[Important]\n"),process.stdout.write('Please copy the files "./server-config.json" and "./server-config.key" to remote place(s).\n'),process.stdout.write('Each time you need to start the server, just copy the remote "./server-config.key" file to this folder.\n'),process.stdout.write('If you have updated version of "./server-config.json" file, just copy the updated config file to this folder.\n'),process.stdout.write('A new key "./server-config.key" will be generated for you.\n')}return a.system||(a.system={docker_path:"docker",dataFilePath:"./datasets",scriptFolder:"./scripts",uploadFolder:"./uploads",packageFolder:"./packages",taskLogFolder:"./taskLogs",fileLimits:1/0,concurrentProcNumber:3}),a.system.dataFilePath=t.resolve(__dirname,a.system.dataFilePath),a.system.scriptFolder=t.resolve(__dirname,a.system.scriptFolder),a.system.uploadFolder=t.resolve(__dirname,a.system.uploadFolder),a.system.packageFolder=t.resolve(__dirname,a.system.packageFolder),a.system.taskLogFolder=t.resolve(__dirname,a.system.taskLogFolder),a.system.fileLimits=parseFloat(a.system.fileLimits),a.system.concurrentProcNumber=parseFloat(a.system.concurrentProcNumber),a}();l.isMaster&&(await o.ensureDir(t.resolve(u.system.dataFilePath)),await o.ensureDir(t.resolve(u.system.scriptFolder)),await o.ensureDir(t.resolve(u.system.uploadFolder)),await o.ensureDir(t.resolve(u.system.packageFolder)),await o.ensureDir(t.resolve(u.system.taskLogFolder)));const h=await async function(r){let n;l.isMaster&&console.log("[main] Step 2. Create the BD-Processor server."),process.env.BDP_SYSTEM_FOLDER=t.resolve(__dirname);const d=e();if(d.use(c({contentSecurityPolicy:!1})),d.enable("trust proxy"),"https:"===new URL(r.serverConfig.site_domain).protocol){if(r.https&&r.https.credentialKey&&r.https.credentialCertificate){const e={key:s.readFileSync(r.https.credentialKey),cert:s.readFileSync(r.https.credentialCertificate)};n=i.createServer(e,d);const t=new g.Server({noServer:!0});return{chiServer:n,chiConfig:r,app:d,wss:t,helpers:{}}}if(r.certbot){l.isMaster&&console.log("[main] using greenlock-expresss to start the https service.");const e=t.join(r.certbot.certbotStore,"config.json");if(await o.ensureDir(t.dirname(e)),!await o.pathExists(e)&&l.isMaster){let t;try{const e=new URL(r.serverConfig.site_domain);t=`${e.hostname}`,e.port&&(t+=`:${e.port}`)}catch(e){throw e}await o.writeJSON(e,{defaults:{},sites:[{subject:t}]})}return new Promise(((e,s)=>{a(7693).init({cluster:!1,packageRoot:t.resolve("./"),packageAgent:`${p.name}/${p.version}`,maintainerEmail:r.serverConfig.admin_email,configDir:r.certbot.certbotStore,staging:!r.certbot.certbot_production}).ready((function(t){n=t.httpsServer(null,d),t.httpServer().listen(80,(function(t){if(t)return s(t);console.log("Listening for ACME http-01 challenges on",this.address());const a=new g.Server({noServer:!0});e({chiServer:n,chiConfig:r,app:d,wss:a,helpers:{}})}))}))}))}console.log("Invalid https configurations. Switch to http protocol.")}return{chiServer:a(8605).createServer(d),chiConfig:r,app:d,wss:new g.Server({noServer:!0}),helpers:{}}}(u);try{await k(h)}catch(e){if(console.log("No Mongo database connections."),u.mongoDB.containerName){try{console.log("Trying to start "+u.mongoDB.containerName);const e=u.system.docker_path;await w(e,["start",u.mongoDB.containerName],"try-to-start-bdp-mongo")}catch(e){if(!u.mongoDB.dockerVolumeName||"localhost"!==u.mongoDB.mongoHost&&"127.0.0.1"!==u.mongoDB.mongoHost)console.log("You can set the mongoDB.dockerVolumeName to create a mongoDB database automatically (using Docker).");else{let e=await b("No mongo database available, but you have configured both of the mongoDB.containerName and dockerVolumeName.\n=> [33mDo you want me to create one using Docker (mongo:4.4.6)? (y/N) (default: N)[0m: ");if(e=(e||"N").toLowerCase(),"y"!==e&&"yes"!==e)throw"No Mongo database available. Please check your configuration file.";const t=u.mongoDB;if(process.stdout.write(`I will create a mongoDB Docker container with the name '${t.containerName}'\n`),process.stdout.write(`The database files are stored in the docker volume named '${t.dockerVolumeName}'.\n`),process.stdout.write("Based on your configuration file, a mongoDB user will be automatically configured with the following settings.\n"),process.stdout.write(`    [30m[100m{ user: "${t.mongoUser}", pwd: "${t.mongoPwd}", roles: [{ role: "readWrite", db: "${t.db_name}" }] }[0m\n`),e=await b("=> [33mDo you accept the above settings? (y/N) (default: N)[0m: "),e=(e||"N").toLowerCase(),"y"!==e&&"yes"!==e)throw"No Mongo database available. Please check your configuration file.";console.log("Trying to initiate a new MongoDB for you."),await async function(e){if(l.isWorker)return;const t=e.chiConfig.mongoDB,a=e.chiConfig.system.docker_path,s=t.mongoUser,i=t.mongoPwd,r=t.db_name,o=t.dockerVolumeName,n=t.containerName,d=t.mongoPort,c=t.containerType;if(!o)throw"No dockerVolumeName to create the volume automatically.";try{await w(a,["volume","create",o],"create-docker-volume")}catch(e){console.log(e)}const p=`${n}-${(new Date).getTime()}-${Math.floor(1e6*Math.random())}`;await w(a,["run","-d","-v",o+":"+("windows"===c?"C:\\data\\db":"/data/db"),"--name",p,"mongo:4.4.6"],"create-a-temp-mongodb"),await y(1e4),console.log("Wait 10 sec for the docker service...");try{await w(a,["exec",p,"mongo",r,"--eval",'"db.createUser({ user: \\"'+s+'\\", pwd: \\"'+i+'\\", roles: [ { role: \\"readWrite\\", db: \\"'+r+'\\" } ] });"'],"create-db-user")}catch(e){console.log(e)}await w(a,["stop",p],"stop-the-temp-mongo"),await w(a,["rm",p],"remove-the-temp-mongo"),await w(a,["run","-d","-v",o+":"+("windows"===c?"C:\\data\\db":"/data/db"),"--restart","always","--name",n,"-p",d+":27017","mongo:4.4.2","mongod","--port",27017,"--auth"],"create-mongo-database")}(h)}}console.log("Wait 10s for the mongoDB service..."),await y(1e4),await k(h)}else console.log("You can set the mongoDB.dockerVolumeName and the mongoDB.containerName in the server-config.yaml file. Then, we will use Docker MongoDB container to create the database for you.")}return await async function(e){const s=e.chiConfig;if(s.serverConfig.accessLog){l.isMaster&&console.log("[main] Step 4. Enable access logging.");const i=e.app,r=a(8150),o=/^\/(admin|data|dataFile|user|project|result)\//,n=e=>(e>9?"":"0")+e,d=(e,t)=>{if(!e)return`access-master${null!=t?"-"+t:""}.log`;const a=e.getFullYear()+""+n(e.getMonth()+1);return`${a}/${a}${n(e.getDate())}-${n(e.getHours())}${n(e.getMinutes())}-access-master-${t}.log`},c=a(1301).createStream(d,{interval:"1d",size:"500M",path:t.resolve(s.serverConfig.accessLog)});r.token("route-api-route",(function(e){const t=o.exec(e.originalUrl);return t?t[1]:"public"})),r.token("ips",(function(e){return e.ips.join(",")})),r.token("ip",(function(e){return e.ip})),r.token("realclfdate",(function(){const e=function(e){const t=String(e);return(1===t.length?"0":"")+t},t=new Date,a=t.getDate(),s=t.getHours(),i=t.getMinutes(),r=t.getSeconds(),o=t.getFullYear();let n=t.getTimezoneOffset();const d=n>0?"-":"+";n=parseInt(Math.abs(n)/60);const c=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getUTCMonth()];return e(a)+"/"+c+"/"+o+":"+e(s)+":"+e(i)+":"+e(r)+" "+d+e(n)+"00"})),i.use(r("[:realclfdate]\t:route-api-route\t:method\t:url\t:status\t:res[content-length]\t:response-time\t:ip\t:ips\t:referrer\t:user-agent",{stream:c}))}else l.isMaster&&console.log("[main] Step 4. Disabled access logging: no setting the accessLog file path in serverConfig.");return e}(h),await async function(t){l.isMaster&&console.log("[main] Step 5. Setting middlewares."),t.helpers=await a(2743)(t);const s=t.chiConfig,i=t.app,r=a(358),o=a(8922),n=a(8371),d=a(8328),c=a(4995),p=a(4647);t.proxyStore=new p;const u=await a(8078)(t);t.helpers.setTaskRunner(u),i.use((function(e,t,a){s.serverConfig.development&&(t.header("Access-Control-Allow-Origin",s.serverConfig.devSite+(s.serverConfig.devPort?":"+s.serverConfig.devPort:"")),t.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),t.header("Access-Control-Allow-Headers","X-Requested-With, X-HTTP-Method-Override, Content-Type, Accept"),t.header("Access-Control-Allow-Credentials",!0)),a()})),i.use(c({filter:function(e,t){return!t.get("x-no-compression")&&c.filter(e,t)}})),i.use(e.urlencoded({extended:!1})),i.use(e.json()),i.use(e.raw()),i.use(r(s.serverConfig.sessionSecret));const h=s.mongoDB;return h?(t.sessionParser=n({name:"bd-processor.sid",secret:s.serverConfig.sessionSecret,store:d.create({mongoUrl:`mongodb://${h.mongoUser}:${h.mongoPwd}@${h.mongoHost}:${h.mongoPort}/${h.db_name}`}),saveUninitialized:!1,rolling:!1,resave:!0,cookie:{maxAge:s.serverConfig.cookieMaxAge||void 0,secure:0===s.serverConfig.site_domain.indexOf("https://"),sameSite:0===s.serverConfig.site_domain.indexOf("https://")?"none":"lax"}}),i.use(t.sessionParser)):console.log("No mongoDB configs, so sessions are not used. Maybe i will add 3rd party session store options."),i.use(o.initialize()),i.use(o.session()),t}(h),await function(s){const i=s.app;return l.isMaster&&console.log("[main] Step 6. Reading routing information"),i.use(e.static(t.resolve("./public"))),i.use("/account",a(3259)(s)),i.use("/admin",a(230)(s)),i.use("/project",a(1773)(s)),i.use("/result",a(2689)(s)),i.use("/data",a(5963)(s)),i.use("/dataFile",a(2545)(s)),i.use("/task",a(5702)(s)),i.use("/page",a(2133)(s)),i.use("/system",a(4325)(s)),i.get("*",((e,a)=>{a.status(200).sendFile(t.resolve("./public/index.html"))})),s}(h),function(e){l.isMaster&&console.log("[main] Step 7. Enable socket connections.");const t=e.wss,a=e.chiServer,s=e.helpers;if(!t)throw"No websocket server.";t.broadcast=function(e,a,s){const i=JSON.stringify({source:"bdp-server",kind:e,content:a});Array.isArray(s)?0===s.length?t.clients.forEach((e=>e.send(i))):s.forEach((t=>v(t,e,a))):s?v(s,e,a):t.clients.forEach((e=>e.send(i)))},t.on("connection",(function(a,i,r){if(!i.url||"/"!==i.url)return;const o=e.taskRunner;a.isAlive=!0,a.emitBdpMsg=(e,t)=>a.send(JSON.stringify({source:"bdp-server",kind:e,content:t})),a.on("pong",(()=>a.isAlive=!0)),a.on("message",(function(e){try{0===e.indexOf('{"source":"bdp-client,"kind":"')&&(JSON.parse(e).kind,a.terminate())}catch(e){}})),a.on("close",(()=>{(async()=>{t.broadcast("serverStatus",{queue:await o.getCurrentQueueNumber(),running:await o.getCurrentProcessNumber(),online:await s.getNumberOfConns()})})().catch(console.log)})),f.has(r)?f.get(r).add(a):f.set(r,new Set([a])),(async()=>{t.broadcast("serverStatus",{queue:await o.getCurrentQueueNumber(),running:await o.getCurrentProcessNumber(),online:await s.getNumberOfConns()})})().catch(console.log)})),a.on("upgrade",(function(a,s,i){a.url&&"/"===a.url&&e.sessionParser(a,{},(()=>{try{const e=a.session.passport.user.id,r=f.get(e);if(r&&r.has(s))return;t.handleUpgrade(a,s,i,(s=>t.emit("connection",s,a,e)))}catch(e){s.write("HTTP/1.1 401 Unauthorized\r\n\r\n"),s.destroy()}}))}));const i=setInterval((function(){f.forEach((function(e,t){if(!e||0===e.size)return f.delete(t);e.forEach((t=>{t.isAlive||(t.terminate(),e.delete(t))}))})),t.clients.forEach((function(e){e.isAlive=!1,e.ping((()=>{}))}))}),3e4);t.on("close",(()=>clearInterval(i)))}(h),h.chiServer.listen(u.serverConfig.port,(function(){console.log(`[main] ${u.serverConfig.title} server (${u.serverConfig.site_domain}) listening on port ${u.serverConfig.port} with the pid ${process.pid}`)})),h}catch(e){console.log("Cannot create the server due to the error(s):"),console.log(e),process.exit(1)}}();process.on("SIGTERM",(()=>{l.isMaster&&console.log("[main] Receiving stop signal SIGTERM.\n"),u.wss.clients.forEach((e=>e.send(JSON.stringify({source:"bdp-server",kind:"message",content:{code:"default",name:"Server is shutting down",type:"warning",details:"Please do not create new tasks."}})))),u.taskRunner.stopAllWithSIGINT().catch((e=>console.log(e))).finally((()=>{console.log("[main] server stopped."),process.exit(l.isMaster?1:0)})),setTimeout((()=>{console.log("[main] server stopped."),process.exit(1)}),12e5)})),process.on("SIGINT",(()=>{l.isMaster&&console.log("[main] Receiving stop signal SIGINT. Stopping server now."),u.wss.clients.forEach((e=>e.send(JSON.stringify({source:"bdp-server",kind:"message",content:{code:"default",name:"Server is shutting down",type:"warning",details:"Please do not create new tasks."}})))),(async()=>{await u.taskRunner.stopAllWithSIGINT(),u.wss.clients.forEach((e=>e.terminate()))})().catch(console.log).finally((()=>{l.isWorker?console.log(`[worker ${l.worker.id}] stopped.`):console.log("[main] server stopped."),process.exit(l.isMaster?1:0)}))})),process.on("uncaughtException",(function(e){console.log("Caught exception: "+e),console.log(e)}))}catch(e){console.log(e)}})()})();var i=exports;for(var r in s)i[r]=s[r];s.__esModule&&Object.defineProperty(i,"__esModule",{value:!0})})();
//# sourceMappingURL=bd-processor.js.map